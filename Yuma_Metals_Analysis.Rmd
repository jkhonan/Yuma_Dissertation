---
title: "Yuma_Metals_Analysis"
author: "Jenna Honan"
date: "3/18/2024"
output: html_document
---
# An Analysis of Metals in Yuma County, Arizona and their Effects on Health Outcomes
This project will consider the associations between concentration levels of metals measured in hair samples of 323 Yuma County residents in 2018 and the prevalence of negative health outcomes, including endocrine disruption, reproductive disorders, and obesity.

Note: Before running this code, Data_Clean.Rmd should be run to clean the dataset used in this analysis, Demographics.Rmd for info about participant characteristics, and Dean Billheimer's yuma-metals-20210821.Rmd should also be run for PCA and Hg imputation values.

## Merging datasets from imputed data and "All_Data"
```{r mergess}
## Required libraries
library(DataExplorer)
library(reshape2)
library(EnvStats)
library(ggplot2)
library(reshape2)
library(tidyr)
library(grid)
library(gridExtra)
library(ggpubr)
library(corrplot)
library(dplyr)

colnames(metals.allobs.log10) <- c("ID","Log_Mn55","Log_Cu65","Log_Cd111","Log_Hg202_Imp","Log_Pb208","Log_U238","Site_Extra")
Metals <- merge(All_Data, metals.allobs.log10, by="ID")
Metals <- subset(Metals, select = -c(Site_Extra))
```

## Data Descriptions
```{r desc}
#create_report(Metals) #(Remove the # when you actually want to run - takes too much processing power otherwise.)

data.melt <- melt(Metals,id.vars=c('ID','Date'), measure.vars=c('Mn55','Cu65','Cd111', 'Hg202', 'Pb208', 'U238', 'As75', 'Fe57'))

data.melt %>%
  filter(value>0) %>% 
  group_by(variable) %>%
  summarize(n=sum(!is.na(value)),
            median=median(value),
            geomean=round(geoMean(value, na.rm = T), digits = 2),
            geosd=round(geoSD(value, na.rm = T), digits = 2),
            min=min(value, na.rm = T),
            max=max(value, na.rm = T))

All_Data %>% 
  filter(ID!="Y1008" & ID!="Y1015" & ID!="R1048" & ID!="R1083" & ID!="C1050" & ID!="C1059" & ID!="C1104") %>% 
  summarise(total=sum(!is.na(Mn55) | !is.na(Cu65) | !is.na(Cd111) | !is.na(Hg202) | !is.na(Pb208) | !is.na(U238) | !is.na(As75) | !is.na(Fe57)))

All_Data %>% 
  filter(ID!="Y1008" & ID!="Y1015" & ID!="R1048" & ID!="R1083" & ID!="C1050" & ID!="C1059" & ID!="C1104") %>% 
  summarise(total=sum(!is.na(Mn55) | !is.na(Cu65) | !is.na(Cd111) | !is.na(Hg202) | !is.na(Pb208) | !is.na(U238)))

```

## Data Visualization - Exploratory


### "Melting" Metals Together :)
```{r melting_data}
data.melt <- melt(Metals,id.vars=c('ID','Date'), measure.vars=c('Mn55','Cu65','Cd111', 'Hg202', 'Pb208', 'U238'))
ggplot(data.melt) +
  geom_boxplot(aes(y=log10(value), fill=variable))+
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
        panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"))+
  ylab("log10 Concentration (ug/g)")+
  labs(fill='Metals')

ggplot(data=data.melt, aes(y=log10(value), x=variable))+
  geom_jitter(aes(color=variable))

ggplot(data=data.melt, aes(y=log10(value), x=variable))+
  geom_violin(aes(fill=variable))+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        legend.position = "none",
        text = element_text(size=15))+
  xlab("")+
  ylab("Log10 Concentrations")

#Look up reference values for hair. WHO, NHANES, etc.


#Labeling Outliers
outlier_tmp <- lapply(unique(data.melt$variable),# Get outlier information
                      function (g) {
                        stats <- quantile(data.melt$value[data.melt$variable == g], na.rm = TRUE) # Quantiles
                        iqr   <- diff(stats[c(2, 4)]) # Inter quartile range
                        out   <- data.melt$value[data.melt$variable == g] < (stats[2L] - 1.5 * iqr) | data.melt$value[data.melt$variable == g] > (stats[4L] + 1.5 * iqr)  # Outlier identifier
                        outlier_tmp <- (1:nrow(data.melt))[data.melt$variable == g][out]                                                             # Outlier position
                      })
names(outlier_tmp) <- levels(data.melt$variable)
outlier_data <- data.frame(label = data.melt$ID[unlist(outlier_tmp)],                                                                                 # Transform outlier information into data.frame
                           value = data.melt$value[unlist(outlier_tmp)],
                           group = substr(names(unlist(outlier_tmp)), 1, 2))
outlier_data

ggplot(data.melt) +
  geom_boxplot(aes(y=log10(value), x=substr(variable, 1,2), fill=variable))+
  theme(axis.ticks.x = element_blank(),
        panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"))+
  geom_text(data = outlier_data, 
            aes(x = group, y = log10(value), label = label), 
            hjust = -.3)+
  ylab("log10 Concentration (ug/g)")+
  xlab("")+
  labs(fill='Metals')

outlier_data <- subset(outlier_data, !is.na(outlier_data$value))

outlier_data %>% 
  arrange(value) %>% 
  group_by(group, label) %>% 
  summarise(n=length(label))


#Looking at only the highest...
#Labeling Outliers
outlier_tmp2 <- lapply(unique(data.melt$variable),# Get outlier information
                      function (g) {
                        stats <- quantile(data.melt$value[data.melt$variable == g], na.rm = TRUE) # Quantiles
                        iqr   <- diff(stats[c(2, 4)]) # Inter quartile range
                        out   <- data.melt$value[data.melt$variable == g] < (stats[2L] - 15 * iqr) | data.melt$value[data.melt$variable == g] > (stats[4L] + 15 * iqr)  # Outlier identifier
                        outlier_tmp <- (1:nrow(data.melt))[data.melt$variable == g][out]                                                             # Outlier position
                      })
names(outlier_tmp2) <- levels(data.melt$variable)
outlier_data2 <- data.frame(label = data.melt$ID[unlist(outlier_tmp2)],                                                                                 # Transform outlier information into data.frame
                           value = data.melt$value[unlist(outlier_tmp2)],
                           group = substr(names(unlist(outlier_tmp2)), 1, 2))
outlier_data2

outlier_data2 <- subset(outlier_data2, !is.na(outlier_data2$value))

ggplot(data.melt) +
  geom_boxplot(aes(y=log10(value), x=substr(variable, 1,2), fill=variable))+
  theme(axis.ticks.x = element_blank(),
        panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"))+
  geom_text(data = outlier_data2, 
            aes(x = group, y = log10(value), label = label), 
            hjust = -.3)+
  ylab("log10 Concentration (ug/g)")+
  xlab("")+
  labs(fill='Metals')

outlier_data2 %>% 
  group_by(label) %>% 
  summarise(number_of_metals_with_outliers=length(label))

###TOP 3 METAL CONCENTRATIONS AND IDS FOR EACH METAL
##Cd
#Y1075: 3.100
#R1118: 2.870
#R1003: 1.410

##Cu
#R1116: 1704.130
#R1115: 1088.650
#R1014: 981.290

##Hg
#R1052: 60.175
#R1012: 52.476
#R1111: 17.158

##Mn
#R1036: 103.320
#R1118: 65.240
#R1014: 56.410

##Pb
#R1115: 76.450
#R1118: 69.000
#C1005: 20.030

##U
#Y1064: 21.080
#Y1092: 9.240
#Y1013: 4.570

#These are not the same participants over and over again with high metals, so I do not see any obvious patterns within individuals.

generate_plot <- function(df, var_name) {
  median_value <- round(median(df$value, na.rm = TRUE), digits = 2)
  p <- ggplot(df, aes(y = log10(value), x = variable)) +
    geom_violin(aes(fill = variable)) +
    geom_hline(yintercept = log10(median_value), color = "blue", linetype = "dashed") +
    theme_minimal() +
    labs(title = paste("Median:", median_value), subtitle = var_name)
  
  return(p)
}

variables <- unique(data.melt$variable)

plots_list <- lapply(variables, function(var) {
  df_subset <- data.melt[data.melt$variable == var,]
  generate_plot(df_subset, var)
})

combined_plot <- do.call(grid.arrange, c(plots_list, ncol = 2))
print(combined_plot)

All_Data %>% 
    ggplot(aes(x=log10(Cortisol))) + geom_density() +
            ggtitle("Distribution of Cortisol \nAfter Log10 Transform")+
  theme(panel.background = element_blank(),
        text=element_text(size=24))

Hist_Cortisol_Raw <- All_Data %>% 
    ggplot(aes(x=as.numeric(Cortisol))) + geom_density() +
            ggtitle("Cortisol (ng/mL)")+
  xlab("")+
  ylab("")+
  theme(panel.background = element_blank(),
        text=element_text(size=8.4))

Hist_Creatinine_Raw <- All_Data %>% 
    ggplot(aes(x=as.numeric(Result_C_mg_dL))) + geom_density() +
            ggtitle("Creatinine (mg/dL)")+
  xlab("")+
  theme(panel.background = element_blank(),
        text=element_text(size=8.4))

ggarrange(Hist_Cd_Raw, Hist_Cu_Raw, Hist_Pb_Raw, Hist_Mn_Raw, Hist_Hg_Raw, Hist_U_Raw, Hist_Creatinine_Raw, Hist_Cortisol_Raw)
```

### Concentrations by Date
```{r envt_samples_by_collectiondate}
ggplot(data.melt, aes(y=log10(value), x=Date, color=variable))+
  geom_point()+
  geom_smooth(se=F)+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.text.x=element_text(angle=60, hjust=1),
        axis.line = element_line(color="#000000"))+
  scale_x_date(date_breaks = "1 month", date_labels =  "%b")+
  ylab("Ln Concentration (ug/g)")+
  xlab("Date of Sample Collection, 2018")+
  labs(color='Metals')

#Relevant paper: https://www.sciencedirect.com/science/article/pii/S1878535212000263 
```

### Tables and Observations for Each Metal
```{r observations_envt_samples}
data.melt %>% 
  group_by(variable) %>% 
  summarize(number_NAs=sum(is.na(value)))

#Seeing if there are negative concentrations
data.melt %>% 
  group_by(variable) %>% 
  summarize(n_negative=sum(value<0, na.rm = T))
#There are twelve negative concentration levels of arsenic. This will mess with taking the lognormal to transform.
#Need to look up what to do when concentrations in a dataset are negative. Do you ignore? Do you replace with DL/sqrt(2)? Do you leave them as is and it's just tough luck?
#For now I will simply ignore!

#Making a table re: metal concentration values
data.melt$value <- as.numeric(data.melt$value)
knitr::kable(data.melt %>%
               filter(value>0) %>% #This is ignoring negative concentrations in dataset, of which As75 has twelve.
               group_by(variable) %>% 
               summarize(n=sum(!is.na(value)),
                         geomean=round(geoMean(value, na.rm = T), digits = 2),
                         geosd=round(geoSD(value, na.rm = T), digits = 2)))

#create_report(data.melt) (Only run if you need to.)

Metals %>% 
  filter(!is.na(Mn55)|!is.na(Cu65)|!is.na(Cd111)|!is.na(Hg202)|!is.na(Pb206)|!is.na(Pb207)|!is.na(Pb208)|!is.na(U238)) %>% 
  summarize(n=length(unique(ID)))


#Doing the same but with imputed Hg:
data.melt2 <- melt(Metals,id.vars=c('ID','Date'), measure.vars=c('Log_Mn55','Log_Cu65','Log_Cd111', 'Log_Hg202_Imp', 'Log_Pb208', 'Log_U238'))


data.melt2 %>% 
  group_by(variable) %>% 
  summarize(number_NAs=sum(is.na(value)))

#Making a table re: metal concentration values
data.melt2$value <- as.numeric(data.melt2$value)
knitr::kable(data.melt2 %>%
               group_by(variable) %>% 
               summarize(n=length(value),
                         median=round(median(value, na.rm = T), digits = 2),
                         mean_log=round(mean(value, na.rm = T), digits = 2),
                         sd_log=round(sd(value, na.rm = T), digits = 2)))

data.melt3 <- data.melt2 %>%
  group_by(variable) %>% 
  summarize(n=length(value),
            median=round(median(value, na.rm = T), digits = 2),
            mean_log=round(mean(value, na.rm = T), digits = 2),
            sd_log=round(sd(value, na.rm = T), digits = 2))

ggplot(data=data.melt2, aes(x=value))+
  geom_histogram(aes(fill=variable), alpha=0.5)+
  geom_vline(data=data.melt3, aes(xintercept=median, color=variable))+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 14))+
  labs(fill="Variable and Median Value",
       color="Variable and Median Value")+
  ylab("Frequency")+
  xlab("Log Concentration")

ggplot(data=data.melt2, aes(x=value))+
  geom_density(aes(color=variable), linewidth=2)+
  geom_vline(data=data.melt3, aes(xintercept=median, color=variable), linewidth=1.1)+
  annotate("text", x=data.melt3$median, y=-0.2, label=data.melt3$median, angle=90, color="black", vjust=-0.1)+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 14),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())+
  labs(color="Distribution and Median Value")+
  scale_color_discrete(labels = c("Manganese",
                                "Copper",
                                "Cadmium",
                                "Mercury",
                                "Lead",
                                "Uranium"))+ 
  ylab("Frequency")+
  xlab("Log Concentration")

data.melt2$variable <- factor(data.melt2$variable, levels = c("Log_Cd111", "Log_Cu65", "Log_Hg202_Imp", "Log_Mn55", "Log_Pb208", "Log_U238"))

ggplot(data=data.melt2, aes(x=value)) +
    geom_density(aes(color=variable), linewidth=2) +
    geom_vline(data=data.melt3, aes(xintercept=median, color=variable), linewidth=1.1) +
    facet_wrap(~variable, labeller = as_labeller(c(Log_Cd111 = "Cd", Log_Mn55 = "Mn", Log_Cu65 = "Cu", Log_Hg202_Imp = "Hg", Log_Pb208 = "Pb", Log_U238 = "U"))) +
    ylab("Frequency") +
    xlab("Log Concentration and Median") +
    theme(panel.background = element_rect(fill="#ffffff"),
          axis.line = element_line(color="#000000"),
          text = element_text(size = 14),
          legend.position = "none")

ggplot(data=data.melt, aes(y=log10(value), x=variable))+
  geom_violin(aes(fill=variable))+
  geom_vline(data=data.melt3, aes(xintercept=median, color=variable), linewidth=1.1) +
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        legend.position = "none",
        text = element_text(size=15))+
  xlab("")+
  ylab("Log10 Concentrations")
```

### Distribution of Metals Data
```{r metal_distributions}

hist(Metals$Mn55)

hist(Metals$Cu65)

hist(Metals$Cd111)

hist(Metals$Hg202)

hist(Metals$Pb208)

hist(Metals$U238)

hist(Metals$As75)

hist(Metals$Fe57)
#If negative values are excluded, lognormal is appropriate. However, because of the small sample size and the seemingly incomplete or inaccurate lab results, we will exclude As and Fe from this study.

Metals %>% 
  dplyr::select(Mn55, Cu65, Cd111, Hg202, Pb208, U238, Site, ID) %>% 
  pivot_longer(-c(ID, Site), names_to="Metal", values_to="Concentration") %>%
  ggplot(aes(x=Concentration)) + 
  geom_density() +
  scale_x_log10() + 
  facet_wrap(~ Metal) +
  ggtitle("Distributions of Metals Concentrations")+
  ylab("Density")+
  xlab("Log-Transformed Concentration")+
  theme(text = element_text(size = 12))

Metals %>% 
  dplyr::select(Log_Mn55, Log_Cu65, Log_Cd111, Log_Hg202_Imp, Log_Pb208, Log_U238, Site, ID) %>% 
  pivot_longer(-c(ID, Site), names_to="Metals", values_to="Log_Concentration") %>%
  ggplot(aes(x=Log_Concentration)) + 
  geom_density() +
  facet_wrap(~ Metals) +
  ggtitle("Distributions of Metals Concentrations")+
  ylab("Density")+
  xlab("Log-Transformed Concentration")+
  theme(text = element_text(size = 14))

# New facet label names for supp variable
site.labs <- c("1" = "CSF", "2" = "RCBH", "3" = "YRMC")
gender.labs <- c("1" = "Male", "2" = "Female")
farmer.labs <- c("1" = "Farmer in Last Year", "2" = "Non-Farmer")

Metals %>% 
  dplyr::select(Mn55, Cu65, Cd111, Hg202, Pb208, U238, Site, ID) %>% 
  pivot_longer(-c(ID, Site), names_to="Metal", values_to="Concentration") %>%
  ggplot(aes(y=Concentration, fill=Metal)) + 
  geom_boxplot() +
  facet_wrap(~ Site, labeller = labeller(Site = site.labs)) +
  ggtitle("Metals Concentrations by Site")+
  ylab("Concentrations")+
  xlab("")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 15),
        panel.spacing = unit(0.75, "cm"))

tiff("Site_Metals.tiff", width = 780, height = 450)
Metals %>% 
  dplyr::select(Log_Mn55, Log_Cu65, Log_Hg202_Imp, Log_Pb208, Log_U238, Site, ID) %>% 
  pivot_longer(-c(ID, Site), names_to="Metals", values_to="Log_Concentration") %>%
  ggplot(aes(y=Log_Concentration, fill=Metals)) + 
  geom_boxplot() +
  scale_fill_discrete(labels = c("Copper",
                                "Mercury",
                                "Manganese",
                                "Lead",
                                "Uranium"))+ 
  facet_wrap(~ Site, labeller = labeller(Site = site.labs)) +
  ggtitle("Metals Concentrations by Site")+
  ylab("log10 Concentrations")+
  xlab("")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 20),
        panel.spacing = unit(0.75, "cm"))
dev.off()

Metals %>% 
  group_by(Site) %>% 
  summarize(n=sum(!is.na(Site)))


Metals %>% 
  filter(!is.na(Farmer)) %>% 
  dplyr::select(Log_Mn55, Log_Cu65, Log_Cd111, Log_Hg202_Imp, Log_Pb208, Log_U238, Farmer, ID) %>% 
  pivot_longer(-c(ID, Farmer), names_to="Metals", values_to="Log_Concentration") %>%
  ggplot(aes(y=Log_Concentration, fill=Metals)) + 
  geom_boxplot() +
  facet_wrap(~ Farmer, labeller = labeller(Farmer = farmer.labs)) +
  ggtitle("Metals Concentrations by Farmworker Status")+
  ylab("log10 Concentrations")+
  xlab("")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 15),
        panel.spacing = unit(0.75, "cm"))

tiff("Farmworker_Metals.tiff", width = 750, height = 450)
Metals %>% 
  filter(!is.na(Farmer)) %>% 
  dplyr::select(Log_Mn55, Log_Cu65, Log_Hg202_Imp, Log_Pb208, Log_U238, Farmer, ID) %>% 
  pivot_longer(-c(ID, Farmer), names_to="Metals", values_to="Log_Concentration") %>%
  ggplot(aes(y=Log_Concentration, x=Metals, fill=as.factor(Farmer)))+ 
  geom_boxplot()+
  scale_fill_manual(name = "Farmworker, Rancher, or \nAgricultural Worker \nin Last Year",
                    values = c("1" = "deepskyblue3", "2" = "coral3"),
                    labels = c("1" = "Yes", "2" = "No")) +
  scale_x_discrete(labels = c("Log_Mn55" = "Mn", "Log_Cu65" = "Cu", "Log_Hg202_Imp" = "Hg", "Log_Pb208" = "Pb", "Log_U238" = "U"))+
  ggtitle("")+
  ylab("log10 Concentration")+
  xlab("")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 20),
        panel.spacing = unit(0.75, "cm"))
dev.off()


Metals %>% 
  filter(Pesticides==1|Pesticides==2|Pesticides==3) %>% 
  dplyr::select(Log_Mn55, Log_Cu65, Log_Cd111, Log_Hg202_Imp, Log_Pb208, Log_U238, Pesticides, ID) %>% 
  pivot_longer(-c(ID, Pesticides), names_to="Metals", values_to="Log_Concentration") %>%
  ggplot(aes(y=Log_Concentration, x=Metals, fill=as.factor(Pesticides)))+ 
  geom_boxplot()+
  scale_fill_discrete(name = "Pesticide Use",
                      labels = c("1" = "Yes", "2" = "No", "3" = "Don't know"))+
  scale_x_discrete(labels = c("Log_Mn55" = "Mn", "Log_Cu65" = "Cu", "Log_Cd111" = "Cd", "Log_Hg202_Imp" = "Hg", "Log_Pb208" = "Pb", "Log_U238" = "U"))+
  ggtitle("Metals Concentrations by Pesticide Use in the Workplace")+
  ylab("log10 Concentrations")+
  xlab("")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 15),
        panel.spacing = unit(0.75, "cm"))

tiff("Pesticides_Metals.tiff", width = 650, height = 450)
Metals %>% 
  filter(Pesticides==1|Pesticides==2) %>% 
  dplyr::select(Log_Mn55, Log_Cu65, Log_Hg202_Imp, Log_Pb208, Log_U238, Pesticides, ID) %>% 
  pivot_longer(-c(ID, Pesticides), names_to="Metals", values_to="Log_Concentration") %>%
  ggplot(aes(y=Log_Concentration, x=Metals, fill=as.factor(Pesticides)))+ 
  geom_boxplot() +
  scale_fill_manual(name = "Pesticide Use",
                    values = c("1" = "deepskyblue3", "2" = "coral3"),
                    labels = c("1" = "Yes", "2" = "No")) +
  scale_x_discrete(labels = c("Log_Mn55" = "Mn", "Log_Cu65" = "Cu", "Log_Hg202_Imp" = "Hg", "Log_Pb208" = "Pb", "Log_U238" = "U")) +
  ggtitle("Metals Concentrations by Pesticide Use in the Workplace") +
  ylab("log10 Concentrations") +
  xlab("") +
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 20),
        panel.spacing = unit(0.75, "cm"))
dev.off()

sum(Metals$Pesticides==1, na.rm = T)
sum(Metals$Pesticides==2, na.rm = T)
sum(Metals$Pesticides==3, na.rm = T)


Metal_Conc_by_Farmer <- Metals %>% 
  group_by(Farmer) %>% 
  summarise(n=length(Farmer),
            Cadmium_geomean=geoMean(Cd111, na.rm=T),
            Cadmium_geoSD=geoSD(Cd111, na.rm=T),
            Copper_geomean=geoMean(Cu65, na.rm=T),
            Copper_geoSD=geoSD(Cu65, na.rm=T),
            Mercury_geomean=geoMean(Hg202, na.rm=T),
            Mercury_geoSD=geoSD(Hg202, na.rm=T),
            Manganese_geomean=geoMean(Mn55, na.rm=T),
            Manganese_geoSD=geoSD(Mn55, na.rm=T),
            Lead_geomean=geoMean(Pb208, na.rm=T),
            Lead_geoSD=geoSD(Pb208, na.rm=T),
            Uranium_geomean=geoMean(U238, na.rm=T),
            Uranium_geoSD=geoSD(U238, na.rm=T))

t.test(log10(Cd111)~Farmer, data=Metals)
t.test(log10(Cu65)~Farmer, data=Metals)
t.test(log10(Mn55)~Farmer, data=Metals)
t.test(log10(Hg202)~Farmer, data=Metals)
t.test(log10(Pb208)~Farmer, data=Metals)
t.test(log10(U238)~Farmer, data=Metals)

Metal_Conc_by_Pest_Use <- Metals %>% 
  group_by(Pesticides) %>% 
  summarise(n=length(Pesticides),
            Cadmium_geomean=geoMean(Cd111, na.rm=T),
            Cadmium_geoSD=geoSD(Cd111, na.rm=T),
            Copper_geomean=geoMean(Cu65, na.rm=T),
            Copper_geoSD=geoSD(Cu65, na.rm=T),
            Mercury_geomean=geoMean(Hg202, na.rm=T),
            Mercury_geoSD=geoSD(Hg202, na.rm=T),
            Manganese_geomean=geoMean(Mn55, na.rm=T),
            Manganese_geoSD=geoSD(Mn55, na.rm=T),
            Lead_geomean=geoMean(Pb208, na.rm=T),
            Lead_geoSD=geoSD(Pb208, na.rm=T),
            Uranium_geomean=geoMean(U238, na.rm=T),
            Uranium_geoSD=geoSD(U238, na.rm=T))

t.test(log10(Cd111)~Pesticides, data=subset(Metals, Metals$Pesticides==1|Metals$Pesticides==2))
t.test(log10(Cu65)~Pesticides, data=subset(Metals, Metals$Pesticides==1|Metals$Pesticides==2))
t.test(log10(Mn55)~Pesticides, data=subset(Metals, Metals$Pesticides==1|Metals$Pesticides==2))
t.test(log10(Hg202)~Pesticides, data=subset(Metals, Metals$Pesticides==1|Metals$Pesticides==2))
t.test(log10(Pb208)~Pesticides, data=subset(Metals, Metals$Pesticides==1|Metals$Pesticides==2))
t.test(log10(U238)~Pesticides, data=subset(Metals, Metals$Pesticides==1|Metals$Pesticides==2))

Metal_Conc_by_Site <- Metals %>% 
  group_by(Site) %>% 
  summarise(n=length(Site),
            Cadmium_geomean=geoMean(Cd111, na.rm=T),
            Cadmium_geoSD=geoSD(Cd111, na.rm=T),
            Copper_geomean=geoMean(Cu65, na.rm=T),
            Copper_geoSD=geoSD(Cu65, na.rm=T),
            Mercury_geomean=geoMean(Hg202, na.rm=T),
            Mercury_geoSD=geoSD(Hg202, na.rm=T),
            Manganese_geomean=geoMean(Mn55, na.rm=T),
            Manganese_geoSD=geoSD(Mn55, na.rm=T),
            Lead_geomean=geoMean(Pb208, na.rm=T),
            Lead_geoSD=geoSD(Pb208, na.rm=T),
            Uranium_geomean=geoMean(U238, na.rm=T),
            Uranium_geoSD=geoSD(U238, na.rm=T))

summary(aov(log10(Cd111)~Site, data=Metals))
summary(aov(log10(Cu65)~Site, data=Metals))
summary(aov(log10(Mn55)~Site, data=Metals))
summary(aov(log10(Hg202)~Site, data=Metals))
summary(aov(log10(Pb208)~Site, data=Metals))
summary(aov(log10(U238)~Site, data=Metals))

#pairwise.t.test(log10(Metals$Cu65), Metals$Site, p.adjust.method="bonferroni")
#pairwise.t.test(log10(Metals$Mn55), Metals$Site, p.adjust.method="bonferroni")
#pairwise.t.test(log10(Metals$Pb208), Metals$Site, p.adjust.method="bonferroni")
#pairwise.t.test(log10(Metals$U238), Metals$Site, p.adjust.method="bonferroni")

TukeyHSD(aov(log10(Cu65)~factor(Site), data=Metals))
TukeyHSD(aov(log10(Mn55)~factor(Site), data=Metals))
TukeyHSD(aov(log10(Pb208)~factor(Site), data=Metals))
TukeyHSD(aov(log10(U238)~factor(Site), data=Metals))
```

### Correlation of Metals
```{r corr}
Metals_Correlations <- cor(Metals[, c("Log_Mn55", "Log_Cu65", "Log_Hg202_Imp", "Log_Pb208", "Log_U238")], use="complete.obs")

corrplot(Metals_Correlations)
colnames(Metals_Correlations) <- c("Log10 Mn", "Log10 Cu", "Log10 Hg", "Log10 Pb", "Log10 U")
rownames(Metals_Correlations) <- c("Log10 Mn", "Log10 Cu", "Log10 Hg", "Log10 Pb", "Log10 U")

png("Metals_Corrplot.png", width=1400, height=800, res=300)
corrplot(Metals_Correlations,
         method = "circle",
         type = "upper",
         order = "hclust",
         col = colorRampPalette(c("#00AFBB", "#E7B800", "#FC4E07"))(100),
         addCoef.col = "black",
         tl.cex = 0.85,
         addCoef.row = FALSE)
dev.off()

round(Metals_Correlations, 2)
```

### Plotting Hormone Levels Against Metal Concentrations
```{r metals_hormones}
#This may be irrelevant, but doing it anyway just to see...
#I can always do this again but with the results of the PCA too

#Cortisol (ng/mL)
Mn_Cortisol <- ggplot(Metals, aes(x=log10(Mn55), y=Cortisol))+geom_point()
Cu_Cortisol <- ggplot(Metals, aes(x=log10(Cu65), y=Cortisol))+geom_point()
Cd_Cortisol <- ggplot(Metals, aes(x=log10(Cd111), y=Cortisol))+geom_point()
Hg_Cortisol <- ggplot(Metals, aes(x=log10(Hg202), y=Cortisol))+geom_point()
Pb_Cortisol <- ggplot(Metals, aes(x=log10(Pb208), y=Cortisol))+geom_point()
U_Cortisol <- ggplot(Metals, aes(x=log10(U238), y=Cortisol))+geom_point()

grid.arrange(Mn_Cortisol, Cu_Cortisol, Cd_Cortisol, Hg_Cortisol, Pb_Cortisol, U_Cortisol)

#By Site
Mn_Cortisol_legend <- ggplot(Metals, aes(x=log10(Mn55), y=log(Cortisol), color=as.factor(Site))) +
  geom_point() +
  scale_color_discrete(name = "Recruitment Site",
                      labels = c("1" = "CSF", "2" = "RCBH", "3" = "YRMC")) +
  theme(legend.position="right")

get_legend <- function(myggplot){
    tmp <- ggplot_gtable(ggplot_build(myggplot))
    leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
    legend <- tmp$grobs[[leg]]
    return(legend)
}

legend <- get_legend(Mn_Cortisol_legend)

Mn_Cortisol <- ggplot(Metals, aes(x=log10(Mn55), y=log(Cortisol)))+geom_point(aes(color=as.factor(Site), alpha=0.5))+theme(legend.position="none", panel.background = element_rect(fill="#ffffff"))+ylab("")
Cu_Cortisol <- ggplot(Metals, aes(x=log10(Cu65), y=log(Cortisol)))+geom_point(aes(color=as.factor(Site), alpha=0.5))+theme(legend.position="none", panel.background = element_rect(fill="#ffffff"))+ylab("")
Cd_Cortisol <- ggplot(Metals, aes(x=log10(Cd111), y=log(Cortisol)))+geom_point(aes(color=as.factor(Site), alpha=0.5))+theme(legend.position="none", panel.background = element_rect(fill="#ffffff"))+ylab("")
Hg_Cortisol <- ggplot(Metals, aes(x=log10(Hg202), y=log(Cortisol)))+geom_point(aes(color=as.factor(Site), alpha=0.5))+theme(legend.position="none", panel.background = element_rect(fill="#ffffff"))+ylab("")
Pb_Cortisol <- ggplot(Metals, aes(x=log10(Pb208), y=log(Cortisol)))+geom_point(aes(color=as.factor(Site), alpha=0.5))+theme(legend.position="none", panel.background = element_rect(fill="#ffffff"))+ylab("")
U_Cortisol <- ggplot(Metals, aes(x=log10(U238), y=log(Cortisol)))+geom_point(aes(color=as.factor(Site), alpha=0.5))+theme(legend.position="none", panel.background = element_rect(fill="#ffffff"))+ylab("")

y_label <- textGrob("Log [Cortisol (ng/mL)]", gp=gpar(fontsize=14, fontface="bold"), rot=90)

grid.arrange(Mn_Cortisol, Cu_Cortisol, Cd_Cortisol, Hg_Cortisol, Pb_Cortisol, U_Cortisol, ncol=3, right=legend, left=y_label)

#TSH (uIU/ML)

Mn_TSH_legend <- ggplot(Metals, aes(x=log10(Mn55), y=log(TSH), color=as.factor(Site))) +
  geom_point() +
  scale_color_discrete(name = "Recruitment Site",
                      labels = c("1" = "CSF", "2" = "RCBH", "3" = "YRMC")) +
  theme(legend.position="right")

get_legend <- function(myggplot){
    tmp <- ggplot_gtable(ggplot_build(myggplot))
    leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
    legend <- tmp$grobs[[leg]]
    return(legend)
}

legend <- get_legend(Mn_TSH_legend)

Mn_TSH <- ggplot(Metals, aes(x=log10(Mn55), y=log(TSH)))+geom_point(aes(color=as.factor(Site), alpha=0.5))+theme(legend.position="none", panel.background = element_rect(fill="#ffffff"))+ylab("")
Cu_TSH <- ggplot(Metals, aes(x=log10(Cu65), y=log(TSH)))+geom_point(aes(color=as.factor(Site), alpha=0.5))+theme(legend.position="none", panel.background = element_rect(fill="#ffffff"))+ylab("")
Cd_TSH <- ggplot(Metals, aes(x=log10(Cd111), y=log(TSH)))+geom_point(aes(color=as.factor(Site), alpha=0.5))+theme(legend.position="none", panel.background = element_rect(fill="#ffffff"))+ylab("")
Hg_TSH <- ggplot(Metals, aes(x=log10(Hg202), y=log(TSH)))+geom_point(aes(color=as.factor(Site), alpha=0.5))+theme(legend.position="none", panel.background = element_rect(fill="#ffffff"))+ylab("")
Pb_TSH <- ggplot(Metals, aes(x=log10(Pb208), y=log(TSH)))+geom_point(aes(color=as.factor(Site), alpha=0.5))+theme(legend.position="none", panel.background = element_rect(fill="#ffffff"))+ylab("")
U_TSH <- ggplot(Metals, aes(x=log10(U238), y=log(TSH)))+geom_point(aes(color=as.factor(Site), alpha=0.5))+theme(legend.position="none", panel.background = element_rect(fill="#ffffff"))+ylab("")
As_TSH <- ggplot(Metals, aes(x=log10(As75), y=log(TSH)))+geom_point(aes(color=as.factor(Site), alpha=0.5))+theme(legend.position="none", panel.background = element_rect(fill="#ffffff"))+ylab("")
Fe_TSH <- ggplot(Metals, aes(x=log10(Fe57), y=log(TSH)))+geom_point(aes(color=as.factor(Site), alpha=0.5))+theme(legend.position="none", panel.background = element_rect(fill="#ffffff"))+ylab("")

y_label <- textGrob("Log [TSH (uIU/ML)]", gp=gpar(fontsize=14, fontface="bold"), rot=90)

grid.arrange(Mn_TSH, Cu_TSH, Cd_TSH, Hg_TSH, Pb_TSH, U_TSH, ncol=3, right=legend, left=y_label)



#Free T4 (pg/mL)
Mn_fT4_legend <- ggplot(Metals, aes(x=log10(Mn55), y=log(fT4), color=as.factor(Site))) +
  geom_point() +
  scale_color_discrete(name = "Recruitment Site",
                      labels = c("1" = "CSF", "2" = "RCBH", "3" = "YRMC")) +
  theme(legend.position="right")

get_legend <- function(myggplot){
    tmp <- ggplot_gtable(ggplot_build(myggplot))
    leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
    legend <- tmp$grobs[[leg]]
    return(legend)
}

legend <- get_legend(Mn_fT4_legend)

Mn_fT4 <- ggplot(Metals, aes(x=log10(Mn55), y=log(fT4)))+geom_point(aes(color=as.factor(Site), alpha=0.5))+theme(legend.position="none", panel.background = element_rect(fill="#ffffff"))+ylab("")
Cu_fT4 <- ggplot(Metals, aes(x=log10(Cu65), y=log(fT4)))+geom_point(aes(color=as.factor(Site), alpha=0.5))+theme(legend.position="none", panel.background = element_rect(fill="#ffffff"))+ylab("")
Cd_fT4 <- ggplot(Metals, aes(x=log10(Cd111), y=log(fT4)))+geom_point(aes(color=as.factor(Site), alpha=0.5))+theme(legend.position="none", panel.background = element_rect(fill="#ffffff"))+ylab("")
Hg_fT4 <- ggplot(Metals, aes(x=log10(Hg202), y=log(fT4)))+geom_point(aes(color=as.factor(Site), alpha=0.5))+theme(legend.position="none", panel.background = element_rect(fill="#ffffff"))+ylab("")
Pb_fT4 <- ggplot(Metals, aes(x=log10(Pb208), y=log(fT4)))+geom_point(aes(color=as.factor(Site), alpha=0.5))+theme(legend.position="none", panel.background = element_rect(fill="#ffffff"))+ylab("")
U_fT4 <- ggplot(Metals, aes(x=log10(U238), y=log(fT4)))+geom_point(aes(color=as.factor(Site), alpha=0.5))+theme(legend.position="none", panel.background = element_rect(fill="#ffffff"))+ylab("")
As_fT4 <- ggplot(Metals, aes(x=log10(As75), y=log(fT4)))+geom_point(aes(color=as.factor(Site), alpha=0.5))+theme(legend.position="none", panel.background = element_rect(fill="#ffffff"))+ylab("")
Fe_fT4 <- ggplot(Metals, aes(x=log10(Fe57), y=log(fT4)))+geom_point(aes(color=as.factor(Site), alpha=0.5))+theme(legend.position="none", panel.background = element_rect(fill="#ffffff"))+ylab("")

y_label <- textGrob("Log [Free T4 (pg/mL)]", gp=gpar(fontsize=14, fontface="bold"), rot=90)

grid.arrange(Mn_fT4, Cu_fT4, Cd_fT4, Hg_fT4, Pb_fT4, U_fT4, ncol=3, right=legend, left=y_label)

#Total T4 (ng/mL)

#Free T3 (pg/mL)

#Total T3 (ng/mL)
```

### Analysis of Measured BMI against Individual Metals
```{r measured_bmi_metals}

Mn55_BMI_measured <- Metals[,c("ID", "Site", "Gender", "bmi", "age", "Log_Mn55")]
Cu65_BMI_measured <- Metals[,c("ID", "Site", "Gender", "bmi", "age", "Log_Cu65")]
Cd111_BMI_measured <- Metals[,c("ID", "Site", "Gender", "bmi", "age", "Log_Cd111")]
Hg202_BMI_measured <- Metals[,c("ID", "Site", "Gender", "bmi", "age", "Log_Hg202_Imp")]
Pb208_BMI_measured <- Metals[,c("ID", "Site", "Gender", "bmi", "age", "Log_Pb208")]
U238_BMI_measured <- Metals[,c("ID", "Site", "Gender", "bmi", "age", "Log_U238")]

colnames(Mn55_BMI_measured) <- c("ID", "Site", "Gender", "bmi", "age", "Log_Concentration")
Mn55_BMI_measured$Metal <- rep(c("Mn55"), length(Mn55_BMI_measured$age))
colnames(Cu65_BMI_measured) <- c("ID", "Site", "Gender", "bmi", "age", "Log_Concentration")
Cu65_BMI_measured$Metal <- rep(c("Cu65"), length(Cu65_BMI_measured$age))
colnames(Cd111_BMI_measured) <- c("ID", "Site", "Gender", "bmi", "age", "Log_Concentration")
Cd111_BMI_measured$Metal <- rep(c("Cd111"), length(Cd111_BMI_measured$age))
colnames(Hg202_BMI_measured) <- c("ID", "Site", "Gender", "bmi", "age", "Log_Concentration")
Hg202_BMI_measured$Metal <- rep(c("Hg202"), length(Hg202_BMI_measured$age))
colnames(Pb208_BMI_measured) <- c("ID", "Site", "Gender", "bmi", "age", "Log_Concentration")
Pb208_BMI_measured$Metal <- rep(c("Pb208"), length(Pb208_BMI_measured$age))
colnames(U238_BMI_measured) <- c("ID", "Site", "Gender", "bmi", "age", "Log_Concentration")
U238_BMI_measured$Metal <- rep(c("U238"), length(U238_BMI_measured$age))

Metals_BMI_measured <- rbind(Mn55_BMI_measured, Cu65_BMI_measured, Cd111_BMI_measured, Hg202_BMI_measured, Pb208_BMI_measured, U238_BMI_measured)

ggplot(Metals_BMI_measured, aes(x=Log_Concentration, y=log10(bmi), color=Metal))+
  geom_point()+
  geom_smooth(method=lm, se=F)+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.text.x=element_text(angle=60, hjust=1),
        axis.line = element_line(color="#000000"))+
  xlab("Logtransformed Concentration (ug/g)")+
  ylab("Logtransformed BMI - Measured at Time of Study")

ggplot(Metals_BMI_measured, aes(y=Log_Concentration, x=age, color=Metal))+
  geom_point()+
  geom_smooth(method=lm, se=F)+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.text.x=element_text(angle=60, hjust=1),
        axis.line = element_line(color="#000000"))+
  xlab("Age")+
  ylab("Log Concentration (ug/g)")

Metals %>% 
  dplyr::select(Mn55, Cu65, Cd111, Hg202, Pb208, U238, Site, ID, Gender) %>% 
  pivot_longer(-c(ID, Site), names_to="Metal", values_to="Concentration") %>%
  ggplot(aes(y=log10(Concentration), fill=Metal)) + 
  geom_boxplot() +
  facet_wrap(~ Site, labeller = labeller(Site = site.labs)) +
  ggtitle("Metals Concentrations by Site")+
  ylab("Log Concentrations")+
  xlab("")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 15),
        panel.spacing = unit(0.75, "cm"))

Metals %>% 
  filter(!is.na(Gender)) %>% 
  dplyr::select(Mn55, Cu65, Cd111, Hg202, Pb208, U238, Site, ID, Gender, age) %>% 
  pivot_longer(-c(ID, Site, Gender, age), names_to="Metal", values_to="Concentration") %>%
  ggplot(aes(x=age, y=log10(Concentration), fill=Metal)) + 
  geom_point(aes(color=Metal)) +
  geom_smooth(aes(color=Metal), size=2, method=lm, se=F) +
  facet_wrap(~ Gender, labeller = labeller(Gender = gender.labs)) +
  ggtitle("Metals Concentrations by Gender")+
  ylab("Log Hair Concentrations (ug/g)")+
  xlab("Age")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 15),
        panel.spacing = unit(0.75, "cm"))

Metals %>% 
  dplyr::select(Mn55, Cu65, Cd111, Hg202, Pb208, U238, Site, ID, Gender, Dental_health, age) %>% 
  pivot_longer(-c(ID, Site, Gender, age, Dental_health), names_to="Metal", values_to="Concentration") %>%
  ggplot(aes(y=log10(Concentration), x=Metal, fill=as.factor(Dental_health))) + 
  geom_boxplot() +
  ggtitle("Metals Concentrations by Dental Health")+
  ylab("Log Concentrations")+
  xlab("")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 15),
        panel.spacing = unit(0.75, "cm"))

png("Hg_Age_SLR.png", width=1400, height=800, res=300)
Metals %>% 
  dplyr::select(Hg202, Site, ID, Gender, age) %>% 
  pivot_longer(-c(ID, Site, Gender, age), names_to="Metal", values_to="Concentration") %>%
  ggplot(aes(x=age, y=log10(Concentration))) + 
  geom_point() +
  geom_smooth(size=2, method=lm, se=F) +
  ylab("Log10 Hg")+
  xlab("Age")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 15),
        panel.spacing = unit(0.75, "cm"))+
  stat_regline_equation(label.x = 30, label.y = 2.2)+
  stat_cor(label.y = 2.8)
dev.off()

model_Hg_age <- lm(log10(Hg202) ~ age, data = Metals)
summary(model_Hg_age) #0.01 - statistically significant at alpha <= 0.05
```
```{r gender_stuff}
Metals %>% 
  dplyr::select(Mn55, Cu65, Cd111, Hg202, Pb208, U238, Site, ID, Gender, Dental_health, age) %>%
  filter(!is.na(Gender)) %>%
  pivot_longer(-c(ID, Site, Gender, age, Dental_health), names_to="Metal", values_to="Concentration") %>%
  ggplot(aes(x=Concentration, y=Metal, color=as.factor(Gender), shape=as.factor(Gender))) + 
  geom_jitter(alpha=0.9) +
  ggtitle("Metals Concentrations by Gender")+
  ylab("")+
  xlab("Concentrations")+
  scale_shape_discrete(name="Gender",
                       labels=c("Male", "Female"))+
  scale_color_discrete(name="Gender",
                       labels=c("Male", "Female"))+
  xlim(0,10)+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 15),
        panel.spacing = unit(0.75, "cm"))


Metals %>% 
  dplyr::select(Mn55, Cu65, Cd111, Hg202, Pb208, U238, Site, ID, Gender, Dental_health, age) %>%
  filter(!is.na(Gender)) %>%
  pivot_longer(-c(ID, Site, Gender, age, Dental_health), names_to="Metal", values_to="Concentration") %>%
  ggplot(aes(y=log10(Concentration), x=Metal)) + 
  geom_violin(aes(fill=as.factor(Gender)), alpha=0.5) +
  ggtitle("Metals Concentrations by Gender")+
  xlab("")+
  ylab("Log Concentrations")+
  scale_fill_discrete(name="Gender",
                       labels=c("Male", "Female"))+
  #xlim(0,10)+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 15),
        panel.spacing = unit(0.75, "cm"))

Metals %>% 
  dplyr::select(Mn55, Cu65, Cd111, Hg202, Pb208, U238, Site, ID, Gender, Dental_health, age) %>%
  filter(!is.na(Gender)) %>%
  pivot_longer(-c(ID, Site, Gender, age, Dental_health), names_to="Metal", values_to="Concentration") %>%
  ggplot(aes(x=log10(Concentration), y=Metal, color=as.factor(Gender), shape=as.factor(Gender))) + 
  geom_jitter(alpha=0.9) +
  geom_boxplot()+
  ggtitle("Metals Concentrations by Gender")+
  ylab("")+
  xlab("Log10 Concentrations")+
  scale_shape_discrete(name="Gender",
                       labels=c("Male", "Female"))+
  scale_color_discrete(name="Gender",
                       labels=c("Male", "Female"))+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 15),
        panel.spacing = unit(0.75, "cm"))



library(ggplot2)
library(dplyr)
library(tidyr)

Metals %>% 
  filter(!is.na(Gender)) %>% 
  dplyr::select(Log_Mn55, Log_Cu65, Log_Cd111, Log_Hg202_Imp, Log_Pb208, Log_U238, Gender, ID) %>% 
  pivot_longer(-c(ID, Gender), names_to="Metals", values_to="Log_Concentration") %>%
  ggplot(aes(y=Log_Concentration, x=Metals, fill=as.factor(Gender))) + 
  geom_boxplot() +
  scale_fill_manual(values=c("1" = "lightblue", "2" = "pink"), name = "Gender",
                    labels = c("1" = "Male", "2" = "Female")) +
  scale_x_discrete(labels = c("Log_Mn55" = "Mn", "Log_Cu65" = "Cu", "Log_Cd111" = "Cd", "Log_Hg202_Imp" = "Hg", "Log_Pb208" = "Pb", "Log_U238" = "U")) +
  ggtitle("Metals Concentrations by Gender") +
  ylab("log10 Concentrations") +
  xlab("") +
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 15),
        panel.spacing = unit(0.75, "cm"))


Metals %>% 
  dplyr::select(Hg202, age, Gender) %>%
  pivot_longer(-c(age, Gender), names_to="Metal", values_to="Concentration") %>%
  ggplot(aes(y=log10(Concentration), x=age)) + 
  geom_point(alpha=0.9) +
  geom_smooth(method=lm, se=F)+
  ggtitle("Hg by Age")+
  ylab("")+
  xlab("Age")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 15),
        panel.spacing = unit(0.75, "cm"))+
  facet_grid(~Gender, labeller = labeller(Gender = gender.labs))
  

#Testing significance of the line above
age_hg_reg <- lm(Hg202~age + Gender, data=Metals)
summary(age_hg_reg)


Metals %>% 
  dplyr::select(U238, Site, ID, Gender, bmi, age) %>%
  filter(!is.na(Gender)) %>%
  pivot_longer(-c(ID, Site, Gender, age, bmi), names_to="Metal", values_to="Concentration") %>%
  ggplot(aes(x=log10(Concentration), y=log10(bmi), color=as.factor(Metal), shape=as.factor(Gender))) + 
  geom_jitter(alpha=0.9) +
  ggtitle("U Concentrations Related to BMI by Gender")+
  ylab("log BMI")+
  xlab("log Concentrations")+
  scale_shape_discrete(name="Gender",
                       labels=c("Male", "Female"))+
  scale_color_manual(name="Metals",
                     values=c("U238"="magenta3"))+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 15),
        panel.spacing = unit(0.75, "cm"))

Metals %>% 
  dplyr::select(Mn55, Cu65, Cd111, Hg202, Pb208, U238, Site, ID, Gender, age) %>%
  filter(!is.na(Gender)) %>%
  pivot_longer(-c(ID, Site, Gender, age), names_to="Metal", values_to="Concentration") %>%
  ggplot(aes(y=Concentration, x=age, color=as.factor(Gender)))+ 
  geom_jitter(alpha=0.5) +
  geom_smooth(aes(color=as.factor(Gender)), size=2, alpha=0.5, method = lm, se=F)+
  ggtitle("Metals Concentrations by Age and Gender")+
  xlab("Age")+
  ylab("Concentrations (ug/g)")+
  scale_color_discrete(name="Gender",
                       labels=c("Male", "Female"))+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 15),
        panel.spacing = unit(0.75, "cm"))+
  facet_wrap(~Metal, scales = "free")

#It is mostly women with the high levels, but that might be an artifact of having mostly women in the study (21% male, 79% female).
```

### Concentrations by Date
```{r envt_samples_by_collectiondate}
#colnames(metals.robpca) <- c("ID", "Log10_Mn55", "Log10_Cu65", "Log10_Cd111", "Log10_Hg202", "Log10_Pb208", "Log10_U238", "Site", "PC1", "PC2", "PC3", "PC4", "PC5")

#colnames(Metals)[colnames(Metals) %in% c("Log10_Mn55.x", "Log10_Cu65.x", "Log10_Cd111.x", "Log10_Hg202.x", "Log10_Pb208.x", "Log10_U238.x", "PC1.x", "PC2.x", "PC3.x", "PC4.x", "PC5.x")] <- c("Log10_Mn55", "Log10_Cu65", "Log10_Cd111", "Log10_Hg202", "Log10_Pb208", "Log10_U238", "PC1", "PC2", "PC3", "PC4", "PC5")

#Metals <- Metals[ , !names(Metals) %in% c("Log10_Mn55.y", "Log10_Cu65.y", "Log10_Cd111.y", "Log10_Hg202.y", "Log10_Pb208.y", "Log10_U238.y", "PC1.y", "PC2.y", "PC3.y", "PC4.y", "PC5.y")]

#colnames(all_metal_merged)[colnames(all_metal_merged) == 'Site.x'] <- 'Site'

all_metal_merged <- Metals %>%
  filter(!is.na(DOB_year))

ggplot(all_metal_merged, aes(x=Date, color=as.factor(Site))) +
 geom_jitter(aes(y=1), position = position_jitter(w = 0.1, h = 0.2)) + # Adjust h for vertical jitter
 scale_color_discrete("Site", labels=c("1"="CSF", "2"="RCBH", "3"="YRMC")) +
 theme(panel.background = element_rect(fill="#ffffff"),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.line = element_line(color="#000000")) +
 scale_x_date(date_breaks = "1 month", date_labels = "%b") +
 ylab("") +
 xlab("Date of Sample Collection")

#Relevant paper: https://www.sciencedirect.com/science/article/pii/S1878535212000263 
```

``` {r checking_ref_doses}
###Detection Frequency (LODs)
#As = 
#Cd = 0.07
#Cu = 0.23
#Fe = 
#Hg = 0.01
#Mn = 
#Pb = 
#U = 0.05

###Thresholds
#As = 1 ug/g #https://www.mayocliniclabs.com/test-catalog/Overview/8651#Clinical-and-Interpretive
#Cd = 0.1 ug/g
#Cu = 10.0 ug/g
#Fe = 10 ug/g 
#Hg = 1 ug/g
#Mn = 1 ug/g
#Pb = 10.0 ug/g
#U = 0.1 ug/g https://academic.oup.com/rpd/article-abstract/144/1-4/423/1612664 https://journals.lww.com/health-physics/abstract/2009/06000/the_mean_concentration_of_uranium_in_drinking.4.aspx 

#%DF
Metals %>% 
  summarise(
            DF_Cd = (sum(Cd111>=0.07, na.rm = T)/211)*100,
            DF_Cu = (sum(Cu65>=0.23, na.rm = T)/211)*100,
            DF_Hg = (sum(Hg202>=0.01, na.rm = T)/118)*100,
            DF_Mn = (sum(Mn55>=0.61, na.rm = T)/211)*100,
            DF_Pb = (sum(Pb208>=0.04, na.rm = T)/211)*100,
            DF_U = (sum(U238>=0.05, na.rm = T)/211)*100)


#Above Threshold
Metals %>% 
  summarise(High_As = (sum(As75>=1, na.rm = T)/211)*100,
            High_Cd = (sum(Cd111>=0.1, na.rm = T)/211)*100,
            High_Cu = (sum(Cu65>=10, na.rm = T)/211)*100,
            High_Fe = (sum(Fe57>=10, na.rm = T)/211)*100,
            High_Hg = (sum(Hg202>=1, na.rm = T)/118)*100,
            High_Mn = (sum(Mn55>=1, na.rm = T)/211)*100,
            High_Pb = (sum(Pb208>=10, na.rm = T)/211)*100,
            High_U = (sum(U238>=0.1, na.rm = T)/211)*100)

Metals %>% 
  summarise(High_As = sum(As75>=1, na.rm = T),
            High_Cd = sum(Cd111>=0.1, na.rm = T),
            High_Cu = sum(Cu65>=10, na.rm = T),
            High_Fe = sum(Fe57>=10, na.rm = T),
            High_Hg = sum(Hg202>=1, na.rm = T),
            High_Mn = sum(Mn55>=1, na.rm = T),
            High_Pb = sum(Pb208>=10, na.rm = T),
            High_U = sum(U238>=0.1, na.rm = T))

Metals %>% 
  summarise(High_As = sum(!is.na(As75)),
            High_Cd = sum(!is.na(Cd111)),
            High_Cu = sum(!is.na(Cu65)),
            High_Fe = sum(!is.na(Fe57)),
            High_Hg = sum(!is.na(Hg202)),
            High_Mn = sum(!is.na(Mn55)),
            High_Pb = sum(!is.na(Pb208)),
            High_U = sum(!is.na(U238)))
```

```{r metals_n_such_n_things}
##Water Source
#Water 1: City
#Water 2: Well
#Water 3: Bottled
#Water 4: Other
#Water 5: Mixed Sources
Cd_Water <- ggplot(Metals, aes(y=log10(Cd111), x=as.factor(Water_all)))+
  geom_boxplot()+
  geom_jitter(aes(color=as.factor(Water_all)), alpha=0.3)+
  geom_hline(aes(yintercept = log10(0.1), color="darkred"))+
  scale_color_discrete(name="Water Source",
                       labels=c("City", "Well", "Bottled", "Other", "Mixed Sources"))+
  xlab("")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 15),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.spacing = unit(0.75, "cm"))+
  ylab("Log Cd")

Cu_Water <- ggplot(Metals, aes(y=log10(Cu65), x=as.factor(Water_all)))+
  geom_boxplot()+
  geom_jitter(aes(color=as.factor(Water_all)), alpha=0.3)+
  geom_hline(aes(yintercept = log10(10), color="darkred"))+
   scale_color_discrete(name="Water Source",
                       labels=c("City", "Well", "Bottled", "Other", "Mixed Sources"))+
  xlab("")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 15),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.spacing = unit(0.75, "cm"))+
  ylab("Log Cu")

Mn_Water <- ggplot(Metals, aes(y=log10(Mn55), x=as.factor(Water_all)))+
  geom_boxplot()+
  geom_jitter(aes(color=as.factor(Water_all)), alpha=0.3)+
  geom_hline(aes(yintercept = log10(6), color="darkred"))+
   scale_color_discrete(name="Water Source",
                       labels=c("City", "Well", "Bottled", "Other", "Mixed Sources"))+
  xlab("")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 15),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.spacing = unit(0.75, "cm"))+
  ylab("Log Mn")

Hg_Water <- ggplot(Metals, aes(y=Log_Hg202_Imp, x=as.factor(Water_all)))+
  geom_boxplot()+
  geom_jitter(aes(color=as.factor(Water_all)), alpha=0.3)+
  geom_hline(aes(yintercept = log10(4.7), color="darkred"))+
   scale_color_discrete(name="Water Source",
                       labels=c("City", "Well", "Bottled", "Other", "Mixed Sources"))+
  xlab("")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 15),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.spacing = unit(0.75, "cm"))+
  ylab("Log Hg")

Pb_Water <- ggplot(Metals, aes(y=log(Pb208), x=as.factor(Water_all)))+
  geom_boxplot()+
  geom_jitter(aes(color=as.factor(Water_all)), alpha=0.3)+
  geom_hline(aes(yintercept = log10(10), color="darkred"))+
   scale_color_discrete(name="Water Source",
                       labels=c("City", "Well", "Bottled", "Other", "Mixed Sources"))+
  xlab("")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 15),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.spacing = unit(0.75, "cm"))+
  ylab("Log Pb")

U_Water <- ggplot(Metals, aes(y=log(U238), x=as.factor(Water_all)))+
  geom_boxplot()+
  geom_jitter(aes(color=as.factor(Water_all)), alpha=0.3)+
   scale_color_discrete(name="Water Source",
                       labels=c("City", "Well", "Bottled", "Other", "Mixed Sources"))+
  xlab("")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 15),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.spacing = unit(0.75, "cm"))+
  ylab("Log U")

mylegend3<-g_legend(Cd_Water)

grid.arrange(arrangeGrob(Cd_Water + theme(legend.position="none"),
                         Cu_Water + theme(legend.position="none"),
                         Hg_Water + theme(legend.position="none"),
                         Mn_Water + theme(legend.position="none"),
                         Pb_Water + theme(legend.position="none"),
                         U_Water + theme(legend.position="none"),
                         nrow=2),
             mylegend3, nrow=1)

Metals_demog <- t(Metals %>% #This includes incomplete urine analyses
  summarize("n"=length(Site),
            "Male"=sum(Gender==1, na.rm = T),
            "Female"=sum(Gender==2, na.rm = T),
            "Refused Gender"=sum(Gender==3, na.rm = T),
            "18-39"=sum(age>=18 & age<40, na.rm = T),
            "40-59"=sum(age>=40 & age<60, na.rm = T),
            "60+"=sum(age>=60, na.rm = T),
            "Average Age"=round(mean(age, na.rm = T), 1),
            "SD Age"=round(sd(age, na.rm = T), 1),
            "Hispanic"=sum(Ethnicity==1, na.rm = T),
            "Not Hispanic"=sum(Ethnicity==2, na.rm = T),
            "American Indian or Alaska Native"=sum(Race_ai_an==1, na.rm=T),
            "Asian"=sum(Race_asian==1, na.rm=T),
            "Black or African American"=sum(Race_black==1, na.rm=T),
            "Native Hawaiian or Pacific Islander"=sum(Race_pac_isl==1, na.rm=T),
            "White"=sum(Race_white==1, na.rm=T),
            "Other"=sum(Race_other==1, na.rm=T),
            "Don't know race"=sum(Race_dk==1, na.rm=T),
            "Refused race"=sum(Race_refuse==1, na.rm=T),
            "NA race"=sum(is.na(Race_ai_an)&is.na(Race_asian)&is.na(Race_black)&is.na(Race_pac_isl)&is.na(Race_white)&is.na(Race_other)&is.na(Race_dk)&is.na(Race_refuse)),
            "Married"=sum(Marital_status==1, na.rm=T),
            "Widowed"=sum(Marital_status==2, na.rm=T),
            "Divorced"=sum(Marital_status==3, na.rm=T),
            "Separated"=sum(Marital_status==4, na.rm=T),
            "Never married"=sum(Marital_status==5, na.rm=T),
            "No school"=sum(Education==1,  na.rm = T),
            "Elementary school"=sum(Education==2,  na.rm = T),
            "Middle school"=sum(Education==3,  na.rm = T),
            "High school"=sum(Education==4,  na.rm = T),
            "College"=sum(Education==5,  na.rm = T),
            "Advanced degree"=sum(Education==6,  na.rm = T),
            "Other EDU"=sum(Education==7,  na.rm = T),
            "Farmers"=sum(Farmer==1, na.rm=T),
            "NonFarmer"=sum(Farmer==2, na.rm=T),
            "Income At or Above Pob Level"=sum(Below_Pov==0, na.rm = T),
            "Income Below Pov Level"=sum(Below_Pov==1, na.rm = T),
            "WaterHomeTap"=sum(Water_home==1, na.rm=T),
            "WaterHomeWell"=sum(Water_home==2, na.rm=T),
            "WaterHomeBottled"=sum(Water_home==3, na.rm=T),
            "WaterHomeOther"=sum(Water_home==4, na.rm=T),
            "PesticideExpYes"=sum(Pesticides==1, na.rm=T),
            "PesticideExpNo"=sum(Pesticides==2, na.rm=T),
            "PesticideExpDK"=sum(Pesticides==3, na.rm=T),
            "PesticideExpRef"=sum(Pesticides==4, na.rm=T),
            "Never Smoker"=sum(is.na(tobacco_history_fact)),
            "Heavy (Daily) Smoker"=sum(tobacco_history_fact==3, na.rm=T),
            "Light (Occasional) Smoker"=sum(tobacco_history_fact==2, na.rm=T),
            "Previous Smoker (Quit)"=sum(tobacco_history_fact==1, na.rm=T),
            "Mean BMI"=round(mean(bmi, na.rm = T),1),
            "SD BMI"=round(sd(bmi, na.rm = T),1),
            "BMI<=25"=sum(bmi<=25, na.rm=T),
            "25<BMI<=30"=sum(bmi>25&bmi<=30, na.rm=T),
            "BMI>30"=sum(bmi>30, na.rm=T),
            "Overweight"=sum(Overweight==1, na.rm = T),
            "Obesity - EMR"=sum(emr_obesity==1, na.rm = T),
            "Lived < 6 mo"=sum(Lived_in_Yuma==1, na.rm = T),
            "Lived 6 mo - 1yr"=sum(Lived_in_Yuma==2, na.rm = T),
            "Lived 1-3 yrs"=sum(Lived_in_Yuma==3, na.rm = T),
            "Lived 3-5 yrs"=sum(Lived_in_Yuma==4, na.rm = T),
            "Lived > 5 yrs"=sum(Lived_in_Yuma==5, na.rm = T)))

ggplot(data=subset(Metals, Metals$undescended!=2), aes(x=factor(Lived_in_Yuma), y=ID, color=factor(undescended)))+
  geom_point()+
  theme(axis.text.y = element_blank())

ggplot(data=subset(Metals, Metals$ambiguous!=2), aes(x=factor(Lived_in_Yuma), y=ID, color=factor(ambiguous)))+
  geom_point()+
  theme(axis.text.y = element_blank())


```
