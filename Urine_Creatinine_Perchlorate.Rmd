---
title: "Correlation of Perchlorate and Creatinine in Urine Samples"
author: "Jenna Honan"
date: "9/5/2022"
output: html_document
---

## Merging Datasets for Analysis
```{r merge}
## Required libraries
library(dplyr)
library(knitr)
library(gridExtra)
library(tidyverse)
library(grid)
library(gridtext)
library(ggplot2)
library(ggpubr)
library(ggbreak) 
library(patchwork)
library(reshape)
library(haven)
library(car)
library(writexl)
library(EnvStats)
library(MatchIt)
library(purrr)
library(tidyr)
library(MASS)
library(car)
library(psych)
library(effects)
library(jmvcore)
library(jmv)
library(cowplot)
library(lmtest)
library(scales)
library(ggh4x)
library(vcd)
library(caret)
library(ggforce)

#Setting WD
setwd("~/Desktop/Yuma Project/Yuma - R Project/")

#Number of concentrations below the limit of detection = None
kable(All_Data %>% 
  filter(!is.na(Result_C_mg_dL)) %>% 
  summarise("n Creatinine < LOD"=sum(Result_C_mg_dL<LOD_C, na.rm = T),
            "n Perchlorate < LOD"=sum(Result_P_ng_mL<LOD_P, na.rm = T)))
#Rows with missing data (not collected or analyzed) for either creatinine or perchorate have been removed above. No replacement needed - all detected values above LOD (DF=100%).

#Number of participants who did not have concentration values for perchlorate or creatinine:
All_Data %>% 
  filter(!is.na(Result_P_ng_mL)) %>% 
  summarize("Number Part. with Perchlorate"=length(unique(Sample_ID)))

All_Data %>% 
  filter(!is.na(Result_C_mg_dL)) %>% 
  summarize("Number Part. with Creatinine"=length(unique(Sample_ID)))

#EMR vs SR Thyroid Probs
All_Data %>% 
  summarise("Total"=sum(!is.na(any_thyroid_problem_dummy)),
            "Yes_Thyroid_Prob"=sum(any_thyroid_problem_dummy==1, na.rm = T),
            "No_Thyroid_Prob"=sum(any_thyroid_problem_dummy==0, na.rm = T))

All_Data %>% 
  summarise("Total"=sum(!is.na(emr_thyroid_problem_fromothercolumns)),
            "Yes_Thyroid_Prob"=sum(emr_thyroid_problem_fromothercolumns==1, na.rm = T),
            "No_Thyroid_Prob"=sum(emr_thyroid_problem_fromothercolumns==0, na.rm = T))

#Number of people with blood TSH and urine perchlorate
sum(!is.na(All_Data$TSH)&!is.na(All_Data$Result_P_ng_mL)) 
```

## Checking Distributions
```{r distributions}
All_Data$Result_C_mg_dL <- as.numeric(All_Data$Result_C_mg_dL)
All_Data$Result_P_ng_mL <- as.numeric(All_Data$Result_P_ng_mL)

#Basic numbers

median(All_Data$Result_P_ng_mL, na.rm = T)
median(All_Data$Result_C_mg_dL, na.rm = T)
range(All_Data$Result_P_ng_mL, na.rm = T)
range(All_Data$Result_C_mg_dL, na.rm = T)

geoMean(All_Data$Result_P_ng_mL, na.rm = T)
geoSD(All_Data$Result_P_ng_mL, na.rm = T)
geoMean(All_Data$Result_C_mg_dL, na.rm = T)
geoSD(All_Data$Result_C_mg_dL, na.rm = T)

#perch/creat values typically reported at ug/g

All_Data$Result_C_g_mL <- as.numeric(All_Data$Result_C_mg_dL)/100000
All_Data$Result_P_ug_mL <- as.numeric(All_Data$Result_P_ng_mL)/1000

All_Data$Result_C_ng_mL <- as.numeric(All_Data$Result_C_mg_dL)*10000

geoMean(All_Data$Result_P_ug_mL/All_Data$Result_C_g_mL, na.rm = T)
geoSD(All_Data$Result_P_ug_mL/All_Data$Result_C_g_mL, na.rm = T)
mean(log10(All_Data$Result_P_ug_mL/All_Data$Result_C_g_mL), na.rm = T)
sd(log10(All_Data$Result_P_ug_mL/All_Data$Result_C_g_mL), na.rm = T)

All_Data %>% 
  group_by(any_thyroid_problem_dummy) %>% 
  summarise("Mean Perch"=geoMean(Result_P_ng_mL, na.rm = T),
            "SD Perch"=geoSD(Result_P_ng_mL, na.rm = T),
            "n Perch"=sum(!is.na(Result_P_ng_mL)),
            "Mean Creat"=geoMean(Result_C_mg_dL, na.rm = T),
            "SD Creat"=geoSD(Result_C_mg_dL, na.rm = T),
            "n Creat"=sum(!is.na(Result_C_mg_dL)),
            "Mean Perch/Creat"=geoMean(Result_P_ug_mL/Result_C_g_mL, na.rm = T),
            "SD Perch/Creat"=geoSD(Result_P_ug_mL/Result_C_g_mL, na.rm = T),
            "n Perch/Creat"=sum(!is.na(Result_P_ug_mL/Result_C_g_mL)))

All_Data %>% 
  group_by(EMR_any_thyroid_Dummy) %>% 
  summarise("Mean Perch"=geoMean(Result_P_ng_mL, na.rm = T),
            "SD Perch"=geoSD(Result_P_ng_mL, na.rm = T),
            "n Perch"=sum(!is.na(Result_P_ng_mL)),
            "Mean Creat"=geoMean(Result_C_mg_dL, na.rm = T),
            "SD Creat"=geoSD(Result_C_mg_dL, na.rm = T),
            "n Creat"=sum(!is.na(Result_C_mg_dL)),
            "Mean Perch/Creat"=geoMean(Result_P_ng_mL/Result_C_ng_mL, na.rm = T),
            "SD Perch/Creat"=geoSD(Result_P_ng_mL/Result_C_ng_mL, na.rm = T),
            "n Perch/Creat"=sum(!is.na(Result_P_ng_mL/Result_C_ng_mL)))

All_Data %>% 
  group_by(Gender) %>% 
  summarise("Mean Perch"=geoMean(Result_P_ng_mL, na.rm = T),
            "SD Perch"=geoSD(Result_P_ng_mL, na.rm = T),
            "n Perch"=sum(!is.na(Result_P_ng_mL)),
            "Mean Creat"=geoMean(Result_C_mg_dL, na.rm = T),
            "SD Creat"=geoSD(Result_C_mg_dL, na.rm = T),
            "n Creat"=sum(!is.na(Result_C_mg_dL)),
            "Mean Perch/Creat"=geoMean(Result_P_ng_mL/Result_C_ng_mL, na.rm = T),
            "SD Perch/Creat"=geoSD(Result_P_ng_mL/Result_C_ng_mL, na.rm = T),
            "n Perch/Creat"=sum(!is.na(Result_P_ng_mL/Result_C_ng_mL)))

All_Data %>% 
  group_by(Site) %>% 
  summarise("Mean Perch"=geoMean(Result_P_ng_mL, na.rm = T),
            "SD Perch"=geoSD(Result_P_ng_mL, na.rm = T),
            "n Perch"=sum(!is.na(Result_P_ng_mL)),
            "Mean Creat"=geoMean(Result_C_mg_dL, na.rm = T),
            "SD Creat"=geoSD(Result_C_mg_dL, na.rm = T),
            "n Creat"=sum(!is.na(Result_C_mg_dL)),
            "Mean Perch/Creat"=geoMean(Result_P_ng_mL/Result_C_ng_mL, na.rm = T),
            "SD Perch/Creat"=geoSD(Result_P_ng_mL/Result_C_ng_mL, na.rm = T),
            "n Perch/Creat"=sum(!is.na(Result_P_ng_mL/Result_C_ng_mL)))

Perch_Site_Anova <- aov(log(Result_P_ng_mL)~as.factor(Site), data=All_Data)
summary(Perch_Site_Anova)

Perch_Site_Anova2 <- aov(log10(Result_P_ng_mL)~as.factor(Site), data=All_Data)
summary(Perch_Site_Anova2)
#Results of test don't change whether I use natural log or log10. My preference is ln, but most of the other literature uses log10... will use log10 to be consistent with other literature.

Creat_Site_Anova <- aov(log10(Result_C_mg_dL)~as.factor(Site), data=All_Data)
summary(Creat_Site_Anova)

PerchCreat_Site_Anova <- aov(log10(Result_P_ng_mL/Result_C_ng_mL)~as.factor(Site), data=All_Data)
summary(PerchCreat_Site_Anova)

PerchCreat_Site_Anova2 <- aov(log(Result_P_ng_mL/Result_C_ng_mL)~as.factor(Site), data=All_Data)
summary(PerchCreat_Site_Anova2) #Again, same test result.

t.test(log10(Result_P_ng_mL)~as.factor(any_thyroid_problem_dummy), data=All_Data, var.equal=FALSE)

t.test(log10(Result_C_mg_dL)~as.factor(any_thyroid_problem_dummy), data=All_Data, var.equal=FALSE)

t.test(log10(Result_P_ng_mL/Result_C_ng_mL)~as.factor(any_thyroid_problem_dummy), data=All_Data, var.equal=FALSE)

t.test(log10(Result_P_ng_mL)~as.factor(EMR_any_thyroid_Dummy), data=All_Data, var.equal=FALSE)

t.test(log10(Result_C_mg_dL)~as.factor(EMR_any_thyroid_Dummy), data=All_Data, var.equal=FALSE)

t.test(log10(Result_P_ng_mL/Result_C_ng_mL)~as.factor(EMR_any_thyroid_Dummy), data=All_Data, var.equal=FALSE)


t.test(log10(Result_P_ng_mL)~as.factor(Gender), data=All_Data, var.equal=FALSE)

t.test(log10(Result_C_mg_dL)~as.factor(Gender), data=All_Data, var.equal=FALSE)

t.test(log10(Result_P_ng_mL/Result_C_ng_mL)~as.factor(Gender), data=All_Data, var.equal=FALSE)

tiff("Creatinine_Dist.tiff", units="in", width=8, height=5, res=300) #Only to save in high def.
ggplot(All_Data, aes(x=Result_C_mg_dL))+
  geom_histogram()+
  xlab("\nCreatinine (mg/dL)")+
  ylab("Frequency\n")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 20))
dev.off()

tiff("Perchlorate_Dist.tiff", units="in", width=8, height=5, res=300) #Only to save in high def.
ggplot(All_Data, aes(x=Result_P_ng_mL))+
  geom_histogram()+
  xlab("\nPerchlorate (ng/mL)")+
  ylab("Frequency\n")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 20))
dev.off()

tiff("Perch_Creat_Dist.tiff", units="in", width=12, height=4, res=300) #Only to save in high def.
Perch_Dist <- ggplot(All_Data, aes(x=Result_P_ng_mL))+
  geom_histogram()+
  xlab("\n[Perchlorate] (ng/mL)")+
  ylab("Frequency\n")+
  ylim(c(0,45))+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 20))
Creat_Dist <- ggplot(All_Data, aes(x=Result_C_mg_dL))+
  geom_histogram()+
  xlab("\n[Creatinine] (mg/dL)")+
  ylab("")+
  ylim(c(0,45))+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 20))
Perch_Creat_Dist <- ggplot(All_Data, aes(x=Result_P_ng_mL/Result_C_ng_mL))+
  geom_histogram()+
  xlab("\n[Perchlorate]/[Creatinine]")+
  ylab("")+
  ylim(c(0,45))+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 20))
ggarrange(Perch_Dist, Creat_Dist, Perch_Creat_Dist, ncol=3)
dev.off()


hist(log(All_Data$Result_C_mg_dL), xlab = "Ln Creatinine", main = "Distribution of Creatinine Levels After Log Transformation")
hist(log10(All_Data$Result_C_mg_dL), xlab = "Log10 Creatinine", main = "Distribution of Creatinine Levels After Log Transformation")

hist(log(All_Data$Result_P_ng_mL), xlab = "Ln Perchlorate", main = "Distribution of Perchlorate Levels After Log Transformation")
hist(log10(All_Data$Result_P_ng_mL), xlab = "Log10 Perchlorate", main = "Distribution of Perchlorate Levels After Log Transformation")

hist(log(All_Data$Result_P_ng_mL/All_Data$Result_C_ng_mL), xlab = "Ln Perchlorate", main = "Distribution of Perchlorate Levels After Log Transformation")
hist(log10(All_Data$Result_P_ng_mL/All_Data$Result_C_ng_mL), xlab = "Log10 Perchlorate", main = "Distribution of Perchlorate Levels After Log Transformation")

#All of these look rooouuuuggghhhly the same. The transition with either ln or log10 does normalize the data. Again, will stick with log10 for consistency, particularly with CDC literature. 

Urine_Perch_Creat$Result_C_mg_dL <- as.numeric(Urine_Perch_Creat$Result_C_mg_dL)*10000
hist((log10(All_Data$Result_P_ng_mL/All_Data$Result_C_ng_mL)), xlab = "Log10 Perchlorate per Log10 Creatinine", main = "Distribution of Perchlorate Levels Standardized by Creatinine 
      After Log Transformation")

#Turns out I don't need to convert the units on the creatinine because it's a ratio, so it cancels out anyway and is essentially unitless. The patterns don't change, it just shifts everything on the x-axis. Won't affect statistical tests
```

### Hormone Levels
```{r hormones, warning=F}
#Looking at total levels first before free 
TSH <- ggplot(All_Data) +geom_boxplot(aes(y=TSH)) +theme(axis.ticks.x = element_blank(),axis.text.x = element_blank()) +theme_classic() +ylab("TSH (units)")
T3 <- ggplot(All_Data) +geom_boxplot(aes(y=TotalT3)) +theme(axis.ticks.x = element_blank(),axis.text.x = element_blank()) +theme_classic() +ylab("Total T3 (units)")
T4 <- ggplot(All_Data) +geom_boxplot(aes(y=TotalT4)) +theme(axis.ticks.x = element_blank(),axis.text.x = element_blank()) +theme_classic() +ylab("Total T4 (units)")
Cortisol <- ggplot(All_Data) +geom_boxplot(aes(y=Cortisol)) +theme(axis.ticks.x = element_blank(),axis.text.x = element_blank()) +theme_classic() +ylab("Cortisol (units)")

grid.arrange(TSH, Cortisol, T3, T4)

#Looking at distributions
#TSH: uIU/mL
#fT4: pg/mL
#Total T4: ng/mL
#fT3: pg/mL
#Total T3: ng/mL
#Cortisol: ng/mL

hist(All_Data$TSH, main="TSH Distribution", xlab = "TSH (mIU/mL)")
hist(All_Data$TotalT3, main="Total T3 Distribution", xlab = "Total T3 (ng/mL)")
hist(All_Data$fT3, main="Free T3 Distribution", xlab = "Free T3 (pg/mL)")
hist(All_Data$TotalT4, main="Total T4 Distribution", xlab = "Total T4 (ng/mL)")
hist(All_Data$fT4, main="Free T4 Distribution", xlab = "Free T4 (pg/mL)")
hist(All_Data$Cortisol, main="Cortisol Distribution", xlab = "Cortisol (ng/mL)")

#Levels by date
data.melt2 <- melt(All_Data,id.vars=c('ID','Date'), measure.vars=c('TSH','fT3', 'TotalT3', 'fT4', 'TotalT4', 'Cortisol'))

ggplot(data.melt2, aes(y=value, x=Date, color=variable))+
  geom_point()+
  geom_smooth(se=F)+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.text.x=element_text(angle=60, hjust=1),
        axis.line = element_line(color="#000000"))+
  scale_x_date(date_breaks = "1 month", date_labels =  "%b")+
  ylab("Hormone Levels")+
  xlab("Date of Sample Collection")+
  labs(color='Hormones')

ggplot(data.melt2, aes(x=value))+
  geom_histogram(aes(fill=variable))

hist1a <- ggplot(All_Data, aes(x=TSH))+
  geom_histogram(aes(y=..density..), fill="lightblue", color="black")+
  geom_density(alpha=.5, fill="darkred")+
  scale_y_break(c(0.15, 0.45))+
  xlab("TSH (mIU/mL)")+
  ylab("")+
  theme(panel.background = element_rect(fill="#ffffff"),
        text = element_text(size=15))

hist2 <- ggplot(All_Data, aes(x=TotalT3))+
  geom_histogram(aes(y=..density..), fill="lightblue", color="black")+
  geom_density(alpha=.5, fill="darkred")+
  xlab("Total T3 (ng/mL)")+
  ylab("")+
  theme(panel.background = element_rect(fill="#ffffff"),
        text = element_text(size=15))

hist3 <- ggplot(All_Data, aes(x=fT3))+
  geom_histogram(aes(y=..density..), fill="lightblue", color="black")+
  geom_density(alpha=.5, fill="darkred")+
  xlab("Free T3 (pg/mL)")+
  ylab("")+
  theme(panel.background = element_rect(fill="#ffffff"),
        text = element_text(size=15))

hist4 <- ggplot(All_Data, aes(x=TotalT4))+
  geom_histogram(aes(y=..density..), fill="lightblue", color="black")+
  geom_density(alpha=.5, fill="darkred")+
  xlab("Total T4 (ng/mL)")+
  ylab("")+
  theme(panel.background = element_rect(fill="#ffffff"),
        text = element_text(size=15))

hist5 <- ggplot(All_Data, aes(x=fT4))+
  geom_histogram(aes(y=..density..), fill="lightblue", color="black")+
  geom_density(alpha=.5, fill="darkred")+
  xlab("Free T4 (pg/mL)")+
  ylab("")+
  theme(panel.background = element_rect(fill="#ffffff"),
        text = element_text(size=15))

hist6 <- ggplot(All_Data, aes(x=Cortisol))+
  geom_histogram(aes(y=..density..), fill="lightblue", color="black")+
  geom_density(alpha=.5, fill="darkred")+
  xlab("Cortisol (ng/mL)")+
  ylab("")+
  theme(panel.background = element_rect(fill="#ffffff"),
        text = element_text(size=15))

tiff("Hormone_Hists.tiff", units="in", width=10, height=5, res=300) #Only to save in high def.
ggarrange(hist1a, hist2, hist3, hist4, hist5, hist6, ncol = 3, nrow=2)
dev.off()

tiff("Hormone_Hists_Break.tiff", units="in", width=3.3, height=2.5, res=300) #Only to save in high def.
hist1a
dev.off()

#create_report(data.melt2) Only do when necessary


All_Data %>% 
  filter(!is.na(fT3)) %>% 
  summarize("Number Part. with fT3"=length(unique(ID)))

All_Data %>% 
  filter(!is.na(TotalT3)) %>% 
  summarize("Number Part. with TT3"=length(unique(ID)))

All_Data %>% 
  filter(!is.na(fT4)) %>% 
  summarize("Number Part. with fT4"=length(unique(ID)))

All_Data %>% 
  filter(!is.na(TotalT4)) %>% 
  summarize("Number Part. with TT4"=length(unique(ID)))

All_Data %>% 
  filter(!is.na(TSH)) %>% 
  summarize("Number Part. with TSH"=length(unique(ID)))

All_Data %>% 
  filter(!is.na(Cortisol)) %>% 
  summarize("Number Part. with Cortisol"=length(unique(ID)))

#Overall
All_Data %>% 
  summarise(n=sum(!is.na(TSH)|!is.na(fT4)|!is.na(fT3)|!is.na(Cortisol)|!is.na(TotalT4)|!is.na(TotalT3)),
            geoMeanTSH=geoMean(TSH, na.rm = T),
            geoSDTSH=geoSD(TSH, na.rm = T),
            geoMeanfT4=geoMean(fT4, na.rm = T),
            geoSDfT4=geoSD(fT4, na.rm = T),
            geoMeanfT3=geoMean(fT3, na.rm = T),
            geoSDfT3=geoSD(fT3, na.rm = T),
            geoMeanCort=geoMean(Cortisol, na.rm = T),
            geoSDCort=geoSD(Cortisol, na.rm = T),
            geoMeanTT4=geoMean(TotalT4, na.rm = T),
            geoSDTT4=geoSD(TotalT4, na.rm = T),
            geoMeanTT3=geoMean(TotalT3, na.rm = T),
            geoSDTT3=geoSD(TotalT3, na.rm = T))

#SR Controls
All_Data %>% 
  filter(any_thyroid_problem_dummy==0) %>% 
  summarise(n=sum(!is.na(TSH)|!is.na(fT4)|!is.na(fT3)|!is.na(Cortisol)|!is.na(TotalT4)|!is.na(TotalT3)),
            geoMeanTSH=geoMean(TSH, na.rm = T),
            geoSDTSH=geoSD(TSH, na.rm = T),
            geoMeanfT4=geoMean(fT4, na.rm = T),
            geoSDfT4=geoSD(fT4, na.rm = T),
            geoMeanfT3=geoMean(fT3, na.rm = T),
            geoSDfT3=geoSD(fT3, na.rm = T),
            geoMeanCort=geoMean(Cortisol, na.rm = T),
            geoSDCort=geoSD(Cortisol, na.rm = T),
            geoMeanTT4=geoMean(TotalT4, na.rm = T),
            geoSDTT4=geoSD(TotalT4, na.rm = T),
            geoMeanTT3=geoMean(TotalT3, na.rm = T),
            geoSDTT3=geoSD(TotalT3, na.rm = T))

#SR Cases
All_Data %>% 
  filter(any_thyroid_problem_dummy==1) %>% 
  summarise(n=sum(!is.na(TSH)|!is.na(fT4)|!is.na(fT3)|!is.na(Cortisol)|!is.na(TotalT4)|!is.na(TotalT3)),
            geoMean=geoMean(TSH, na.rm = T),
            geoSD=geoSD(TSH, na.rm = T),
            geoMeanfT4=geoMean(fT4, na.rm = T),
            geoSDfT4=geoSD(fT4, na.rm = T),
            geoMeanfT3=geoMean(fT3, na.rm = T),
            geoSDfT3=geoSD(fT3, na.rm = T),
            geoMeanCort=geoMean(Cortisol, na.rm = T),
            geoSDCort=geoSD(Cortisol, na.rm = T),
            geoMeanTT4=geoMean(TotalT4, na.rm = T),
            geoSDTT4=geoSD(TotalT4, na.rm = T),
            geoMeanTT3=geoMean(TotalT3, na.rm = T),
            geoSDTT3=geoSD(TotalT3, na.rm = T))

#EMR Controls
All_Data %>% 
  filter(EMR_any_thyroid_Dummy==0) %>% 
  summarise(n=sum(!is.na(TSH)|!is.na(fT4)|!is.na(fT3)|!is.na(Cortisol)|!is.na(TotalT4)|!is.na(TotalT3)),
            geoMeanTSH=geoMean(TSH, na.rm = T),
            geoSDTSH=geoSD(TSH, na.rm = T),
            geoMeanfT4=geoMean(fT4, na.rm = T),
            geoSDfT4=geoSD(fT4, na.rm = T),
            geoMeanfT3=geoMean(fT3, na.rm = T),
            geoSDfT3=geoSD(fT3, na.rm = T),
            geoMeanCort=geoMean(Cortisol, na.rm = T),
            geoSDCort=geoSD(Cortisol, na.rm = T),
            geoMeanTT4=geoMean(TotalT4, na.rm = T),
            geoSDTT4=geoSD(TotalT4, na.rm = T),
            geoMeanTT3=geoMean(TotalT3, na.rm = T),
            geoSDTT3=geoSD(TotalT3, na.rm = T))

#EMR Cases
All_Data %>% 
  filter(EMR_any_thyroid_Dummy==1) %>% 
  summarise(n=sum(!is.na(TSH)|!is.na(fT4)|!is.na(fT3)|!is.na(Cortisol)|!is.na(TotalT4)|!is.na(TotalT3)),
            geoMean=geoMean(TSH, na.rm = T),
            geoSD=geoSD(TSH, na.rm = T),
            geoMeanfT4=geoMean(fT4, na.rm = T),
            geoSDfT4=geoSD(fT4, na.rm = T),
            geoMeanfT3=geoMean(fT3, na.rm = T),
            geoSDfT3=geoSD(fT3, na.rm = T),
            geoMeanCort=geoMean(Cortisol, na.rm = T),
            geoSDCort=geoSD(Cortisol, na.rm = T),
            geoMeanTT4=geoMean(TotalT4, na.rm = T),
            geoSDTT4=geoSD(TotalT4, na.rm = T),
            geoMeanTT3=geoMean(TotalT3, na.rm = T),
            geoSDTT3=geoSD(TotalT3, na.rm = T))

#SR Cases With Meds
All_Data %>% 
  filter(any_thyroid_problem_dummy==1 & thyroid_med==1) %>% 
  summarise(n=sum(!is.na(TSH)|!is.na(fT4)|!is.na(fT3)|!is.na(Cortisol)|!is.na(TotalT4)|!is.na(TotalT3)),
            geoMean=geoMean(TSH, na.rm = T),
            geoSD=geoSD(TSH, na.rm = T),
            geoMeanfT4=geoMean(fT4, na.rm = T),
            geoSDfT4=geoSD(fT4, na.rm = T),
            geoMeanfT3=geoMean(fT3, na.rm = T),
            geoSDfT3=geoSD(fT3, na.rm = T),
            geoMeanCort=geoMean(Cortisol, na.rm = T),
            geoSDCort=geoSD(Cortisol, na.rm = T),
            geoMeanTT4=geoMean(TotalT4, na.rm = T),
            geoSDTT4=geoSD(TotalT4, na.rm = T),
            geoMeanTT3=geoMean(TotalT3, na.rm = T),
            geoSDTT3=geoSD(TotalT3, na.rm = T))

#SR Cases Without Meds
All_Data %>% 
  filter(any_thyroid_problem_dummy==1 & thyroid_med==0) %>% 
  summarise(n=sum(!is.na(TSH)|!is.na(fT4)|!is.na(fT3)|!is.na(Cortisol)|!is.na(TotalT4)|!is.na(TotalT3)),
            geoMean=geoMean(TSH, na.rm = T),
            geoSD=geoSD(TSH, na.rm = T),
            geoMeanfT4=geoMean(fT4, na.rm = T),
            geoSDfT4=geoSD(fT4, na.rm = T),
            geoMeanfT3=geoMean(fT3, na.rm = T),
            geoSDfT3=geoSD(fT3, na.rm = T),
            geoMeanCort=geoMean(Cortisol, na.rm = T),
            geoSDCort=geoSD(Cortisol, na.rm = T),
            geoMeanTT4=geoMean(TotalT4, na.rm = T),
            geoSDTT4=geoSD(TotalT4, na.rm = T),
            geoMeanTT3=geoMean(TotalT3, na.rm = T),
            geoSDTT3=geoSD(TotalT3, na.rm = T))

#EMR Cases With Meds
All_Data %>% 
  filter(EMR_any_thyroid_Dummy==1 & thyroid_med==1) %>% 
  summarise(n=sum(!is.na(TSH)|!is.na(fT4)|!is.na(fT3)|!is.na(Cortisol)|!is.na(TotalT4)|!is.na(TotalT3)),
            geoMean=geoMean(TSH, na.rm = T),
            geoSD=geoSD(TSH, na.rm = T),
            geoMeanfT4=geoMean(fT4, na.rm = T),
            geoSDfT4=geoSD(fT4, na.rm = T),
            geoMeanfT3=geoMean(fT3, na.rm = T),
            geoSDfT3=geoSD(fT3, na.rm = T),
            geoMeanCort=geoMean(Cortisol, na.rm = T),
            geoSDCort=geoSD(Cortisol, na.rm = T),
            geoMeanTT4=geoMean(TotalT4, na.rm = T),
            geoSDTT4=geoSD(TotalT4, na.rm = T),
            geoMeanTT3=geoMean(TotalT3, na.rm = T),
            geoSDTT3=geoSD(TotalT3, na.rm = T))

#EMR Cases Without Meds
All_Data %>% 
  filter(EMR_any_thyroid_Dummy==1 & thyroid_med==0) %>% 
  summarise(n=sum(!is.na(TSH)|!is.na(fT4)|!is.na(fT3)|!is.na(Cortisol)|!is.na(TotalT4)|!is.na(TotalT3)),
            geoMean=geoMean(TSH, na.rm = T),
            geoSD=geoSD(TSH, na.rm = T),
            geoMeanfT4=geoMean(fT4, na.rm = T),
            geoSDfT4=geoSD(fT4, na.rm = T),
            geoMeanfT3=geoMean(fT3, na.rm = T),
            geoSDfT3=geoSD(fT3, na.rm = T),
            geoMeanCort=geoMean(Cortisol, na.rm = T),
            geoSDCort=geoSD(Cortisol, na.rm = T),
            geoMeanTT4=geoMean(TotalT4, na.rm = T),
            geoSDTT4=geoSD(TotalT4, na.rm = T),
            geoMeanTT3=geoMean(TotalT3, na.rm = T),
            geoSDTT3=geoSD(TotalT3, na.rm = T))

#Males
All_Data %>% 
  filter(Gender==1) %>% 
  summarise(n=sum(!is.na(TSH)|!is.na(fT4)|!is.na(fT3)|!is.na(Cortisol)|!is.na(TotalT4)|!is.na(TotalT3)),
            geoMean=geoMean(TSH, na.rm = T),
            geoSD=geoSD(TSH, na.rm = T),
            geoMeanfT4=geoMean(fT4, na.rm = T),
            geoSDfT4=geoSD(fT4, na.rm = T),
            geoMeanfT3=geoMean(fT3, na.rm = T),
            geoSDfT3=geoSD(fT3, na.rm = T),
            geoMeanCort=geoMean(Cortisol, na.rm = T),
            geoSDCort=geoSD(Cortisol, na.rm = T),
            geoMeanTT4=geoMean(TotalT4, na.rm = T),
            geoSDTT4=geoSD(TotalT4, na.rm = T),
            geoMeanTT3=geoMean(TotalT3, na.rm = T),
            geoSDTT3=geoSD(TotalT3, na.rm = T))

#Females
All_Data %>% 
  filter(Gender==2) %>% 
  summarise(n=sum(!is.na(TSH)|!is.na(fT4)|!is.na(fT3)|!is.na(Cortisol)|!is.na(TotalT4)|!is.na(TotalT3)),
            geoMean=geoMean(TSH, na.rm = T),
            geoSD=geoSD(TSH, na.rm = T),
            geoMeanfT4=geoMean(fT4, na.rm = T),
            geoSDfT4=geoSD(fT4, na.rm = T),
            geoMeanfT3=geoMean(fT3, na.rm = T),
            geoSDfT3=geoSD(fT3, na.rm = T),
            geoMeanCort=geoMean(Cortisol, na.rm = T),
            geoSDCort=geoSD(Cortisol, na.rm = T),
            geoMeanTT4=geoMean(TotalT4, na.rm = T),
            geoSDTT4=geoSD(TotalT4, na.rm = T),
            geoMeanTT3=geoMean(TotalT3, na.rm = T),
            geoSDTT3=geoSD(TotalT3, na.rm = T))
#Gender
t.test(log10(All_Data$TSH)~as.factor(All_Data$Gender), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

t.test(log10(All_Data$fT4)~as.factor(All_Data$Gender), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

t.test(log10(All_Data$fT3)~as.factor(All_Data$Gender), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

t.test(log10(All_Data$Cortisol)~as.factor(All_Data$Gender), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

t.test(log10(All_Data$TotalT4)~as.factor(All_Data$Gender), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

t.test(log10(All_Data$TotalT3)~as.factor(All_Data$Gender), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

#SR Cases v Controls
t.test(log10(All_Data$TSH)~as.factor(All_Data$any_thyroid_problem_dummy), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

t.test(log10(All_Data$fT4)~as.factor(All_Data$any_thyroid_problem_dummy), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

t.test(log10(All_Data$fT3)~as.factor(All_Data$any_thyroid_problem_dummy), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

t.test(log10(All_Data$Cortisol)~as.factor(All_Data$any_thyroid_problem_dummy), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

t.test(log10(All_Data$TotalT4)~as.factor(All_Data$any_thyroid_problem_dummy), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

t.test(log10(All_Data$TotalT3)~as.factor(All_Data$any_thyroid_problem_dummy), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

#EMR Cases v Controls
t.test(log10(All_Data$TSH)~as.factor(All_Data$EMR_any_thyroid_Dummy), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

#t.test(log10(All_Data$TSH[All_Data$EMR_any_thyroid_Dummy==1]) ~ log10(All_Data$TSH[All_Data$EMR_any_thyroid_Dummy==0]),  
#       alternative = "greater",  
#       conf.level =  0.95,  
#       var.equal = FALSE) #Want to see what single direction looks like. I can't actually do this because they have an unequal number of rows... okay well great, decision made!

t.test(log10(All_Data$fT4)~as.factor(All_Data$EMR_any_thyroid_Dummy), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

t.test(log10(All_Data$fT3)~as.factor(All_Data$EMR_any_thyroid_Dummy), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

t.test(log10(All_Data$Cortisol)~as.factor(All_Data$EMR_any_thyroid_Dummy), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

t.test(log10(All_Data$TotalT4)~as.factor(All_Data$EMR_any_thyroid_Dummy), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

t.test(log10(All_Data$TotalT3)~as.factor(All_Data$EMR_any_thyroid_Dummy), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

#SR Cases With v Without Meds
All_Data_Cases <- subset(All_Data, All_Data$any_thyroid_problem_dummy==1)

t.test(log10(All_Data_Cases$TSH)~as.factor(All_Data_Cases$thyroid_med), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

t.test(log10(All_Data_Cases$fT4)~as.factor(All_Data_Cases$thyroid_med), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

t.test(log10(All_Data_Cases$fT3)~as.factor(All_Data_Cases$thyroid_med), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

t.test(log10(All_Data_Cases$Cortisol)~as.factor(All_Data_Cases$thyroid_med), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

t.test(log10(All_Data_Cases$TotalT4)~as.factor(All_Data_Cases$thyroid_med), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

t.test(log10(All_Data_Cases$TotalT3)~as.factor(All_Data_Cases$thyroid_med), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

#EMR Cases With v Without Meds
All_Data_Cases2 <- subset(All_Data, All_Data$EMR_any_thyroid_Dummy==1)

t.test(log10(All_Data_Cases2$TSH)~as.factor(All_Data_Cases2$thyroid_med), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

t.test(log10(All_Data_Cases2$fT4)~as.factor(All_Data_Cases2$thyroid_med), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

t.test(log10(All_Data_Cases2$fT3)~as.factor(All_Data_Cases2$thyroid_med), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

t.test(log10(All_Data_Cases2$Cortisol)~as.factor(All_Data_Cases2$thyroid_med), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

t.test(log10(All_Data_Cases2$TotalT4)~as.factor(All_Data_Cases2$thyroid_med), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

t.test(log10(All_Data_Cases2$TotalT3)~as.factor(All_Data_Cases2$thyroid_med), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)
```

## Analyzing Correlation of Creatinine and Perchlorate
```{r correlation}
tiff("Perch_Creat_Correlation.tiff", units="in", width=9, height=4, res=300)
ggplot(All_Data, aes(x=log10(as.numeric(Result_C_mg_dL)), y=log10(as.numeric(Result_P_ng_mL))))+
  geom_point()+
  geom_smooth(method=lm, se=F)+
  xlab("\nLog10 Creatinine")+
  ylab("Log10 Perchlorate\n")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 20))
dev.off()

ggplot(All_Data, aes(x=log10(Result_C_mg_dL), y=log10(Result_P_ng_mL)))+
  geom_point(aes(color=as.factor(Site)))+
  scale_color_discrete("Site", labels=c("1"="CSF", "2"="RCBH", "3"="YRMC"))+
  geom_smooth(method=lm, se=F, aes(color=as.factor(Site)))+
  xlab("Log10 Creatinine")+
  ylab("Log10 Perchlorate")+
  ggtitle("Correlation of Perchlorate and Creatinine")+
  theme(text = element_text(size = 20))

cor.test(log10(All_Data$Result_C_mg_dL), log10(All_Data$Result_P_ng_mL))
```

### Checking for Grouping by Site
```{r corr_site}

ggplot(All_Data, aes(x=log10(Result_C_mg_dL), y=log10(Result_P_ng_mL), color=as.factor(Site)))+
  geom_point()+
  geom_smooth(method=lm, se=F)+
  scale_color_discrete("Site", labels=c("C"="CSF", "R"="RCBH", "Y"="YRMC"))+
  xlab("Log10 Creatinine")+
  ylab("Log10 Perchlorate")+
  ggtitle("Correlation of Perchlorate and Creatinine After Log Transformations by Location")

kable(All_Data %>% 
        summarise("CSF"=sum(Site==1),
                  "RCBH"=sum(Site==2),
                  "YRMC"=sum(Site==3),
                  "NA"=sum(is.na(Site))))
```

### Checking for Grouping by Sex
```{r corr_sex}
ID_Gender <- All_Data[, c("ID", "Gender")]
#All_Data$ID <- substr(as.character(All_Data$Sample_ID),7,11)

df1 <- cbind(ID_Gender, All_Data)
df1 <- as.data.frame(df1)
df1 <- subset(df1, select = -c(3, 13))


ggplot(subset(df1, !is.na(df1$Gender)), aes(x=log10(as.numeric(Result_C_mg_dL)), y=log10(as.numeric(Result_P_ng_mL)), color=as.factor(Gender)))+
  geom_point()+
  geom_smooth(method=lm, se=F)+
  scale_color_discrete("Gender", labels=c("1"="Male", "2"="Female"))+
  xlab("Log10 Creatinine")+
  ylab("Log10 Perchlorate")+
  ggtitle("Correlation of log10 Perchlorate and \nlog10 Creatinine by Sex")  +
  theme(text = element_text(size = 20))

kable(df1 %>% 
        summarise("Males"=sum(Gender==1, na.rm=T),
                  "Females"=sum(Gender==2, na.rm=T),
                  "NA"=sum(is.na(Gender))))
```

### Just exploring
```{r corr_outcomes}
ID_BMI <- All_Data[, c("ID", "bmi")]

df2 <- merge(ID_BMI, Urine_Perch_Creat, by="ID")
df2 <- as.data.frame(df2)

df2$bmi <- as.numeric(df2$bmi)
df2$Result_P_ng_mL <- as.numeric(df2$Result_P_ng_mL)
df2$Result_C_mg_dL <- as.numeric(df2$Result_C_mg_dL)
df2$Result_C_ng_mL <- df2$Result_C_mg_dL*10000

ggplot(df2, aes(y=bmi, x=log10(Result_P_ng_mL)))+
  geom_point()+
  geom_smooth(method=lm, se=F)+
  ylab("BMI")+
  xlab("Log10 Perchlorate")+
  theme(text = element_text(size = 15),
        panel.background = element_rect(fill = '#ffffff', color = 'black')) 


ggplot(df2, aes(y=log10(bmi), x=log10(Result_P_ng_mL)))+
  geom_point()+
  geom_smooth(method=lm, se=F)+
  ylab("Log10 BMI")+
  xlab("Log10 Perchlorate / Creatinine")+
  theme(text = element_text(size = 15),
        panel.background = element_rect(fill = '#ffffff', color = 'black'))


ggplot(df2, aes(y=log10(bmi), x=log10(Result_P_ng_mL)))+
  geom_point()+
  geom_smooth(method=lm, se=F)+
  ylab("BMI")+
  xlab("Log10 Perchlorate")+
  theme(text = element_text(size = 15),
        panel.background = element_rect(fill = '#ffffff', color = 'black'))

ggplot(df2, aes(x=log10(bmi), y=log10(Result_C_mg_dL)))+
  geom_point()+
  geom_smooth(method=lm, se=F)+
  xlab("BMI")+
  ylab("Log10 Creatinine")+
  theme(text = element_text(size = 15),
        panel.background = element_rect(fill = '#ffffff', color = 'black'))

ggplot(df2, aes(y=log10(bmi), x=log10(Result_P_ng_mL/Result_C_ng_mL)))+
  geom_point()+
  geom_smooth(method=lm, se=F)+
  xlab("Log10 Perchlorate/Creatinine")+
  ylab("Log10 BMI")+
  theme(text = element_text(size = 15),
        panel.background = element_rect(fill = '#ffffff', color = 'black'))

ggplot(df2, aes(y=log(bmi), x=log10(Result_P_ng_mL/Result_C_ng_mL)))+
  geom_point()+
  geom_smooth(method=lm, se=F)+
  xlab("Log10 Perchlorate/Creatinine")+
  ylab("Log10 BMI")+
  theme(text = element_text(size = 15),
        panel.background = element_rect(fill = '#ffffff', color = 'black'))
 #Likely more dependent on lean BMI

ggplot(df2, aes(y=log10(as.numeric(bmi)), x=log10(as.numeric(Result_C_mg_dL))))+ #Is BMI related to hydration?
  geom_point()+
  geom_smooth(method=lm, se=F)+
  xlab("Log10 BMI")+
  ylab("Log10 Creatinine")+
  theme(text = element_text(size = 15),
        panel.background = element_rect(fill = '#ffffff', color = 'black'))

ggplot(data=All_Data, aes(x=ID, y=log10(as.numeric(Result_P_ng_mL))))+
  geom_jitter(aes(color=as.factor(Thyroid_cancer_D)))+
  scale_color_discrete("Patient with Self-Report\nThyroid Cancer", labels=c("0"="No", "1"="Yes", "NA"="NA"))+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size=15))+
  xlab("")+
  ylab("Log10 Perchlorate")

ggplot(data=All_Data, aes(x=ID, y=log10(as.numeric(Result_P_ng_mL))/log10(as.numeric(Result_C_mg_dL))))+
  geom_jitter(aes(color=as.factor(Thyroid_cancer_D)))+
  scale_color_discrete("Patient with Self-Report\nThyroid Cancer", labels=c("0"="No", "1"="Yes", "NA"="NA"))+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size=15))+
  xlab("")+
  ylab("Log10 Perchlorate / Creatinine")

ggplot(data=All_Data, aes(x=ID, y=log10(as.numeric(Result_P_ng_mL))))+
  geom_jitter(aes(color=as.factor(emr_thyroid_cancer)))+
  scale_color_discrete("Patient with EMR\nThyroid Cancer", labels=c("0"="No", "1"="Yes", "NA"="NA"))+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size=15))+
  xlab("")+
  ylab("Log10 Perchlorate")

ggplot(data=All_Data, aes(x=ID, y=log10(as.numeric(Result_P_ng_mL))/log10(as.numeric(Result_C_mg_dL))))+
  geom_jitter(aes(color=as.factor(emr_thyroid_cancer)))+
  scale_color_discrete("Patient with EMR\nThyroid Cancer", labels=c("0"="No", "1"="Yes", "NA"="NA"))+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size=15))+
  xlab("")+
  ylab("Log10 Perchlorate / Creatinine")

ggplot(data=All_Data, aes(x=ID, y=log10(as.numeric(Result_P_ng_mL))))+
  geom_jitter(aes(color=as.factor(Goiter_D)))+
  scale_color_discrete("Patient with Self-Report\nGoiter", labels=c("0"="No", "1"="Yes", "NA"="NA"))+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size=15))+
  xlab("")+
  ylab("Log10 Perchlorate")

ggplot(data=All_Data, aes(x=ID, y=log10(as.numeric(Result_P_ng_mL))/log10(as.numeric(Result_C_mg_dL))))+
  geom_jitter(aes(color=as.factor(Goiter_D)))+
  scale_color_discrete("Patient with Self-Report\nGoiter", labels=c("0"="No", "1"="Yes", "NA"="NA"))+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size=15))+
  xlab("")+
  ylab("Log10 Perchlorate / Creatinine")

ggplot(data=All_Data, aes(x=ID, y=log10(as.numeric(Result_P_ng_mL))))+
  geom_jitter(aes(color=as.factor(emr_goiter)))+
  scale_color_discrete("Patient with EMR\nGoiter", labels=c("0"="No", "1"="Yes", "NA"="NA"))+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size=15))+
  xlab("")+
  ylab("Log10 Perchlorate")

ggplot(data=All_Data, aes(x=ID, y=log10(as.numeric(Result_P_ng_mL)/as.numeric(Result_C_mg_dL))))+
  geom_jitter(aes(color=as.factor(emr_goiter)))+
  scale_color_discrete("Patient with EMR\nGoiter", labels=c("0"="No", "1"="Yes", "NA"="NA"))+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size=15))+
  xlab("")+
  ylab("Log10 Perchlorate / Creatinine")

#ggplot(data=subset(All_Data, !is.na(All_Data$pos_recode)), aes(x=ID, y=log(as.numeric(Result_P_ng_mL))))+
#  geom_jitter(aes(color=as.factor(pos_recode), shape=as.factor(pos_recode)), size=2)+
#  scale_color_discrete("Patient with Self-Report\nPCOS", labels=c("0"="No", "1"="Yes", "NA"="NA"))+
#  scale_shape_discrete("Patient with Self-Report\nPCOS", labels=c("0"="No", "1"="Yes", "NA"="NA"))+
#  theme(axis.text.x = element_blank(),
#        axis.ticks.x = element_blank(),
#        panel.background = element_rect(fill = '#ffffff', color = 'black'),
#        text = element_text(size=15))+
#  xlab("")+
#  ylab("Ln Perchlorate")

ggplot(data=subset(All_Data, !is.na(All_Data$pos_recode)), aes(x=ID, y=log10(as.numeric(Result_P_ng_mL)/as.numeric(Result_C_mg_dL))))+
  geom_jitter(aes(color=as.factor(pos_recode), shape=as.factor(pos_recode)), size=2)+
  geom_hline(aes(yintercept=mean(log10(as.numeric(Result_P_ng_mL)/as.numeric(Result_C_mg_dL)), na.rm = T)))+
  scale_color_discrete("Patient with Self-Report\nPCOS", labels=c("0"="No", "1"="Yes", "NA"="NA"))+
  scale_shape_discrete("Patient with Self-Report\nPCOS", labels=c("0"="No", "1"="Yes", "NA"="NA"))+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size=15))+
  ylim(c(-0.15, 0.2))+
  xlab("")+
  ylab("Log10 Perchlorate/Creatinine")

#ggplot(data=subset(All_Data, !is.na(All_Data$pos)), aes(x=ID, y=log(as.numeric(Result_P_ng_mL))))+
#  geom_jitter(aes(color=as.factor(pos), shape=as.factor(pos)), size=2)+
#  scale_color_discrete("Patient with Self-Report\nPCOS", labels=c("2"="No", "1"="Yes", "3"="Don't Know", "NA"="NA"))+
#  scale_shape_discrete("Patient with Self-Report\nPCOS", labels=c("2"="No", "1"="Yes", "3"="Don't Know", "NA"="NA"))+
#  theme(axis.text.x = element_blank(),
#        axis.ticks.x = element_blank(),
#        panel.background = element_rect(fill = '#ffffff', color = 'black'),
#       text = element_text(size=15))+
#  xlab("")+
#  ylab("Ln Perchlorate")

PCOS_SR_Perch <- ggplot(data = subset(All_Data, !is.na(All_Data$pos)), aes(x = ID, y = Result_P_ng_mL/Result_C_ng_mL)) +
    geom_jitter(aes(color = as.factor(pos), shape = as.factor(pos), size = ifelse(pos %in% c(1),  3,  2))) +
    geom_hline(aes(yintercept =  0.00000256)) +
    scale_y_continuous(trans='log10',  
                       breaks = trans_breaks("log10", function(x)  10^x, n =  5),  
                       labels = trans_format("log10", math_format(10^.x))) +
    scale_color_discrete("Self-Report\nPCOS",  
                         labels = c("2" = "No", "1" = "Yes", "3" = "Don't Know", "NA" = "NA")) +
    scale_shape_discrete("Self-Report\nPCOS",  
                         labels = c("2" = "No", "1" = "Yes", "3" = "Don't Know", "NA" = "NA")) +
    scale_size_continuous(guide = "none") +
    theme(axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          panel.background = element_rect(fill = '#ffffff', color = 'black'),
          text = element_text(size =  20),
          legend.position = "bottom") +
    xlab("") +
    ylab("Log10 [Perchlorate]/[Creatinine]") +
    guides(shape = guide_legend(direction = "vertical", title.position = "top"),
           color = guide_legend(direction = "vertical", title.position = "top"))

#ggplot(data = subset(All_Data, !is.na(All_Data$pos)), aes(x = ID, y = Result_P_ng_mL)) +
#    geom_jitter(aes(color = as.factor(pos), shape = as.factor(pos), size = ifelse(pos %in% c(1), 3, 2))) +
#    geom_hline(aes(yintercept = 2.27)) +
#    scale_y_continuous(trans='log10',  
#                       breaks = trans_breaks("log10", function(x)  10^x, n =  5),  
#                       labels = trans_format("log10", math_format(10^.x))) +
#    scale_color_discrete("Self-Report\nPCOS", 
#                         labels = c("2" = "No", "1" = "Yes", "3" = "Don't Know", "NA" = "NA")) +
#    scale_shape_discrete("Self-Report\nPCOS", 
#                         labels = c("2" = "No", "1" = "Yes", "3" = "Don't Know", "NA" = "NA")) +
#    scale_size_continuous(guide = "none")+
#    theme(axis.text.x = element_blank(),
#          axis.ticks.x = element_blank(),
#          panel.background = element_rect(fill = '#ffffff', color = 'black'),
#          text = element_text(size = 20),
#          legend.position = "bottom") +
    #ylim(c(-0.15, 0.2)) +
#    xlab("") +
#    ylab("[Perchlorate]") +
#    guides(shape = guide_legend(direction = "vertical", title.position = "top"),
#           color = guide_legend(direction = "vertical", title.position = "top"))

#ggplot(data=subset(All_Data, !is.na(All_Data$emr_pos)), aes(x=ID, y=log(as.numeric(Result_P_ng_mL))))+
#  geom_jitter(aes(color=as.factor(emr_pos), shape=as.factor(emr_pos)), size=2)+
#  scale_color_discrete("Patient with EMR\nPCOS", labels=c("0"="No", "1"="Yes", "NA"="NA"))+
#  scale_shape_discrete("Patient with EMR\nPCOS", labels=c("0"="No", "1"="Yes", "NA"="NA"))+
#  theme(axis.text.x = element_blank(),
#        axis.ticks.x = element_blank(),
#        panel.background = element_rect(fill = '#ffffff', color = 'black'),
#        text = element_text(size=15))+
#  xlab("")+
# ylab("Ln Perchlorate")

PCOS_EMR_Perch <- ggplot(data = subset(All_Data, !is.na(All_Data$emr_pos)), aes(x = ID, y = Result_P_ng_mL/Result_C_ng_mL)) +
  geom_jitter(aes(color = as.factor(emr_pos), shape = as.factor(emr_pos), size = ifelse(emr_pos %in% c(1), 3, 2))) +
  geom_hline(aes(yintercept = 0.00000256)) +
  scale_y_continuous(trans='log10',  
                       breaks = trans_breaks("log10", function(x)  10^x, n =  5),  
                       labels = trans_format("log10", math_format(10^.x))) +
  scale_color_discrete("EMR Diagnosed\nPCOS", 
                       labels = c("Yes", "No", "Don't know"), 
                       breaks = c(1, 0, 3),
                       limits = c(1, 0, 3)) +
  scale_shape_discrete("EMR Diagnosed\nPCOS", 
                       labels = c("Yes", "No", "Don't know"), 
                       breaks = c(1, 0, 3),
                       limits = c(1, 0, 3)) +
  scale_size_continuous(guide = "none")+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size = 20),
        legend.position = "bottom") +
  #ylim(c(-0.15, 0.2)) +
  xlab("") +
  ylab("") +
  guides(shape = guide_legend(direction = "vertical",
                              title.position = "top"),
         color = guide_legend(direction = "vertical",
                              title.position = "top"))

#ggplot(data=subset(All_Data, All_Data$undescended!=4), aes(x=ID, y=log(as.numeric(Result_P_ng_mL))))+
#  geom_jitter(aes(color=as.factor(undescended), shape=as.factor(undescended)), size=2)+
#  scale_color_discrete("Patient with Self-Report\nUndescended Testes", labels=c("2"="No", "1"="Yes", "3"="Don't Know", "NA"="NA"))+
#  scale_shape_discrete("Patient with Self-Report\nUndescended Testes", labels=c("2"="No", "1"="Yes", "3"="Don't Know", "NA"="NA"))+
#  theme(axis.text.x = element_blank(),
#        axis.ticks.x = element_blank(),
#        panel.background = element_rect(fill = '#ffffff', color = 'black'),
#        text = element_text(size=15))+
#  xlab("")+
# ylab("Ln Perchlorate")

UT_SR_Perch <- ggplot(data=subset(All_Data, All_Data$undescended!=4), aes(x=ID, y=Result_P_ng_mL/Result_C_ng_mL))+
  geom_jitter(aes(color=as.factor(undescended), shape=as.factor(undescended), size = ifelse(undescended %in% c(1), 3, 2)))+
  geom_hline(aes(yintercept=0.00000256))+
  scale_y_continuous(trans='log10',  
                       breaks = trans_breaks("log10", function(x)  10^x, n =  5),  
                       labels = trans_format("log10", math_format(10^.x))) +
  scale_color_discrete("Self-Report\nUndescended Testes", labels=c("2"="No", "1"="Yes", "3"="Don't Know", "NA"="NA"))+
  scale_shape_discrete("Self-Report\nUndescended Testes", labels=c("2"="No", "1"="Yes", "3"="Don't Know", "NA"="NA"))+
  scale_size_continuous(guide = "none")+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size=20),
        legend.position = "bottom")+
  #ylim(c(-0.15, 0.2))+
  xlab("")+
  ylab("")+
  guides(shape = guide_legend(direction = "vertical",
                              title.position = "top"),
         color = guide_legend(direction = "vertical",
                              title.position = "top"))

#ggplot(data=subset(All_Data, All_Data$ambiguous!=4), aes(x=ID, y=log(as.numeric(Result_P_ng_mL))))+
#  geom_jitter(aes(color=as.factor(ambiguous), shape=as.factor(ambiguous)), size=2)+
#  scale_color_discrete("Patient with Self-Report\nAmbiguous Genitalia", labels=c("2"="No", "1"="Yes", "3"="Don't Know", "NA"="NA"))+
#  scale_shape_discrete("Patient with Self-Report\nAmbiguous Genitalia", labels=c("2"="No", "1"="Yes", "3"="Don't Know", "NA"="NA"))+
#  theme(axis.text.x = element_blank(),
#        axis.ticks.x = element_blank(),
#        panel.background = element_rect(fill = '#ffffff', color = 'black'),
#        text = element_text(size=15))+
#  xlab("")+
#  ylab("Ln Perchlorate")

AG_SR_Perch <- ggplot(data=subset(All_Data, All_Data$ambiguous!=4), aes(x=ID, y=Result_P_ng_mL/Result_C_ng_mL))+
  geom_jitter(aes(color=as.factor(ambiguous), shape=as.factor(ambiguous), size = ifelse(ambiguous %in% c(1), 3, 2)))+
  geom_hline(aes(yintercept=0.00000256))+
  scale_y_continuous(trans='log10',  
                       breaks = trans_breaks("log10", function(x)  10^x, n =  5),  
                       labels = trans_format("log10", math_format(10^.x))) +
  scale_color_discrete("Self-Report\nAmbiguous Genitalia", labels=c("2"="No", "1"="Yes", "3"="Don't Know", "NA"="NA"))+
  scale_shape_discrete("Self-Report\nAmbiguous Genitalia", labels=c("2"="No", "1"="Yes", "3"="Don't Know", "NA"="NA"))+
  scale_size_continuous(guide = "none")+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size=20),
        legend.position = "bottom")+
  xlab("")+
  ylab("")+
  guides(shape = guide_legend(direction = "vertical",
                              title.position = "top"),
         color = guide_legend(direction = "vertical",
                              title.position = "top"))

tiff("Perchlorate_RepDis_Graph.tiff", units="in", width=14, height=7, res=300) #Only to save in high def.
ggarrange(PCOS_SR_Perch, PCOS_EMR_Perch, UT_SR_Perch, AG_SR_Perch, nrow = 1)
dev.off()
```

### Comparing our population's perchlorate levels to national averages
```{r ave_perch_population}
max(All_Data$Result_P_ng_mL, na.rm = T)
mean(All_Data$Result_P_ng_mL, na.rm = T)


NHANES_Perch <- read_xpt("~/Desktop/Yuma Project/Yuma - R Project/PERNT_J.XPT") #URXUP8 in ng/mL
NHANES_Demo <- read_xpt("~/Desktop/Yuma Project/Yuma - R Project/DEMO_J.XPT")
NHANES_Creat <- read_xpt("~/Desktop/Yuma Project/Yuma - R Project/ALB_CR_J.XPT") #UXRUCR in mg/dL
NHANES <- merge(NHANES_Demo, NHANES_Perch, by=c("SEQN"))
NHANES <- merge(NHANES, NHANES_Creat, by=c("SEQN"))
NHANES <- subset(NHANES, NHANES$RIDAGEYR>=18)
#NHANES Gender 1 = Male, 2 = Female (Matches Yuma)
#NNAHES Ethnicity 1 = Mexican American, 2 = Other Hispanic, 3 = Non-Hispanic White, 4 = Non-Hispanic Black 5 = Other Race Including Multi-Racial, . = Missing

NHANES$Ethnicity <- ifelse(NHANES$RIDRETH1==1|
                             NHANES$RIDRETH1==2, 1,
                           ifelse(NHANES$RIDRETH1==3|
                                    NHANES$RIDRETH1==4, 2, 3)) #1 = Hispanic, 2 = Non-Hispanic, 3 = Don't know (Matches Yuma)

ggplot(data=NHANES, aes(x=RIDAGEYR, y=log10(URXUP8)))+
  geom_point()+
  geom_smooth(method="lm")

#Everything I did below, Melissa Furlong nixed. So I'm now only matching based on Ethnicity. Commenting everything out.
#hist(NHANES$RIDAGEYR)
#hist(All_Data$age)

#Matching on age
#hist(All_Data$age) #This appears to follow a normal distribution
#qqnorm(All_Data$age)
#shapiro.test(All_Data$age) #p-value = 0.0006145, so it is not statistically normal
#plot(density(All_Data$age, na.rm = T), main = "Density Plot", col = "lightgreen", xlab = "Values", ylab = "Density") #Looks bimodal, but would otherwise fit the normal dist. well
#summary(All_Data$age) #Mean and median are pretty close (48.3 and 50.1)
#I think for the sake of this study, I will use a normal dist. to sample to NHANES Data

#initial_rows <- nrow(NHANES)
#trim_percentage <- 10  #Seems to be a good number?
#rows_to_remove <- floor(trim_percentage * initial_rows / 100 / 2)
#sorted_nhanes <- NHANES[order(NHANES$RIDAGEYR), ]
#trimmed_nhanes <- sorted_nhanes[-c(1:rows_to_remove, (initial_rows - rows_to_remove + 1):initial_rows), ]
#hist(trimmed_nhanes$RIDAGEYR, main = "Trimmed Distribution") #Looks good

#Sampled_NHANES <- trimmed_nhanes

#Moving on to sex

#hist(Sampled_NHANES$RIAGENDR)
#hist(All_Data$Gender)

#sum(All_Data$Gender==1, na.rm=T)/323 #21.1% Male
#sum(All_Data$Gender==2, na.rm=T)/323 #78.9% Female

#Matching distributions
#set.seed(300)
#Sampled_NHANES <- Sampled_NHANES %>%
#   group_by(RIAGENDR) %>%   
#   nest() %>%              
#   mutate(Prob = c(0.885), samp = map2(data, Prob, sample_frac)) %>%
#  select(RIAGENDR, samp) %>% unnest()

#Now doing by Ethnicity
#sum(All_Data$Ethnicity==1, na.rm=T)/323 #88.5% Hispanic
#sum(All_Data$Ethnicity==2, na.rm=T)/323 #11.5% Non-Hispanic

#set.seed(300)
#Sampled_NHANES <- Sampled_NHANES %>%
#   group_by(Ethnicity) %>%   
#   nest() %>%              
#   mutate(Prob = c(0.885), samp = map2(data, Prob, sample_frac)) %>%
#   select(Ethnicity, samp) %>% unnest()

#hist(Sampled_NHANES$RIDAGEYR, main = "Final Distribution", col = "lightgreen")

#This only leaves me with 86 observations. I am going to try to change this based on the order that I did this.

#NHANES <- merge(NHANES_Demo, NHANES_Perch, by=c("SEQN")) #2979 observations
#Sampled_NHANES <- subset(NHANES, NHANES$RIDAGEYR>=18) #1859 observations (1120 were children)

#NHANES Gender 1 = Male, 2 = Female (Matches Yuma)
#NNAHES Ethnicity 1 = Mexican American, 2 = Other Hispanic, 3 = Non-Hispanic White, 4 = Non-Hispanic Black 5 = Other Race Including Multi-Racial, . = Missing

#Sampled_NHANES$Ethnicity <- ifelse(Sampled_NHANES$RIDRETH1==1|
#                             Sampled_NHANES$RIDRETH1==2, 1,
#                           ifelse(Sampled_NHANES$RIDRETH1==3|
#                                    Sampled_NHANES$RIDRETH1==4, 2, 3)) #1 = Hispanic, 2 = Non-Hispanic, 3 = Don't know (Matches Yuma)

#hist(Sampled_NHANES$RIDAGEYR)
#hist(All_Data$age)

#This time starting by matching on age
#hist(All_Data$age) #This appears to follow a normal distribution
#qqnorm(All_Data$age)
#shapiro.test(All_Data$age) #p-value = 0.0006145, so it is not statistically normal
#plot(density(All_Data$age, na.rm = T), main = "Density Plot", col = "lightgreen", xlab = "Values", ylab = "Density") #Looks bimodal, but would otherwise fit the normal dist. well
#summary(All_Data$age) #Mean and median are pretty close (48.3 and 50.1)
#I think for the sake of this study, I will use a normal dist. to sample to NHANES Data

#For reproducability
#set.seed(300)  

#Initial distribution
#hist(Sampled_NHANES$RIDAGEYR, main = "Initial Distribution", col = "lightblue")

#Testing for iterative removal
#shapiro_test_result <- shapiro.test(Sampled_NHANES$RIDAGEYR)

#while (shapiro_test_result$p.value < 0.006) {#Value matches shapiro-wilkes for Yuma data
#  weights <- 1 / (abs(Sampled_NHANES$RIDAGEYR - median(Sampled_NHANES$RIDAGEYR)) + 1e-10)
#  weights <- weights / sum(weights)
#  Sampled_NHANES <- Sampled_NHANES[-sample(nrow(Sampled_NHANES), 1, prob = weights), ] #Remove a random row
# shapiro_test_result <- shapiro.test(Sampled_NHANES$RIDAGEYR)  #Update Shapiro-Wilkes test result
#}  

#hist(Sampled_NHANES$RIDAGEYR, main = "Final Distribution", col = "lightgreen")

#Matching gender distributions
#hist(Sampled_NHANES$RIAGENDR)
#hist(All_Data$Gender)

#sum(All_Data$Gender==1, na.rm=T)/323 #21.1% Male
#sum(All_Data$Gender==2, na.rm=T)/323 #78.9% Female

#Sampled_NHANES <- Sampled_NHANES %>%
#   group_by(RIAGENDR) %>%   
#   nest() %>%              
#   mutate(Prob = c(.211), samp = map2(data, Prob, sample_frac)) %>%
#   select(RIAGENDR, samp) %>% unnest()

#Now doing by Ethnicity
#sum(All_Data$Ethnicity==1, na.rm=T)/323 #88.5% Hispanic
#sum(All_Data$Ethnicity==2, na.rm=T)/323 #11.5% Non-Hispanic

#Sampled_NHANES <- Sampled_NHANES %>%
#   group_by(Ethnicity) %>%   
#   nest() %>%              
#   mutate(Prob = c(0.885), samp = map2(data, Prob, sample_frac)) %>%
#   select(Ethnicity, samp) %>% unnest()

#Now I have 20 obs, so that's not good! 86 was much better.
#Using the first set of code, re-running lines, and commenting these previous changes out. 

#Overall Population without demo-matching
sum(!is.na(NHANES$URXUP8))
sum(!is.na(NHANES$URXUCR))

filtered_cases <- All_Data[All_Data$any_thyroid_Dummy_EMR_or_SR == 1, ]
filtered_controls <- All_Data[All_Data$any_thyroid_Dummy_EMR_or_SR == 0, ]

median(NHANES$URXUP8, na.rm = T)
mean(NHANES$URXUP8, na.rm = T)
exp(mean(log10(NHANES$URXUP8), na.rm = T)) #To compare to the summary table. #This is the same as the next line but I'm keeping both to make fun of myself.

geoMean(as.numeric(NHANES$URXUP8), na.rm = T)
geoSD(as.numeric(NHANES$URXUP8), na.rm = T)
range(as.numeric(NHANES$URXUP8), na.rm = T)

geoMean(as.numeric(NHANES$URXUCR), na.rm = T)
geoSD(as.numeric(NHANES$URXUCR), na.rm = T)
range(as.numeric(NHANES$URXUCR), na.rm = T)

mean(All_Data$Result_P_ng_mL, na.rm = T)
sd(All_Data$Result_P_ng_mL, na.rm = T)

geoMean(as.numeric(All_Data$Result_P_ng_mL), na.rm = T)
geoSD(as.numeric(All_Data$Result_P_ng_mL), na.rm = T)
sum(!is.na(All_Data$Result_P_ng_mL))

geoMean(as.numeric(filtered_cases$Result_P_ng_mL), na.rm = T)
geoSD(as.numeric(filtered_cases$Result_P_ng_mL), na.rm = T)
sum(!is.na(filtered_cases$Result_P_ng_mL)) #152

geoMean(as.numeric(filtered_controls$Result_P_ng_mL), na.rm = T)
geoSD(as.numeric(filtered_controls$Result_P_ng_mL), na.rm = T)
sum(!is.na(filtered_controls$Result_P_ng_mL)) #139

geoMean(as.numeric(All_Data$Result_C_mg_dL), na.rm = T)
geoSD(as.numeric(All_Data$Result_C_mg_dL), na.rm = T)

geoMean(as.numeric(filtered_cases$Result_C_mg_dL), na.rm = T)
geoSD(as.numeric(filtered_cases$Result_C_mg_dL), na.rm = T)
sum(!is.na(filtered_cases$Result_C_mg_dL)) #151

geoMean(as.numeric(filtered_controls$Result_C_mg_dL), na.rm = T)
geoSD(as.numeric(filtered_controls$Result_C_mg_dL), na.rm = T)
sum(!is.na(filtered_controls$Result_C_mg_dL)) #139

geoMean(as.numeric(NHANES$URXUP8)/(as.numeric(NHANES$URXUCR)*10000), na.rm = T)
geoSD(as.numeric(NHANES$URXUP8)/(as.numeric(NHANES$URXUCR)*10000), na.rm = T)
range(as.numeric(NHANES$URXUP8)/(as.numeric(NHANES$URXUCR)*10000), na.rm = T)

geoMean(as.numeric(All_Data$Result_P_ng_mL)/as.numeric(All_Data$Result_C_ng_mL), na.rm = T)
geoSD(as.numeric(All_Data$Result_P_ng_mL)/as.numeric(All_Data$Result_C_ng_mL), na.rm = T)

geoMean(as.numeric(filtered_cases$Result_P_ng_mL)/as.numeric(filtered_cases$Result_C_ng_mL), na.rm = T)
geoSD(as.numeric(filtered_cases$Result_P_ng_mL)/as.numeric(filtered_cases$Result_C_ng_mL), na.rm = T)
sum(!is.na(as.numeric(filtered_cases$Result_P_ng_mL)/as.numeric(filtered_cases$Result_C_ng_mL))) #151

geoMean(as.numeric(filtered_controls$Result_P_ng_mL)/as.numeric(filtered_controls$Result_C_ng_mL), na.rm = T)
geoSD(as.numeric(filtered_controls$Result_P_ng_mL)/as.numeric(filtered_controls$Result_C_ng_mL), na.rm = T)
sum(!is.na(as.numeric(filtered_controls$Result_P_ng_mL)/as.numeric(filtered_controls$Result_C_ng_mL))) #139


hline_data_A <- data.frame(
  yintercept = c(15, 3.510987, 3.095675),
  label = c("Interim Health Advisory Limit", "National Average", "Sample Average"),
  color = c("blue", "firebrick", "forestgreen")
)

tiff("Perchlorate_NHANES_Graph.tiff", units="in", width=10, height=5, res=300) #Only to save in high def.
ggplot(All_Data) +
  geom_point(aes(x = Sample_ID, y = Result_P_ng_mL, shape = as.factor(Site)), size = 2) +
  scale_shape_discrete(labels = c("1" = "CSF", "2" = "RCBH", "3" = "YRMC")) +
  geom_hline(data = hline_data_A, aes(yintercept = yintercept, linetype = label, color = label), size = 1.2) +
  xlab("") +
  ylab("Urinary Perchlorate (ng/mL)\n") +
  labs(shape = "Recruitment Site", labels = c("1" = "CSF", "2" = "RCBH", "3" = "YRMC")) +
  theme(
    axis.ticks = element_blank(),
    axis.text.x = element_blank(),
    panel.background = element_rect(fill = '#ffffff'),
    text = element_text(size = 20),
    axis.line = element_line(color="#000000")
  ) +
  scale_linetype_manual(
    name = "Perchlorate Levels",
    values = c(1, 2, 5),
    labels = c("Interim Health Advisory Limit", "National Average", "Sample Average")
  ) +
  scale_color_manual(
    name = "Perchlorate Levels",
    values = setNames(hline_data_A$color, hline_data_A$label)
  ) +
  guides(
    linetype = guide_legend(title = "Perchlorate Levels"),
    color = guide_legend(title = "Perchlorate Levels")
  )
dev.off()

hline_data2 <- data.frame(
  yintercept = c(15, 2.22, 2.40),
  label = c("EPA Health Advisory Limit", "National Median", "Sample Median"),
  color = c("blue", "firebrick", "forestgreen")
)

point_fill_data <- data.frame(
  value = c(1, 2, 3),
  label = c("CSF", "RCBH", "YRMC"),
  color = c("midnightblue", "indianred4", "grey52")
)

tiff("Perchlorate_NHANES_LogTrans_Graph.tiff", units="in", width=10, height=5, res=300) #Only to save in high def.
ggplot(All_Data) +
  geom_point(aes(x = Sample_ID, y = Result_P_ng_mL, shape = as.factor(Site), fill = as.factor(Site)), size = 2)+
  scale_y_continuous(trans='log10')+
  scale_shape_manual(name = "Recruitment Site",
                       values = c(15, 2, 21),
                       labels = c("CSF", "RCBH", "YRMC"))+
  scale_fill_manual(name = "Recruitment Site",
                      values = setNames(point_fill_data$color, point_fill_data$label))+
  geom_hline(data = hline_data2, aes(yintercept = yintercept, linetype = label, color = label), size = 1.2)+
  xlab("")+
  ylab("Urinary Perchlorate\n")+
  #labs(shape = "Recruitment Site", labels = c("1"="CSF", "2"="RCBH", "3"="YRMC"),
  #     fill = "Recruitment Site",  labels = c("1"="CSF", "2"="RCBH", "3"="YRMC"))+
  theme(axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        panel.background = element_rect(fill = '#ffffff'),
        text = element_text(size = 20),
        axis.line = element_line(color="#000000"))+
  scale_linetype_manual(name = "Perchlorate Levels",
                        values = c(1, 2, 5),
                        labels = c("EPA Health Advisory Limit", "National Median", "Sample Median"))+
  scale_color_manual(name = "Perchlorate Levels",
                     values = setNames(hline_data2$color, hline_data2$label))+
  guides(linetype = guide_legend(title = "Perchlorate Levels"),
         color = guide_legend(title = "Perchlorate Levels"),
         fill = guide_legend(title = "Recruitment Site"),
         shape = guide_legend(title = "Recruitment Site"))
dev.off()


t.test(x=log10(All_Data$Result_P_ng_mL), mu=mean(log10(as.numeric(NHANES$URXUP8)), na.rm = T))

t.test(x=log10(All_Data$Result_P_ng_mL), y=log10(NHANES$URXUP8), alternative = c("two.sided"), conf.level = 0.95)
#Neither are significant. The one-sample gives a little more power, so I will use that. Verified that the histograms of these give normal distributions prior to running to fit requirements of one sample t-test.

t.test(x=log10(All_Data$Result_P_ng_mL), mu=mean(log10(NHANES$URXUP8), na.rm = T), conf.level = 0.95)

#t.test(x=log(All_Data$Result_C_mg_dL), y=log(NHANES$URXUCR), alternative = c("two.sided"), conf.level = 0.95)
t.test(x=log10(All_Data$Result_C_mg_dL), mu=mean(log10(NHANES$URXUCR), na.rm = T), conf.level = 0.95)

#t.test(x=log(All_Data$Result_P_ng_mL)/log(All_Data$Result_C_mg_dL), y=log(NHANES$URXUP8)/log(NHANES$URXUCR), alternative = c("two.sided"), conf.level = 0.95)
t.test(x=log10(All_Data$Result_P_ng_mL/All_Data$Result_C_ng_mL), mu=mean(log10(NHANES$URXUP8/NHANES$URXUCR), na.rm = T), conf.level = 0.95)

t.test(log10(filtered_cases$Result_P_ng_mL), log10(filtered_controls$Result_P_ng_mL), conf.level = 0.95)
t.test(log10(filtered_cases$Result_C_mg_dL), log10(filtered_controls$Result_C_mg_dL), conf.level = 0.95)
t.test(log10(filtered_cases$Result_P_ng_mL/filtered_cases$Result_C_ng_mL), log10(filtered_controls$Result_P_ng_mL/filtered_controls$Result_C_ng_mL), conf.level = 0.95)


hline_data3 <- data.frame(
  yintercept = c(2.19, 2.56),
  label = c("National Average", "Sample Average"),
  color = c("firebrick", "forestgreen")
)

tiff("Perch_Creat_NHANES_LogTrans_Graph.tiff", units="in", width=10, height=7, res=300) #Only to save in high def.
ggplot(All_Data) +
  geom_point(aes(x = Sample_ID, y = Result_P_ug_mL/Result_C_g_mL, shape = as.factor(Site), fill = as.factor(Site)), size = 2)+
  scale_shape_manual(name = "Recruitment Site",
                     values = c(15, 2, 21),
                     labels = c("CSF", "RCBH", "YRMC"))+
  scale_fill_manual(name = "Recruitment Site",
                    values = setNames(point_fill_data$color, point_fill_data$label))+
  geom_hline(data = hline_data3, aes(yintercept = yintercept, linetype = label, color = label), size = 1.2)+
  scale_y_continuous(trans='log10',  
                       breaks = trans_breaks("log10", function(x)  10^x, n =  5),  
                       labels = trans_format("log10", math_format(10^.x))) +
  xlab("")+
  ylab("Log Perchlorate/Creatinine\n")+
  theme(axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        panel.background = element_rect(fill = '#ffffff'),
        text = element_text(size = 20),
        axis.line = element_line(color="#000000"))+
  scale_linetype_manual(name = "Perchlorate Levels",
                        values = c(2, 5),
                        labels = c("National Average", "Sample Average"))+
  scale_color_manual(name = "Perchlorate Levels",
                     values = setNames(hline_data3$color, hline_data3$label))+
  guides(linetype = guide_legend(title = "Perchlorate Levels"),
         color = guide_legend(title = "Perchlorate Levels"),
         fill = guide_legend(title = "Recruitment Site"),
         shape = guide_legend(title = "Recruitment Site"))
dev.off()


ggplot(All_Data) +
  geom_boxplot(aes(y = Result_P_ng_mL/Result_C_ng_mL, x=as.factor(Site)))+
  geom_jitter(aes(y = Result_P_ng_mL/Result_C_ng_mL, x=as.factor(Site)), alpha=0.2)+
  geom_hline(data = hline_data3, aes(yintercept = yintercept, linetype = label, color = label), size = 1.2)+
  scale_y_continuous(trans='log10',  
                       breaks = trans_breaks("log10", function(x)  10^x, n =  5),  
                       labels = trans_format("log10", math_format(10^.x))) +
  xlab("")+
  ylab("Log Perchlorate/Creatinine\n")+
  theme(panel.background = element_rect(fill = '#ffffff'),
        text = element_text(size = 20),
        axis.line = element_line(color="#000000"))+
  scale_linetype_manual(name = "Perchlorate Levels",
                        values = c(2, 5),
                        labels = c("National Average", "Sample Average"))+
  scale_color_manual(name = "Perchlorate Levels",
                     values = setNames(hline_data3$color, hline_data3$label))+
  guides(linetype = guide_legend(title = "Perchlorate Levels"),
         color = guide_legend(title = "Perchlorate Levels"))

tiff("Perch_Creat_NHANES_LogTrans_Graph2.tiff", units="in", width=10, height=7, res=300) #Only to save in high def.
ggplot(All_Data, aes(y = Result_P_ug_mL/Result_C_g_mL, x=as.factor(Site))) +
    geom_violin(color='#ffffff')+
  geom_boxplot()+
  geom_sina(alpha=0.2)+
  geom_hline(data = hline_data3, aes(yintercept = yintercept, linetype = label, color = label), size = 2)+
  scale_y_continuous(trans='log10',  
                       breaks = trans_breaks("log10", function(x)  10^x, n =  5),  
                       labels = trans_format("log10", math_format(10^.x))) +
  xlab("")+
  ylab("Log Perchlorate/Creatinine\n")+
  theme(panel.background = element_rect(fill = '#ffffff'),
        text = element_text(size = 20),
        axis.line = element_line(color="#000000"))+
  scale_linetype_manual(name = "",
                        values = c(2, 5),
                        labels = c("National Average", "Sample Average"))+
  scale_color_manual(name = "",
                     values = setNames(hline_data3$color, hline_data3$label))+
  guides(linetype = guide_legend(title = ""),
         color = guide_legend(title = ""))+
    scale_x_discrete(labels = c("1" = "CSF", "2" = "RCBH", "3" = "YRMC"))
dev.off()



length(NHANES$URXUP8)

All_Data %>% 
  filter(ID!="Y1008" & ID!="Y1015" & ID!="R1048" & ID!="R1083" & ID!="C1050" & ID!="C1059" & ID!="C1104" & Site=="1") %>% 
  summarise(n=length(Site),
            CSF_Number_Above=sum(Result_P_ng_mL>3.510987, na.rm=T))

All_Data %>% 
  filter(ID!="Y1008" & ID!="Y1015" & ID!="R1048" & ID!="R1083" & ID!="C1050" & ID!="C1059" & ID!="C1104" & Site=="3") %>% 
  summarise(n=length(Site),
            YRMC_Number_Above=sum(Result_P_ng_mL>3.510987, na.rm=T))

All_Data %>% 
  filter(ID!="Y1008" & ID!="Y1015" & ID!="R1048" & ID!="R1083" & ID!="C1050" & ID!="C1059" & ID!="C1104" & Site=="2") %>% 
  summarise(n=length(Site),
            RCBH_Number_Above=sum(Result_P_ng_mL>3.510987, na.rm=T))

All_Data %>% 
  filter(ID!="Y1008" & ID!="Y1015" & ID!="R1048" & ID!="R1083" & ID!="C1050" & ID!="C1059" & ID!="C1104" & Site=="1") %>% 
  summarise(n=length(Site),
            CSF_Percent_Above=sum(Result_P_ng_mL>3.095675, na.rm=T)/n)

All_Data %>% 
  filter(ID!="Y1008" & ID!="Y1015" & ID!="R1048" & ID!="R1083" & ID!="C1050" & ID!="C1059" & ID!="C1104" & Site=="3") %>% 
  summarise(n=length(Site),
            YRMC_Percent_Above=sum(Result_P_ng_mL>3.095675, na.rm=T)/n)

All_Data %>% 
  filter(ID!="Y1008" & ID!="Y1015" & ID!="R1048" & ID!="R1083" & ID!="C1050" & ID!="C1059" & ID!="C1104" & Site=="2") %>% 
  summarise(n=length(Site),
            RCBH_Percent_Above=sum(Result_P_ng_mL>3.095675, na.rm=T)/n)

#Now with population matching...
Sampled_NHANES <- subset(NHANES, NHANES$Ethnicity==1)

sum(!is.na(Sampled_NHANES$URXUP8))
sum(!is.na(Sampled_NHANES$URXUCR))
sum(!is.na(Sampled_NHANES$URXUP8) & !is.na(Sampled_NHANES$URXUCR))
Sampled_All_Data <- subset(All_Data, All_Data$Ethnicity==1)
Sampled_All_Data <- subset(Sampled_All_Data, Sampled_All_Data$ID!="Y1008" & Sampled_All_Data$ID!="Y1015" & Sampled_All_Data$ID!="R1048" & Sampled_All_Data$ID!="R1083" & Sampled_All_Data$ID!="C1050" & Sampled_All_Data$ID!="C1059" & Sampled_All_Data$ID!="C1104")

Sampled_cases <- Sampled_All_Data[Sampled_All_Data$any_thyroid_Dummy_EMR_or_SR == 1, ]
Sampled_controls <- Sampled_All_Data[Sampled_All_Data$any_thyroid_Dummy_EMR_or_SR == 0, ]

sum(!is.na(Sampled_All_Data$Result_P_ng_mL))
sum(!is.na(Sampled_All_Data$Result_C_mg_dL))
sum(!is.na(Sampled_All_Data$Result_P_ng_mL) & !is.na(Sampled_All_Data$Result_C_mg_dL))
mean(Sampled_NHANES$URXUP8, na.rm = T) #3.34
exp(mean(log10(Sampled_NHANES$URXUP8), na.rm = T)) #To compare to the summary table, 2.16

Sampled_All_Data_NonHisp <- subset(All_Data, All_Data$Ethnicity==2)

geoMean(Sampled_All_Data_NonHisp$Result_P_ng_mL)
geoSD(Sampled_All_Data_NonHisp$Result_P_ng_mL)
median(Sampled_All_Data_NonHisp$Result_P_ng_mL)
range(Sampled_All_Data_NonHisp$Result_P_ng_mL)

All_Data %>% 
  filter(Ethnicity==1) %>% 
  summarise(perch_mean=mean(Result_P_ng_mL, na.rm = T))

mean(Sampled_All_Data$Result_P_ng_mL, na.rm = T) #Same, just checking my mathz


geoMean(as.numeric(Sampled_NHANES$URXUP8), na.rm = T)
geoSD(as.numeric(Sampled_NHANES$URXUP8), na.rm = T)
range(as.numeric(Sampled_NHANES$URXUP8), na.rm = T)
median(as.numeric(Sampled_NHANES$URXUP8), na.rm = T)
range(as.numeric(Sampled_NHANES$URXUP8), na.rm = T)

geoMean(as.numeric(Sampled_NHANES$URXUCR), na.rm = T)
geoSD(as.numeric(Sampled_NHANES$URXUCR), na.rm = T)

geoMean(as.numeric(Sampled_All_Data$Result_P_ng_mL), na.rm = T)
geoSD(as.numeric(Sampled_All_Data$Result_P_ng_mL), na.rm = T)
range(as.numeric(Sampled_All_Data$Result_P_ng_mL), na.rm = T)
median(as.numeric(Sampled_All_Data$Result_P_ng_mL), na.rm = T)

geoMean(as.numeric(Sampled_cases$Result_P_ng_mL), na.rm = T)
geoSD(as.numeric(Sampled_cases$Result_P_ng_mL), na.rm = T)
sum(!is.na(Sampled_cases$Result_P_ng_mL)) #124

geoMean(as.numeric(Sampled_controls$Result_P_ng_mL), na.rm = T)
geoSD(as.numeric(Sampled_controls$Result_P_ng_mL), na.rm = T)
sum(!is.na(Sampled_controls$Result_P_ng_mL)) #129


geoMean(as.numeric(Sampled_All_Data$Result_C_mg_dL), na.rm = T)
geoSD(as.numeric(Sampled_All_Data$Result_C_mg_dL), na.rm = T)

geoMean(as.numeric(Sampled_cases$Result_C_mg_dL), na.rm = T)
geoSD(as.numeric(Sampled_cases$Result_C_mg_dL), na.rm = T)
sum(!is.na(Sampled_cases$Result_C_mg_dL)) #123

geoMean(as.numeric(Sampled_controls$Result_C_mg_dL), na.rm = T)
geoSD(as.numeric(Sampled_controls$Result_C_mg_dL), na.rm = T)
sum(!is.na(Sampled_controls$Result_C_mg_dL)) #129

geoMean(as.numeric(Sampled_NHANES$URXUP8)/(as.numeric(Sampled_NHANES$URXUCR)*10000), na.rm = T)
geoSD(as.numeric(Sampled_NHANES$URXUP8)/(as.numeric(Sampled_NHANES$URXUCR)*10000), na.rm = T)
range(as.numeric(Sampled_NHANES$URXUP8)/(as.numeric(Sampled_NHANES$URXUCR)*10000), na.rm = T)

geoMean(as.numeric(Sampled_All_Data$Result_P_ng_mL)/as.numeric(Sampled_All_Data$Result_C_ng_mL), na.rm = T)
geoSD(as.numeric(Sampled_All_Data$Result_P_ng_mL)/as.numeric(Sampled_All_Data$Result_C_ng_mL), na.rm = T)

geoMean(as.numeric(Sampled_cases$Result_P_ng_mL)/as.numeric(Sampled_cases$Result_C_ng_mL), na.rm = T)
geoSD(as.numeric(Sampled_cases$Result_P_ng_mL)/as.numeric(Sampled_cases$Result_C_ng_mL), na.rm = T)
sum(!is.na(as.numeric(Sampled_cases$Result_P_ng_mL)/as.numeric(Sampled_cases$Result_C_ng_mL))) #

geoMean(as.numeric(Sampled_controls$Result_P_ng_mL)/as.numeric(Sampled_controls$Result_C_ng_mL), na.rm = T)
geoSD(as.numeric(Sampled_controls$Result_P_ng_mL)/as.numeric(Sampled_controls$Result_C_ng_mL), na.rm = T)
sum(!is.na(as.numeric(Sampled_controls$Result_P_ng_mL)/as.numeric(Sampled_controls$Result_C_ng_mL))) #

t.test(log10(Sampled_cases$Result_P_ng_mL), log10(Sampled_controls$Result_P_ng_mL), conf.level = 0.95)
t.test(log10(Sampled_cases$Result_C_mg_dL), log10(Sampled_controls$Result_C_mg_dL), conf.level = 0.95)
t.test(log10(Sampled_cases$Result_P_ng_mL/Sampled_cases$Result_C_ng_mL), log10(Sampled_controls$Result_P_ng_mL/Sampled_controls$Result_C_ng_mL), conf.level = 0.95)


hline_data_M <- data.frame(
  yintercept = c(15, 3.336678, 3.095675),
  label = c("Interim Health Advisory Limit", "Hispanic/Latino National Average", "Hispanic/Latino Sample Average"),
  color = c("blue", "firebrick", "forestgreen")
)


tiff("Perchlorate_NHANES_Graph_MatchedDemog.tiff", units="in", width=10, height=5, res=300) #Only to save in high def.
ggplot(All_Data) +
  geom_point(aes(x = Sample_ID, y = Result_P_ng_mL, shape = as.factor(Site), fill = as.factor(Site)), size = 2) +
  scale_shape_manual(name = "Recruitment Site",
                     values = c(15, 2, 21),
                     labels = c("CSF", "RCBH", "YRMC"))+
  scale_fill_manual(name = "Recruitment Site",
                      values = setNames(point_fill_data$color, point_fill_data$label))+
  geom_hline(data = hline_data_M, aes(yintercept = yintercept, linetype = label, color = label), size = 1.2) +
  xlab("") +
  ylab("Urinary Perchlorate (ng/mL)\n") +
  labs(shape = "Recruitment Site", labels = c("1" = "CSF", "2" = "RCBH", "3" = "YRMC")) +
  theme(axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        panel.background = element_rect(fill = '#ffffff'),
        text = element_text(size = 20),
        axis.line = element_line(color="#000000")) +
  scale_linetype_manual(
    name = "Perchlorate Levels",
    values = c(1, 2, 5),
    labels = c("Interim Health Advisory Limit", "Hispanic/Latino National Average", "Hispanic/Latino Sample Average")) +
  scale_color_manual(name = "Perchlorate Levels",
                     values = setNames(hline_data_M$color, hline_data_M$label)) +
  guides(linetype = guide_legend(title = "Perchlorate Levels"),
         color = guide_legend(title = "Perchlorate Levels"),
         fill = guide_legend(title = "Recruitment Site"),
         shape = guide_legend(title = "Recruitment Site"))
dev.off()


hline_data2_M <- data.frame(
  yintercept = c(15, 2.138199, 2.322191),
  label = c("EPA Health Advisory Limit", "Hispanic/Latino National Average", "Hispanic/Latino Sample Average"),
  color = c("blue", "firebrick", "forestgreen")
)

tiff("Perchlorate_NHANES_Hisp_LogTrans_Graph.tiff", units="in", width=10, height=5, res=300) #Only to save in high def.
ggplot(All_Data) +
  geom_point(aes(x = Sample_ID, y = Result_P_ng_mL, shape = as.factor(Site), fill = as.factor(Site)), size = 2) +
  scale_shape_manual(name = "Recruitment Site",
                     values = c(15, 2, 21),
                     labels = c("CSF", "RCBH", "YRMC"))+
  scale_fill_manual(name = "Recruitment Site",
                      values = setNames(point_fill_data$color, point_fill_data$label))+
  scale_y_continuous(trans='log10')+
  geom_hline(data = hline_data2_M, aes(yintercept = yintercept, linetype = label, color = label), size = 1.2) +
  xlab("") +
  ylab("Log10 Urinary Perchlorate\n") +
  labs(shape = "Recruitment Site", labels = c("1" = "CSF", "2" = "RCBH", "3" = "YRMC")) +
  theme(axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        panel.background = element_rect(fill = '#ffffff'),
        text = element_text(size = 20),
        axis.line = element_line(color="#000000")) +
  scale_linetype_manual(
    name = "Perchlorate Levels",
    values = c(1, 2, 5),
    labels = c("EPA Health Advisory Limit", "Hispanic/Latino National Average", "Hispanic/Latino Sample Average")) +
  scale_color_manual(name = "Perchlorate Levels",
                     values = setNames(hline_data2_M$color, hline_data2_M$label)) +
  guides(linetype = guide_legend(title = "Perchlorate Levels"),
         color = guide_legend(title = "Perchlorate Levels"),
         fill = guide_legend(title = "Recruitment Site"),
         shape = guide_legend(title = "Recruitment Site"))
dev.off()



hline_data3_M <- data.frame(
  yintercept = c(2.21, 2.52),
  label = c("Hispanic/Latino National Average", "Hispanic/Latino Sample Average"),
  color = c("firebrick", "forestgreen")
)

tiff("Perch_Creat_NHANES_Hisp__LogTrans_Graph.tiff", units="in", width=10, height=7, res=300) #Only to save in high def.
ggplot(Sampled_All_Data) +
  geom_point(aes(x = Sample_ID, y = Result_P_ng_mL/Result_C_ng_mL, shape = as.factor(Site), fill = as.factor(Site)), size = 2)+
  scale_shape_manual(name = "Recruitment Site",
                       values = c(15, 2, 21),
                       labels = c("CSF", "RCBH", "YRMC"))+
  scale_fill_manual(name = "Recruitment Site",
                      values = setNames(point_fill_data$color, point_fill_data$label))+
  geom_hline(data = hline_data3_M, aes(yintercept = yintercept, linetype = label, color = label), size = 1.2)+
  scale_y_continuous(trans='log10',  
                       breaks = trans_breaks("log10", function(x)  10^x, n =  5),  
                       labels = trans_format("log10", math_format(10^.x))) +
  xlab("")+
  ylab("Log Perchlorate/Creatinine\n")+
  theme(axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        panel.background = element_rect(fill = '#ffffff'),
        text = element_text(size = 20),
        axis.line = element_line(color="#000000"))+
  scale_linetype_manual(name = "Perchlorate Levels",
                        values = c(2, 5),
                        labels = c("Hispanic/Latino National Average", "Hispanic/Latino Sample Average"))+
  scale_color_manual(name = "Perchlorate Levels",
                     values = setNames(hline_data3_M$color, hline_data3_M$label))+
  guides(linetype = guide_legend(title = "Perchlorate Levels"),
         color = guide_legend(title = "Perchlorate Levels"),
         fill = guide_legend(title = "Recruitment Site"),
         shape = guide_legend(title = "Recruitment Site"))
dev.off()

hline_data3_M <- data.frame(
  yintercept = c(2.21, 2.52),
  label = c("Hispanic/Latino National Average", "Hispanic/Latino Sample Average"),
  color = c("firebrick", "forestgreen")
)

tiff("Perch_Creat_NHANES_Hisp__LogTrans_Graph2.tiff", units="in", width=10, height=7, res=300) #Only to save in high def.
ggplot(Sampled_All_Data, aes(y = Result_P_ug_mL/Result_C_g_mL, x=as.factor(Site))) +
    geom_violin(color='#ffffff')+
  geom_boxplot()+
  geom_sina(alpha=0.2)+
  geom_hline(data = hline_data3_M, aes(yintercept = yintercept, linetype = label, color = label), size = 2)+
  scale_y_continuous(trans='log10',  
                       breaks = trans_breaks("log10", function(x)  10^x, n =  5),  
                       labels = trans_format("log10", math_format(10^.x))) +
  xlab("")+
  ylab("Log Perchlorate/Creatinine\n")+
  theme(panel.background = element_rect(fill = '#ffffff'),
        text = element_text(size = 20),
        axis.line = element_line(color="#000000"))+
  scale_linetype_manual(name = "",
                        values = c(2, 5),
                        labels = c("Hispanic/Latino National Average", "Hispanic/Latino Sample Average"))+
  scale_color_manual(name = "",
                     values = setNames(hline_data3_M$color, hline_data3_M$label))+
  guides(linetype = guide_legend(title = ""),
         color = guide_legend(title = ""))+
    scale_x_discrete(labels = c("1" = "CSF", "2" = "RCBH", "3" = "YRMC"))
dev.off()


t.test(x=log10(Sampled_All_Data$Result_P_ng_mL), y=log10(Sampled_NHANES$URXUP8), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

t.test(x=log10(Sampled_All_Data$Result_C_mg_dL), y=log10(Sampled_NHANES$URXUCR), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

t.test(x=log10(Sampled_All_Data$Result_P_ng_mL/Sampled_All_Data$Result_C_mg_dL), y=log10(Sampled_NHANES$URXUP8/Sampled_NHANES$URXUCR), alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

#Round 2 with adjustments
t.test(x=log10(Sampled_All_Data$Result_P_ng_mL), mu=mean(log10(Sampled_NHANES$URXUP8), na.rm = T), conf.level = 0.95)

#t.test(x=log(All_Data$Result_C_mg_dL), y=log(NHANES$URXUCR), alternative = c("two.sided"), conf.level = 0.95)
t.test(x=log10(Sampled_All_Data$Result_C_mg_dL), mu=mean(log10(Sampled_NHANES$URXUCR), na.rm = T), conf.level = 0.95)

#t.test(x=log(All_Data$Result_P_ng_mL)/log(All_Data$Result_C_mg_dL), y=log(NHANES$URXUP8)/log(NHANES$URXUCR), alternative = c("two.sided"), conf.level = 0.95)
t.test(x=log10(Sampled_All_Data$Result_P_ng_mL/Sampled_All_Data$Result_C_mg_dL), mu=mean(log10(Sampled_NHANES$URXUP8/Sampled_NHANES$URXUCR), na.rm = T), conf.level = 0.95)

t.test(Sampled_All_Data$Result_P_ng_mL, Sampled_All_Data_NonHisp$Result_P_ng_mL, alternative = c("two.sided"), conf.level = 0.95, var.equal=FALSE)

#Records of people above the 15 ug/L
All_Data %>% 
  filter(Result_P_ng_mL>=15)
#C1044, R1014, Y1044
```

### Perchlorate against Measured BMI
```{r perch_bmi_measured}

ggplot(All_Data, aes(x=log10(Result_P_ng_mL/Result_C_ng_mL), y=log10(bmi)))+
  geom_point()+
  geom_smooth(method=lm, se=F)+
  theme(legend.position = "none",
        panel.background = element_rect(fill="#ffffff"),
        axis.text.x=element_text(angle=60, hjust=1),
        axis.line = element_line(color="#000000"))+
  xlab("Perchlorate/Creatinine (ng/mL)")+
  ylab("Logtransformed Measured BMI (kg/m2)")

ggplot(All_Data, aes(x=log10(Result_P_ng_mL), y=log10(bmi)))+
  geom_point()+
  geom_smooth(method=lm, se=F)+
  theme(legend.position = "none",
        panel.background = element_rect(fill="#ffffff"),
        axis.text.x=element_text(angle=60, hjust=1),
        axis.line = element_line(color="#000000"))+
  xlab("Log10 Perchlorate/Creatinine")+
  ylab("Log10 BMI")

perch_bmi_creat <- lm(log10(bmi)~log10(Result_P_ng_mL)+log10(Result_C_mg_dL), All_Data)

avPlots(perch_bmi_creat)

perch_bmi_creat2 <- lm(log10(bmi)~log10(Result_P_ng_mL)+log10(Result_C_mg_dL), All_Data)

avPlots(perch_bmi_creat2)
```

```{r some_graphs}

ggplot(data=All_Data, aes(x=log10(Result_P_ng_mL), y=Gender))+
  geom_smooth(method="loess", se=F)+
  ggtitle("Perchlorate and Gender")+
  xlab("Log10 Perchlorate")+
  ylab("Gender")

ggplot(data=All_Data, aes(x=log10(Result_P_ng_mL), y=Ethnicity))+
  geom_smooth(method="loess", se=F)+
  ggtitle("Perchlorate and Ethnicity")+
  xlab("Log10 Perchlorate")+
  ylab("Ethnicity")

ggplot(data=All_Data, aes(x=log10(Result_P_ng_mL), y=Site))+
  geom_smooth(method="loess", se=F)+
  ggtitle("Perchlorate and Recruitment Site")+
  xlab("Log10 Perchlorate")+
  ylab("Site")

ggplot(data=All_Data, aes(x=log10(Result_P_ng_mL), y=Water_home))+
  geom_smooth(method="loess", se=F)+
  ggtitle("Perchlorate and Home Water Source")+
  xlab("Log10 Perchlorate")+
  ylab("Water Source")

```

```{r perch_outcomes}
ggplot(data=All_Data, aes(x=log(Result_P_ng_mL/Result_C_ng_mL), y=log(TSH)))+
  geom_point()+
  geom_smooth(method = lm)+
  ggtitle("Perchlorate and TSH")+
  xlab("Ln Perchlorate / Creatinine")+
  ylab("Ln TSH")

ggplot(data=All_Data, aes(x=log10(Result_P_ng_mL/Result_C_ng_mL), y=log10(TSH)))+
  geom_point()+
  geom_smooth(method = lm)+
  ggtitle("Perchlorate and TSH")+
  xlab("Log10 Perchlorate / Creatinine")+
  ylab("Log10 TSH")

ggplot(data=All_Data, aes(x=log(Result_P_ng_mL), y=log(TSH)))+
  geom_point()+
  geom_smooth(method = lm)+
  ggtitle("Perchlorate and TSH")+
  xlab("Ln Perchlorate")+
  ylab("Ln TSH")

ggplot(data=All_Data, aes(x=log10(Result_P_ng_mL), y=log10(TSH)))+
  geom_point()+
  geom_smooth(method = lm)+
  ggtitle("Perchlorate and TSH")+
  xlab("Log10 Perchlorate")+
  ylab("Log10 TSH")

ggplot(data=All_Data, aes(x=log10(Result_P_ng_mL/Result_C_ng_mL), y=log10(fT4)))+
  geom_point()+
  geom_smooth(method = lm)+
  ggtitle("Perchlorate and fT4")+
  xlab("Log10 Perchlorate")+
  ylab("Log10 fT4")

ggplot(data=All_Data, aes(x=log10(Result_P_ng_mL/Result_C_ng_mL), y=log10(TotalT4)))+
  geom_point()+
  geom_smooth(method = lm)+
  ggtitle("Perchlorate and Total T4")+
  xlab("Log10 Perchlorate")+
  ylab("Log10 Total T4")

ggplot(data=All_Data, aes(x=log10(Result_P_ng_mL/Result_C_ng_mL), y=log10(fT3)))+
  geom_point()+
  geom_smooth(method = lm)+
  ggtitle("Perchlorate and fT3")+
  xlab("Log10 Perchlorate")+
  ylab("Log10 fT3")

ggplot(data=All_Data, aes(x=log10(Result_P_ng_mL/Result_C_ng_mL), y=log10(TotalT3)))+
  geom_point()+
  geom_smooth(method = lm)+
  ggtitle("Perchlorate and Total T3")+
  xlab("Log10 Perchlorate")+
  ylab("Log10 Total T3")

ggplot(data=All_Data, aes(y=log10(Result_P_ng_mL/Result_C_ng_mL), x=age))+
  geom_point()+
  geom_smooth(method = lm)+
  ggtitle("Perchlorate and Age")+
  xlab("Age")+
  ylab("Log10 Perchlorate/Creatinine")

ggplot(data=All_Data, aes(y=log10(Result_P_ng_mL/Result_C_ng_mL), x=age))+
  geom_point(aes(color=as.factor(Gender)))+
  geom_smooth(method = lm, se=F, aes(color=as.factor(Gender)))+
  scale_color_discrete("Gender", labels=c("1"="Male", "2"="Female"))+
  ggtitle("Perchlorate and Age by Gender")+
  xlab("Age")+
  ylab("Log10 Perchlorate/Creatinine")

#What about age and perchlorate for health outcomes

SRThy_Age <- ggplot(subset(All_Data, !is.na(All_Data$any_thyroid_problem_dummy)), aes(x=age, y=log10(Result_P_ng_mL),color=factor(any_thyroid_problem_dummy), shape=factor(any_thyroid_problem_dummy)))+
  geom_point()+
  geom_smooth(method="lm", se=F)+ #As age increases, ClO4- decreases for cases only
  scale_color_discrete("Self-Reported \nThyroid Disorder", labels=c("1"="Case", "0"="Control"))+
  scale_shape_discrete("Self-Reported \nThyroid Disorder", labels=c("1"="Case", "0"="Control"))+
  ylab("")+
  xlab("")+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 20))

EMRThy_Age <- ggplot(subset(All_Data, !is.na(All_Data$EMR_any_thyroid_Dummy)), aes(x=age, y=log10(Result_P_ng_mL),color=factor(EMR_any_thyroid_Dummy), shape=factor(EMR_any_thyroid_Dummy)))+
  geom_point()+
  geom_smooth(method="lm", se=F)+ #As age increases, ClO4- decreases for cases only
  scale_color_discrete("EMR \nThyroid Disorder", labels=c("1"="Case", "0"="Control"))+
  scale_shape_discrete("EMR \nThyroid Disorder", labels=c("1"="Case", "0"="Control"))+
  ylab("")+
  xlab("Age (Years)")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 20))

# Combine the plots into a grid
tiff("Age_Perch_Int.tiff", units="in", width=9, height=8, res=300) #Only to save in high def.
plot_grid(SRThy_Age, EMRThy_Age, ncol = 1, align = "v",
          rel_heights = c(1, 1),
          label_size = 14) +
  draw_label("Log10 Perchlorate\n", x = 0.04, y = 0.5, angle = 90, size = 20)+
  theme(legend.justification = "left")
dev.off()

SRThy_Age2 <- ggplot(subset(All_Data, !is.na(All_Data$any_thyroid_problem_dummy)), aes(x=age, y=log10(Result_P_ng_mL/Result_C_ng_mL),color=factor(any_thyroid_problem_dummy), shape=factor(any_thyroid_problem_dummy)))+
  geom_point()+
  geom_smooth(method="lm", se=F)+ #As age increases, ClO4- decreases for cases only
  scale_color_discrete("Self-Reported \nThyroid Disorder", labels=c("1"="Case", "0"="Control"))+
  scale_shape_discrete("Self-Reported \nThyroid Disorder", labels=c("1"="Case", "0"="Control"))+
  ylab("")+
  xlab("")+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 20))

EMRThy_Age2 <- ggplot(subset(All_Data, !is.na(All_Data$EMR_any_thyroid_Dummy)), aes(x=age, y=log10(Result_P_ng_mL/Result_C_ng_mL),color=factor(EMR_any_thyroid_Dummy), shape=factor(EMR_any_thyroid_Dummy)))+
  geom_point()+
  geom_smooth(method="lm", se=F)+ #As age increases, ClO4- decreases for cases only
  scale_color_discrete("EMR \nThyroid Disorder", labels=c("1"="Case", "0"="Control"))+
  scale_shape_discrete("EMR \nThyroid Disorder", labels=c("1"="Case", "0"="Control"))+
  ylab("")+
  xlab("Age (Years)")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 20))

# Combine the plots into a grid
plot_grid(SRThy_Age2, EMRThy_Age2, ncol = 1, align = "v",
          rel_heights = c(1, 1),
          label_size = 14) +
  draw_label("Log10 Perchlorate/Creatinine\n", x = 0.04, y = 0.5, angle = 90, size = 20)+
  theme(legend.justification = "left") #Interaction disappears.


ggplot(subset(All_Data, !is.na(All_Data$Hypo_D)), aes(x=age, y=log10(Result_P_ng_mL),color=factor(Hypo_D)))+
  geom_point()+
  geom_smooth(method="lm", se=F)+ #Opposite of what I would have expected
  scale_color_discrete("Self-Reported Hypothyroidism", labels=c("1"="Case", "0"="Control"))

ggplot(subset(All_Data, !is.na(All_Data$emr_hypothyroidism)), aes(x=age, y=log10(Result_P_ng_mL),color=factor(emr_hypothyroidism)))+
  geom_point()+
  geom_smooth(method="lm", se=F)

#Quick note for easy to understand resource: https://www.statology.org/how-to-report-logistic-regression-results/ 


tiff("Perch_Age_Gender.tiff", units="in", width=9, height=6, res=300) #Only to save in high def.
ggplot(data=subset(All_Data, !is.na(All_Data$Gender)), aes(y=log10(Result_P_ng_mL/Result_C_ng_mL), x=age))+
  geom_point(aes(color=as.factor(Gender)))+
  geom_smooth(method = lm, se=F, aes(color=as.factor(Gender)))+
  scale_color_discrete("Gender", labels=c("1"="Male", "2"="Female"))+
  xlab("\nAge (years)")+
  ylab("Log10 Perchlorate / Creatinine\n")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 20))
dev.off()

tiff("Smoking_Perch_Creat.tiff", units="in", width=9, height=6, res=300) #Only to save in high def.
ggplot(data=All_Data, aes(y=Result_P_ng_mL/Result_C_ng_mL, x=as.factor(Smoking_Status)))+
  geom_boxplot(aes(fill=as.factor(Smoking_Status)))+
  geom_jitter(size=0.6)+
  scale_fill_discrete("Smoking Status", labels=c("1"="Previous", "2"="Light/Occasional", "3"="Current/Heavy", "0"="Never"))+
  xlab("")+
  ylab("Log [Perchlorate / Creatinine]\n")+
  scale_y_continuous(trans='log10',
                     labels = scientific_format())+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 20),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())
dev.off()

ggplot(data=All_Data, aes(x=log10(Result_P_ng_mL/Result_C_ng_mL), y=log10(TSH)))+
  geom_point()+
  geom_smooth(method = lm)+
  ggtitle("Perchlorate and TSH")+
  xlab("Log10 Perchlorate / Creatinine")+
  ylab("Log10 TSH")

ggplot(data=subset(All_Data, All_Data$thyroid_med==0), aes(x=log10(Result_P_ng_mL/Result_C_ng_mL), y=log10(TSH)))+
  geom_point()+
  geom_smooth(method = lm)+
  ggtitle("Perchlorate and TSH (No Thyroid Meds)")+
  xlab("Log10 Perchlorate / Creatinine")+
  ylab("Log10 TSH")

tiff("TSH_Perch_Creat.tiff", units="in", width=10, height=5, res=300) #Only to save in high def.
ggplot()+
  geom_point(data=All_Data, aes(x=log10(Result_P_ng_mL/Result_C_ng_mL), y=log10(TSH), color=as.factor(thyroid_med)))+
  geom_smooth(data=All_Data, aes(x=log10(Result_P_ng_mL/Result_C_ng_mL), y=log10(TSH), linetype="All Participants"), method=lm, se=F)+
  geom_smooth(data=subset(All_Data, thyroid_med==0), aes(x=log10(Result_P_ng_mL/Result_C_ng_mL), y=log10(TSH), linetype="Participants Without Thyroid Medication"), method=lm, se=F)+
  xlab("\nLog10 Perchlorate / Creatinine")+
  ylab("Log10 TSH\n")+
  scale_color_discrete(labels=c("Does Not Take Thyroid Medication", "Does Take Thyroid Medication"))+
  guides(linetype = guide_legend(title = ""), color = guide_legend(title = ""))+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 20))
dev.off()

tiff("TSH_Perch_Meds.tiff", units="in", width=10, height=5, res=300) #Only to save in high def.
ggplot()+
  geom_point(data = All_Data, aes(x = log10(Result_P_ng_mL), y = log10(TSH), color = as.factor(thyroid_med))) +
  geom_smooth(data = subset(All_Data, thyroid_med == 0), aes(x = log10(Result_P_ng_mL), y = log10(TSH), linetype = "Participants Without Thyroid Medication"), method = "lm", se = FALSE) +
  geom_smooth(data = All_Data, aes(x = log10(Result_P_ng_mL), y = log10(TSH), linetype = "All Participants"), method = "lm", se = FALSE) +
  xlab("\nLog [Perchlorate]") +
  ylab("Log [TSH]\n") +
  scale_color_discrete(labels = c("Does Not Take Thyroid Medication", "Does Take Thyroid Medication")) +
  scale_linetype_manual(values = c("solid", "dotted"), breaks = c("Participants Without Thyroid Medication", "All Participants")) +
  guides(linetype = guide_legend(title = ""), color = guide_legend(title = "")) +
  scale_y_continuous(trans='log10', 
                     labels = label_number(accuracy = 0.01),
                     limits = c(min((All_Data$TSH), na.rm = T), max(log10(All_Data$TSH), na.rm = T)))+
  scale_x_continuous(trans='log10', 
                     labels = label_number(accuracy = 0.01)) +
  theme(panel.background = element_rect(fill = "#ffffff"),
        axis.line = element_line(color = "#000000"),
        text = element_text(size = 20))
dev.off()

#Are these stat. diff.
Model1_Test <- lm(log10(Result_P_ng_mL)~log10(TSH), data = All_Data)
Model2_Test <- lm(log10(Result_P_ng_mL)~log10(TSH), subset(All_Data, All_Data$thyroid_med == 0))
#lrtest(Model1_Test, Model2_Test) different sample sizes
#anova(Model1_Test, Model2_Test) doesn't work either

#Need to ask Dr. Furlong how to do this.

#This is not really the same thing, but eh:
lmtest <- lm(log10(Result_P_ng_mL) ~ thyroid_med*log10(TSH), data = All_Data)

summary(lmtest)

#If these aren't different, then overall is not different.
```

```{r visuals}
#Checking for effect modification for linear models
ggplot(data=All_Data, aes(y=log10(TSH), x=age))+
  geom_point(aes(color=as.factor(Gender)))+
  geom_smooth(method = lm, se = F, aes(color=as.factor(Gender)))+
  scale_color_discrete("Gender", labels=c("1"="Male", "2"="Female"))+
  ggtitle("TSH against Age by Gender")+
  xlab("Age")+
  ylab("Log 10 TSH")

ggplot(data=All_Data, aes(y=log10(fT4), x=age))+
  geom_point(aes(color=as.factor(Gender)))+
  geom_smooth(method = lm, se = F, aes(color=as.factor(Gender)))+
  scale_color_discrete("Gender", labels=c("1"="Male", "2"="Female"))+
  ggtitle("Free T4 against Age by Gender")+
  xlab("Age")+
  ylab("Log 10 fT4")

ggplot(data=All_Data, aes(y=log10(TotalT4), x=age))+
  geom_point(aes(color=as.factor(Gender)))+
  geom_smooth(method = lm, se = F, aes(color=as.factor(Gender)))+
  scale_color_discrete("Gender", labels=c("1"="Male", "2"="Female"))+
  ggtitle("Total T4 against Age by Gender")+
  xlab("Age")+
  ylab("Log10 Total T4")

ggplot(data=All_Data, aes(y=log10(fT3), x=age))+
  geom_point(aes(color=as.factor(Gender)))+
  geom_smooth(method = lm, se = F, aes(color=as.factor(Gender)))+
  scale_color_discrete("Gender", labels=c("1"="Male", "2"="Female"))+
  ggtitle("Free T3 against Age by Gender")+
  xlab("Age")+
  ylab("Log10 fT3")

ggplot(data=All_Data, aes(y=log10(TotalT3), x=age))+
  geom_point(aes(color=as.factor(Gender)))+
  geom_smooth(method = lm, se = F, aes(color=as.factor(Gender)))+
  scale_color_discrete("Gender", labels=c("1"="Male", "2"="Female"))+
  ggtitle("Total T3 against Age by Gender")+
  xlab("Age")+
  ylab("Log10 Total T3")

ggplot(data=All_Data, aes(y=log10(bmi), x=age))+
  geom_point(aes(color=as.factor(Gender)))+
  geom_smooth(method = lm, se = F, aes(color=as.factor(Gender)))+
  scale_color_discrete("Gender", labels=c("1"="Male", "2"="Female"))+
  ggtitle("BMI against Age by Gender")+
  xlab("Age")+
  ylab("Log10 BMI")
```

```{r things_vs_perch}
#Do a jitter plot of perch and color them based on hypo yes/no

ggplot(data=subset(All_Data, !is.na(All_Data$Hypo_D)), aes(y=as.numeric(Result_P_ng_mL), x=as.factor(Hypo_D)))+
  geom_jitter(aes(color=as.factor(Hypo_D)))+
  scale_color_discrete("Hypothyroidism", labels=c("1"="Yes", "0"="No"))+
  ggtitle("Perchlorate by Hypothyroid Status")+
  xlab("")+
  ylab("Perchlorate (ng/mL)")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        axis.line = element_line(color="#000000"))

#After dividing by creatinine
ggplot(data=subset(All_Data, !is.na(All_Data$Hypo_D)), aes(y=as.numeric(Result_P_ng_mL)/as.numeric(Result_C_mg_dL), x=as.factor(Hypo_D)))+
  geom_jitter(aes(color=as.factor(Hypo_D)))+
  scale_color_discrete("Hypothyroidism", labels=c("1"="Yes", "0"="No"))+
  ggtitle("Perchlorate/Creatinine by Hypothyroid Status")+
  xlab("")+
  ylab("Perchlorate/Creatinine (ng/mL)")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        axis.line = element_line(color="#000000"))

ggplot(data=subset(All_Data, !is.na(All_Data$Hypo_D)), aes(y=log10(as.numeric(Result_P_ng_mL)/as.numeric(Result_C_mg_dL)), x=as.factor(Hypo_D)))+
  geom_jitter(aes(color=as.factor(Hypo_D)))+
  scale_color_discrete("Hypothyroidism", labels=c("1"="Yes", "0"="No"))+
  ggtitle("Log10 Perchlorate / Creatinine by Hypothyroid Status")+
  xlab("")+
  ylab("Log10 Perchlorate / Creatinine")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        axis.line = element_line(color="#000000"))

#look at perch <- creat. + water types
ggplot(data=subset(All_Data, !is.na(All_Data$Hypo_D)), aes(y=as.numeric(Result_P_ng_mL)/as.numeric(Result_C_mg_dL), x=as.factor(Water_all)))+
  geom_boxplot(outlier.shape = NA)+
  geom_jitter(aes(color=as.factor(Hypo_D)), alpha=0.5)+
  scale_color_discrete("Hypothyroidism", labels=c("1"="Yes", "0"="No"))+
  scale_x_discrete("Water Source", labels=c("1"="City", "2"="Well", "3"="Bottled", "4"="Other", "5"="Mixed"))+
  ggtitle("Perchlorate/Creatinine by Water Source and Hypothyroid Status")+
  xlab("")+
  ylab("Perchlorate/Creatinine (ng/mL)")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.ticks = element_blank(),
        axis.line = element_line(color="#000000"))


ggplot(data=subset(All_Data, !is.na(All_Data$Hypo_D)), aes(y=log10(as.numeric(Result_P_ng_mL)/as.numeric(Result_C_mg_dL)), x=as.factor(Water_all)))+
  geom_boxplot(outlier.shape = NA)+
  geom_jitter(aes(color=as.factor(Hypo_D)), alpha=0.5)+
  scale_color_discrete("Hypothyroidism", labels=c("1"="Yes", "0"="No"))+
  scale_x_discrete("Water Source", labels=c("1"="City", "2"="Well", "3"="Bottled", "4"="Other", "5"="Mixed"))+
  ggtitle("Log10 Perchlorate / Creatinine by Water Source and Hypothyroid Status")+
  xlab("")+
  ylab("Log10 Perchlorate / Creatinine")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.ticks = element_blank(),
        axis.line = element_line(color="#000000"))

#metals against perch.
Cd_Perch <- ggplot(data=All_Data, aes(y=log10(as.numeric(Result_P_ng_mL)/as.numeric(Result_C_mg_dL)), x=log10(as.numeric(Cd111))))+
  ylab("")+
  xlab("Log10 Cd")+
  geom_point()+
  geom_smooth(method=lm, se=F)

Cu_Perch <- ggplot(data=All_Data, aes(y=log10(as.numeric(Result_P_ng_mL)/as.numeric(Result_C_mg_dL)), x=log10(as.numeric(Cu65))))+
  ylab("")+
  xlab("Log10 Cu")+
  geom_point()+
  geom_smooth(method=lm, se=F)

Hg_Perch <- ggplot(data=All_Data, aes(y=log10(as.numeric(Result_P_ng_mL)/as.numeric(Result_C_mg_dL)), x=log10(as.numeric(Hg202))))+
  ylab("Log10 Perchlorate / Creatinine")+
  xlab("Log10 Hg")+
  geom_point()+
  geom_smooth(method=lm, se=F)

Mn_Perch <- ggplot(data=All_Data, aes(y=log10(as.numeric(Result_P_ng_mL)/as.numeric(Result_C_mg_dL)), x=log10(as.numeric(Mn55))))+
  ylab("")+
  xlab("Log10 Mn")+
  geom_point()+
  geom_smooth(method=lm, se=F)

Pb_Perch <- ggplot(data=All_Data, aes(y=log10(as.numeric(Result_P_ng_mL)/as.numeric(Result_C_mg_dL)), x=log10(as.numeric(Pb208))))+
  ylab("")+
  xlab("Log10 Pb")+
  geom_point()+
  geom_smooth(method=lm, se=F)

U_Perch <- ggplot(data=All_Data, aes(y=log10(as.numeric(Result_P_ng_mL)/as.numeric(Result_C_mg_dL)), x=log10(as.numeric(U238))))+
  ylab("")+
  xlab("Log10 U")+
  geom_point()+
  geom_smooth(method=lm, se=F)

grid.arrange(Cd_Perch, Cu_Perch, Hg_Perch, Mn_Perch, Pb_Perch, U_Perch)

#Perchlorate against PC1 and PC2
PC1_Perch <- ggplot(data=All_Data, aes(y=log10(as.numeric(Result_P_ng_mL)/as.numeric(Result_C_mg_dL)), x=FAC1_1))+
  ylab("")+
  xlab("PC1")+
  geom_point()

PC2_Perch <- ggplot(data=All_Data, aes(y=log10(as.numeric(Result_P_ng_mL)/as.numeric(Result_C_mg_dL)), x=FAC2_1))+
  ylab("")+
  xlab("PC2")+
  geom_point()

grid.arrange(PC1_Perch, PC2_Perch, left="Log10 Perchlorate / Creatinine")

PC1_Perch2 <- ggplot(data=All_Data, aes(y=log10(as.numeric(Result_P_ng_mL)), x=FAC1_1))+
  ylab("")+
  xlab("PC1")+
  geom_point()

PC2_Perch2 <- ggplot(data=All_Data, aes(y=log10(as.numeric(Result_P_ng_mL)), x=FAC2_1))+
  ylab("")+
  xlab("PC2")+
  geom_point()

grid.arrange(PC1_Perch2, PC2_Perch2, left="Log10 Perchlorate")

#Heavy loaders of PC1: Mn, Pb, Cu
Mn_Perch <- ggplot(data=All_Data, aes(y=log10(as.numeric(Result_P_ng_mL)/as.numeric(Result_C_mg_dL)), x=log10(Mn55)))+
  ylab("")+
  xlab("Log10[Mn]")+
  geom_point()

Pb_Perch <- ggplot(data=All_Data, aes(y=log10(as.numeric(Result_P_ng_mL)/as.numeric(Result_C_mg_dL)), x=log10(Pb208)))+
  ylab("")+
  xlab("Log10[Pb]")+
  geom_point()


Cu_Perch <- ggplot(data=All_Data, aes(y=log10(as.numeric(Result_P_ng_mL)/as.numeric(Result_C_mg_dL)), x=log10(Cu65)))+
  ylab("")+
  xlab("Log10[Cu]")+
  geom_point()

grid.arrange(Mn_Perch, Pb_Perch, Cu_Perch, left="Log10 Perchlorate / Creatinine", ncol=3)
```

```{r MANCOVA}
#MANOVA
anova1 <- aov(log10(TSH) ~ log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + Gender + age + Site + any_thyroid_problem_dummy + Water_home + tsh_med, data=All_Data)
summary(anova1)
avPlots(anova1)

anova2 <- aov(log10(fT4) ~ log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + Gender + age + Gender*age + Site + any_thyroid_problem_dummy + Water_home + free_t4_med, data=All_Data)
summary(anova2)
avPlots(anova2)

anova3 <- aov(TotalT4 ~ log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + Gender + age + Site + any_thyroid_problem_dummy + Water_home + total_t4_med, data=All_Data)
summary(anova3)
avPlots(anova3)

anova4 <- aov(log10(fT3) ~ log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + Gender + age + Gender*age + Site + any_thyroid_problem_dummy + Water_home + free_t3_med, data=All_Data)
summary(anova4)
avPlots(anova4)

anova5 <- aov(TotalT3 ~ log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + Gender + age + Gender*age + Site + any_thyroid_problem_dummy + Water_home + total_t3_med, data=All_Data)
summary(anova5)
avPlots(anova5)

anova6 <- aov(log10(bmi) ~ log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + Gender + age, data=All_Data)
summary(anova6)
avPlots(anova6)
```

```{r sensitivity_specificity}
#EMR ability to predict self-report.

contingency_table_Hypo <- table(All_Data$emr_hypothyroidism, All_Data$Hypo_D)
phi_correlation <- assocstats(contingency_table_Hypo)$phi
cat("Phi Correlation:", phi_correlation, "\n")

contingency_table_Hyper <- table(All_Data$emr_hyperthyroidism, All_Data$Hyper_D)
phi_correlation <- assocstats(contingency_table_Hyper)$phi
cat("Phi Correlation:", phi_correlation, "\n")

contingency_table_ThyCanc <- table(All_Data$emr_thyroid_cancer, All_Data$Thyroid_cancer_D)
phi_correlation <- assocstats(contingency_table_ThyCanc)$phi
cat("Phi Correlation:", phi_correlation, "\n")

contingency_table_Goiter <- table(All_Data$emr_goiter, All_Data$Goiter_D)
phi_correlation <- assocstats(contingency_table_Goiter)$phi
cat("Phi Correlation:", phi_correlation, "\n")

contingency_table_ThyProb <- table(All_Data$emr_thyroid_problem_fromothercolumns, All_Data$any_thyroid_problem_dummy)
phi_correlation <- assocstats(contingency_table_ThyProb)$phi
cat("Phi Correlation:", phi_correlation, "\n")

#Did not use the code below, instead did phi correlation
All_Data %>% 
  filter_at(vars(emr_hypothyroidism, Hypo_D), all_vars(!is.na(.))) %>% 
  summarise("EMR_Pos_SR_Pos"=sum(emr_hypothyroidism==1&Hypo_D==1),
            "EMR_Neg_SR_Neg"=sum(emr_hypothyroidism==0&Hypo_D==0),
            "EMR_Pos_SR_Neg"=sum(emr_hypothyroidism==1&Hypo_D==0),
            "EMR_Neg_SR_Pos"=sum(emr_hypothyroidism==0&Hypo_D==1),
            "SR_Pos"=sum(Hypo_D==1),
            "SR_Neg"=sum(Hypo_D==0),
            "EMR_Pos"=sum(emr_hypothyroidism==1),
            "EMR_Neg"=sum(emr_hypothyroidism==0))
cor.test(All_Data$emr_hypothyroidism, All_Data$Hypo_D, method = 'pearson')
Hypothyroid_TwoByTwo <- matrix(c(67, 24, 25, 106), ncol=2)
rownames(Hypothyroid_TwoByTwo) <- c('EMR+', 'EMR-')
colnames(Hypothyroid_TwoByTwo) <- c('SR+', 'SR-')
mcnemar.test(Hypothyroid_TwoByTwo, correct=F)
sensitivity(as.factor(All_Data$emr_hypothyroidism), as.factor(All_Data$Hypo_D))
specificity(as.factor(All_Data$emr_hypothyroidism), as.factor(All_Data$Hypo_D))
sensitivity(as.factor(All_Data$Hypo_D), as.factor(All_Data$emr_hypothyroidism))
specificity(as.factor(All_Data$Hypo_D), as.factor(All_Data$emr_hypothyroidism))

All_Data %>% 
  filter_at(vars(emr_hyperthyroidism, Hyper_D), all_vars(!is.na(.))) %>% 
  summarise("EMR_Pos_SR_Pos"=sum(emr_hyperthyroidism==1&Hyper_D==1),
            "EMR_Neg_SR_Neg"=sum(emr_hyperthyroidism==0&Hyper_D==0),
            "EMR_Pos_SR_Neg"=sum(emr_hyperthyroidism==1&Hyper_D==0),
            "EMR_Neg_SR_Pos"=sum(emr_hyperthyroidism==0&Hyper_D==1),
            "SR_Pos"=sum(Hyper_D==1),
            "SR_Neg"=sum(Hyper_D==0),
            "EMR_Pos"=sum(emr_hyperthyroidism==1),
            "EMR_Neg"=sum(emr_hyperthyroidism==0))
cor.test(All_Data$emr_hyperthyroidism, All_Data$Hyper_D, method = 'pearson')
Hyperthyroid_TwoByTwo <- matrix(c(1, 23, 3, 193), ncol=2)
rownames(Hyperthyroid_TwoByTwo) <- c('EMR+', 'EMR-')
colnames(Hyperthyroid_TwoByTwo) <- c('SR+', 'SR-')
mcnemar.test(Hyperthyroid_TwoByTwo, correct=F)
sensitivity(as.factor(All_Data$emr_hyperthyroidism), as.factor(All_Data$Hyper_D))
specificity(as.factor(All_Data$emr_hyperthyroidism), as.factor(All_Data$Hyper_D))
sensitivity(as.factor(All_Data$Hyper_D), as.factor(All_Data$emr_hyperthyroidism))
specificity(as.factor(All_Data$Hyper_D), as.factor(All_Data$emr_hyperthyroidism))

ThyCancer_TwoByTwo <- All_Data %>% 
  filter_at(vars(emr_thyroid_cancer, Thyroid_cancer_D), all_vars(!is.na(.))) %>% 
  summarise("EMR_Pos_SR_Pos"=sum(emr_thyroid_cancer==1&Thyroid_cancer_D==1),
            "EMR_Neg_SR_Neg"=sum(emr_thyroid_cancer==0&Thyroid_cancer_D==0),
            "EMR_Pos_SR_Neg"=sum(emr_thyroid_cancer==1&Thyroid_cancer_D==0),
            "EMR_Neg_SR_Pos"=sum(emr_thyroid_cancer==0&Thyroid_cancer_D==1),
            "SR_Pos"=sum(Thyroid_cancer_D==1),
            "SR_Neg"=sum(Thyroid_cancer_D==0),
            "EMR_Pos"=sum(emr_thyroid_cancer==1),
            "EMR_Neg"=sum(emr_thyroid_cancer==0))
cor.test(All_Data$emr_thyroid_cancer, All_Data$Thyroid_cancer_D, method = 'pearson')
ThyCancer_TwoByTwo <- matrix(c(3, 2, 2, 234), ncol=2)
rownames(ThyCancer_TwoByTwo) <- c('EMR+', 'EMR-')
colnames(ThyCancer_TwoByTwo) <- c('SR+', 'SR-')
fisher.test(ThyCancer_TwoByTwo) #Values <5
sensitivity(as.factor(All_Data$emr_thyroid_cancer), as.factor(All_Data$Thyroid_cancer_D))
specificity(as.factor(All_Data$emr_thyroid_cancer), as.factor(All_Data$Thyroid_cancer_D))
sensitivity(as.factor(All_Data$Thyroid_cancer_D), as.factor(All_Data$emr_thyroid_cancer))
specificity(as.factor(All_Data$Thyroid_cancer_D), as.factor(All_Data$emr_thyroid_cancer))

All_Data %>% 
  filter_at(vars(emr_goiter, Goiter_D), all_vars(!is.na(.))) %>% 
  summarise("EMR_Pos_SR_Pos"=sum(emr_goiter==1&Goiter_D==1),
            "EMR_Neg_SR_Neg"=sum(emr_goiter==0&Goiter_D==0),
            "EMR_Pos_SR_Neg"=sum(emr_goiter==1&Goiter_D==0),
            "EMR_Neg_SR_Pos"=sum(emr_goiter==0&Goiter_D==1),
            "SR_Pos"=sum(Goiter_D==1),
            "SR_Neg"=sum(Goiter_D==0),
            "EMR_Pos"=sum(emr_goiter==1),
            "EMR_Neg"=sum(emr_goiter==0))
cor.test(All_Data$emr_goiter, All_Data$Goiter_D, method = 'pearson')
Goiter_TwoByTwo <- matrix(c(2, 6, 3, 224), ncol=2)
rownames(Goiter_TwoByTwo) <- c('EMR+', 'EMR-')
colnames(Goiter_TwoByTwo) <- c('SR+', 'SR-')
fisher.test(Goiter_TwoByTwo) #Values <5
sensitivity(as.factor(All_Data$emr_goiter), as.factor(All_Data$Goiter_D))
specificity(as.factor(All_Data$emr_goiter), as.factor(All_Data$Goiter_D))
sensitivity(as.factor(All_Data$Goiter_D), as.factor(All_Data$emr_goiter))
specificity(as.factor(All_Data$Goiter_D), as.factor(All_Data$emr_goiter))

All_Data %>% 
  filter_at(vars(emr_thyroid_problem_fromothercolumns, thyroid_prob_D), all_vars(!is.na(.))) %>% 
  summarise("EMR_Pos_SR_Pos"=sum(emr_thyroid_problem_fromothercolumns==1&thyroid_prob_D==1),
            "EMR_Neg_SR_Neg"=sum(emr_thyroid_problem_fromothercolumns==0&thyroid_prob_D==0),
            "EMR_Pos_SR_Neg"=sum(emr_thyroid_problem_fromothercolumns==1&thyroid_prob_D==0),
            "EMR_Neg_SR_Pos"=sum(emr_thyroid_problem_fromothercolumns==0&thyroid_prob_D==1),
            "SR_Pos"=sum(thyroid_prob_D==1),
            "SR_Neg"=sum(thyroid_prob_D==0),
            "EMR_Pos"=sum(emr_thyroid_problem_fromothercolumns==1),
            "EMR_Neg"=sum(emr_thyroid_problem_fromothercolumns==0))
#cor.test(All_Data$emr_thyroid_problem_fromothercolumns, All_Data$thyroid_prob_D, method = 'pearson')

cor.test(All_Data$emr_thyroid_problem_fromothercolumns, All_Data$any_thyroid_problem_dummy, method = 'pearson') #These both pull data from the other columns and seem to be more accurate.

sensitivity(as.factor(All_Data$emr_thyroid_problem_fromothercolumns), as.factor(All_Data$any_thyroid_problem_dummy))
specificity(as.factor(All_Data$emr_thyroid_problem_fromothercolumns), as.factor(All_Data$any_thyroid_problem_dummy))
sensitivity(as.factor(All_Data$any_thyroid_problem_dummy), as.factor(All_Data$emr_thyroid_problem_fromothercolumns))
specificity(as.factor(All_Data$any_thyroid_problem_dummy), as.factor(All_Data$emr_thyroid_problem_fromothercolumns))



#cor.test(All_Data$emr_thyroid_problem, All_Data$thyroid_prob_D, method = 'pearson')

AnyThy_TwoByTwo <- matrix(c(126, 15, 11, 94), ncol=2)
rownames(AnyThy_TwoByTwo) <- c('EMR+', 'EMR-')
colnames(AnyThy_TwoByTwo) <- c('SR+', 'SR-')
mcnemar.test(AnyThy_TwoByTwo, correct=F)

#Hormones and Outcomes
#Hypothyroidism
#TSH
All_Data %>% 
  filter_at(vars(TSH, emr_hypothyroidism), all_vars(!is.na(.))) %>% 
  summarise("TSH_Pos_EMR_Pos"=sum(TSH>4&TSH<0.4&emr_hypothyroidism==1),
            "TSH_Neg_EMR_Neg"=sum(TSH<=4&TSH>=0.4&emr_hypothyroidism==0),
            "TSH_Pos_EMR_Neg"=sum(TSH>4&TSH<0.4&emr_hypothyroidism==0),
            "TSH_Neg_EMR_Pos"=sum(TSH<=4&TSH>=0.4&emr_hypothyroidism==1),
            "EMR_Pos"=sum(emr_hypothyroidism==1),
            "EMR_Neg"=sum(emr_hypothyroidism==0),
            "TSH_Pos"=sum(TSH>4),
            "TSH_Neg"=sum(TSH<=4))

All_Data %>% 
  filter_at(vars(TSH, emr_hypothyroidism), all_vars(!is.na(.))) %>% 
  filter(thyroid_med==0) %>% 
  summarise("TSH_Pos_EMR_Pos"=sum(TSH>4&emr_hypothyroidism==1),
            "TSH_Neg_EMR_Neg"=sum(TSH<=4&emr_hypothyroidism==0),
            "TSH_Pos_EMR_Neg"=sum(TSH>4&emr_hypothyroidism==0),
            "TSH_Neg_EMR_Pos"=sum(TSH<=4&emr_hypothyroidism==1),
            "EMR_Pos"=sum(emr_hypothyroidism==1),
            "EMR_Neg"=sum(emr_hypothyroidism==0),
            "TSH_Pos"=sum(TSH>4),
            "TSH_Neg"=sum(TSH<=4))

All_Data %>% 
  filter_at(vars(TSH, emr_hypothyroidism), all_vars(!is.na(.))) %>% 
  summarise("TSH_Pos_EMR_Pos"=sum(TSH>2.5&emr_hypothyroidism==1),
            "TSH_Neg_EMR_Neg"=sum(TSH<=2.5&emr_hypothyroidism==0),
            "TSH_Pos_EMR_Neg"=sum(TSH>2.5&emr_hypothyroidism==0),
            "TSH_Neg_EMR_Pos"=sum(TSH<=2.5&emr_hypothyroidism==1),
            "EMR_Pos"=sum(emr_hypothyroidism==1),
            "EMR_Neg"=sum(emr_hypothyroidism==0),
            "TSH_Pos"=sum(TSH>2.5),
            "TSH_Neg"=sum(TSH<=2.5))

All_Data %>% 
  filter_at(vars(TSH, emr_hypothyroidism), all_vars(!is.na(.))) %>% 
  filter(thyroid_med==0) %>% 
  summarise("TSH_Pos_EMR_Pos"=sum(TSH>2.5&emr_hypothyroidism==1),
            "TSH_Neg_EMR_Neg"=sum(TSH<=2.5&emr_hypothyroidism==0),
            "TSH_Pos_EMR_Neg"=sum(TSH>2.5&emr_hypothyroidism==0),
            "TSH_Neg_EMR_Pos"=sum(TSH<=2.5&emr_hypothyroidism==1),
            "EMR_Pos"=sum(emr_hypothyroidism==1),
            "EMR_Neg"=sum(emr_hypothyroidism==0),
            "TSH_Pos"=sum(TSH>2.5),
            "TSH_Neg"=sum(TSH<=2.5))

All_Data %>% 
  filter_at(vars(TSH, Hypo_D), all_vars(!is.na(.))) %>% 
  summarise("TSH_Pos_SR_Pos"=sum(TSH>4&Hypo_D==1),
            "TSH_Neg_SR_Neg"=sum(TSH<=4&Hypo_D==0),
            "TSH_Pos_SR_Neg"=sum(TSH>4&Hypo_D==0),
            "TSH_Neg_SR_Pos"=sum(TSH<=4&Hypo_D==1),
            "SR_Pos"=sum(Hypo_D==1),
            "SR_Neg"=sum(Hypo_D==0),
            "TSH_Pos"=sum(TSH>4),
            "TSH_Neg"=sum(TSH<=4))

All_Data %>% 
  filter_at(vars(TSH, Hypo_D), all_vars(!is.na(.))) %>% 
  summarise("TSH_Pos_SR_Pos"=sum(TSH>2.5&Hypo_D==1),
            "TSH_Neg_SR_Neg"=sum(TSH<=2.5&Hypo_D==0),
            "TSH_Pos_SR_Neg"=sum(TSH>2.5&Hypo_D==0),
            "TSH_Neg_SR_Pos"=sum(TSH<=2.5&Hypo_D==1),
            "SR_Pos"=sum(Hypo_D==1),
            "SR_Neg"=sum(Hypo_D==0),
            "TSH_Pos"=sum(TSH>2.5),
            "TSH_Neg"=sum(TSH<=2.5))

#Free T4
All_Data %>% 
  filter_at(vars(fT4, emr_hypothyroidism), all_vars(!is.na(.))) %>% 
  summarise("fT4_Pos_EMR_Pos"=sum(fT4<8&emr_hypothyroidism==1),
            "fT4_Neg_EMR_Neg"=sum(fT4>=8&emr_hypothyroidism==0),
            "fT4_Pos_EMR_Neg"=sum(fT4<8&emr_hypothyroidism==0),
            "fT4_Neg_EMR_Pos"=sum(fT4>=8&emr_hypothyroidism==1),
            "EMR_Pos"=sum(emr_hypothyroidism==1),
            "EMR_Neg"=sum(emr_hypothyroidism==0),
            "fT4_Pos"=sum(fT4<8),
            "fT4_Neg"=sum(fT4>=8))

All_Data %>% 
  filter_at(vars(fT4, emr_hypothyroidism), all_vars(!is.na(.))) %>% 
  filter(free_t4_med==0) %>% 
  summarise("fT4_Pos_EMR_Pos"=sum(fT4<8&emr_hypothyroidism==1),
            "fT4_Neg_EMR_Neg"=sum(fT4>=8&emr_hypothyroidism==0),
            "fT4_Pos_EMR_Neg"=sum(fT4<8&emr_hypothyroidism==0),
            "fT4_Neg_EMR_Pos"=sum(fT4>=8&emr_hypothyroidism==1),
            "EMR_Pos"=sum(emr_hypothyroidism==1),
            "EMR_Neg"=sum(emr_hypothyroidism==0),
            "fT4_Pos"=sum(fT4<8),
            "fT4_Neg"=sum(fT4>=8))

All_Data %>% 
  filter_at(vars(fT4, Hypo_D), all_vars(!is.na(.))) %>% 
  summarise("fT4_Pos_SR_Pos"=sum(fT4<8&Hypo_D==1),
            "fT4_Neg_SR_Neg"=sum(fT4>=8&Hypo_D==0),
            "fT4_Pos_SR_Neg"=sum(fT4<8&Hypo_D==0),
            "fT4_Neg_SR_Pos"=sum(fT4>=8&Hypo_D==1),
            "SR_Pos"=sum(Hypo_D==1),
            "SR_Neg"=sum(Hypo_D==0),
            "fT4_Pos"=sum(fT4<8),
            "fT4_Neg"=sum(fT4>=8))

#Total T4
All_Data %>% 
  filter_at(vars(TotalT4, emr_hypothyroidism), all_vars(!is.na(.))) %>% 
  summarise("TotalT4_Pos_EMR_Pos"=sum(TotalT4<0.5&emr_hypothyroidism==1),
            "TotalT4_Neg_EMR_Neg"=sum(TotalT4>=0.5&emr_hypothyroidism==0),
            "TotalT4_Pos_EMR_Neg"=sum(TotalT4<0.5&emr_hypothyroidism==0),
            "TotalT4_Neg_EMR_Pos"=sum(TotalT4>=0.5&emr_hypothyroidism==1),
            "EMR_Pos"=sum(emr_hypothyroidism==1),
            "EMR_Neg"=sum(emr_hypothyroidism==0),
            "TotalT4_Pos"=sum(TotalT4<0.5),
            "TotalT4_Neg"=sum(TotalT4>=0.5))

All_Data %>% 
  filter_at(vars(TotalT4, emr_hypothyroidism), all_vars(!is.na(.))) %>% 
  filter(total_t4_med==0) %>% 
  summarise("TotalT4_Pos_EMR_Pos"=sum(TotalT4<0.5&emr_hypothyroidism==1),
            "TotalT4_Neg_EMR_Neg"=sum(TotalT4>=0.5&emr_hypothyroidism==0),
            "TotalT4_Pos_EMR_Neg"=sum(TotalT4<0.5&emr_hypothyroidism==0),
            "TotalT4_Neg_EMR_Pos"=sum(TotalT4>=0.5&emr_hypothyroidism==1),
            "EMR_Pos"=sum(emr_hypothyroidism==1),
            "EMR_Neg"=sum(emr_hypothyroidism==0),
            "TotalT4_Pos"=sum(TotalT4<0.5),
            "TotalT4_Neg"=sum(TotalT4>=0.5))

All_Data %>% 
  filter_at(vars(TotalT4, Hypo_D), all_vars(!is.na(.))) %>% 
  summarise("TotalT4_Pos_SR_Pos"=sum(TotalT4<0.5&Hypo_D==1),
            "TotalT4_Neg_SR_Neg"=sum(TotalT4>=0.5&Hypo_D==0),
            "TotalT4_Pos_SR_Neg"=sum(TotalT4<0.5&Hypo_D==0),
            "TotalT4_Neg_SR_Pos"=sum(TotalT4>=0.5&Hypo_D==1),
            "SR_Pos"=sum(Hypo_D==1),
            "SR_Neg"=sum(Hypo_D==0),
            "TotalT4_Pos"=sum(TotalT4<0.5),
            "TotalT4_Neg"=sum(TotalT4>=0.5))

#Free T3
All_Data %>% 
  filter_at(vars(fT3, emr_hypothyroidism), all_vars(!is.na(.))) %>% 
  summarise("fT3_Pos_EMR_Pos"=sum(fT3<2.3&emr_hypothyroidism==1),
            "fT3_Neg_EMR_Neg"=sum(fT3>=2.3&emr_hypothyroidism==0),
            "fT3_Pos_EMR_Neg"=sum(fT3<2.3&emr_hypothyroidism==0),
            "fT3_Neg_EMR_Pos"=sum(fT3>=2.3&emr_hypothyroidism==1),
            "EMR_Pos"=sum(emr_hypothyroidism==1),
            "EMR_Neg"=sum(emr_hypothyroidism==0),
            "fT3_Pos"=sum(fT3<2.3),
            "fT3_Neg"=sum(fT3>=2.3))

All_Data %>% 
  filter_at(vars(fT3, emr_hypothyroidism), all_vars(!is.na(.))) %>% 
  filter(free_t3_med==0) %>% 
  summarise("fT3_Pos_EMR_Pos"=sum(fT3<2.3&emr_hypothyroidism==1),
            "fT3_Neg_EMR_Neg"=sum(fT3>=2.3&emr_hypothyroidism==0),
            "fT3_Pos_EMR_Neg"=sum(fT3<2.3&emr_hypothyroidism==0),
            "fT3_Neg_EMR_Pos"=sum(fT3>=2.3&emr_hypothyroidism==1),
            "EMR_Pos"=sum(emr_hypothyroidism==1),
            "EMR_Neg"=sum(emr_hypothyroidism==0),
            "fT3_Pos"=sum(fT3<2.3),
            "fT3_Neg"=sum(fT3>=2.3))

All_Data %>% 
  filter_at(vars(fT3, Hypo_D), all_vars(!is.na(.))) %>% 
  summarise("fT3_Pos_SR_Pos"=sum(fT3<2.3&Hypo_D==1),
            "fT3_Neg_SR_Neg"=sum(fT3>=2.3&Hypo_D==0),
            "fT3_Pos_SR_Neg"=sum(fT3<2.3&Hypo_D==0),
            "fT3_Neg_SR_Pos"=sum(fT3>=2.3&Hypo_D==1),
            "SR_Pos"=sum(Hypo_D==1),
            "SR_Neg"=sum(Hypo_D==0),
            "fT3_Pos"=sum(fT3<2.3),
            "fT3_Neg"=sum(fT3>=2.3))

#Total T3
All_Data %>% 
  filter_at(vars(TotalT3, emr_hypothyroidism), all_vars(!is.na(.))) %>% 
  summarise("TotalT3_Pos_EMR_Pos"=sum(TotalT3<8&emr_hypothyroidism==1),
            "TotalT3_Neg_EMR_Neg"=sum(TotalT3>=8&emr_hypothyroidism==0),
            "TotalT3_Pos_EMR_Neg"=sum(TotalT3<8&emr_hypothyroidism==0),
            "TotalT3_Neg_EMR_Pos"=sum(TotalT3>=8&emr_hypothyroidism==1),
            "EMR_Pos"=sum(emr_hypothyroidism==1),
            "EMR_Neg"=sum(emr_hypothyroidism==0),
            "TotalT3_Pos"=sum(TotalT3<8),
            "TotalT3_Neg"=sum(TotalT3>=8))

All_Data %>% 
  filter_at(vars(TotalT3, emr_hypothyroidism), all_vars(!is.na(.))) %>% 
  filter(free_t3_med==0) %>% 
  summarise("TotalT3_Pos_EMR_Pos"=sum(TotalT3<8&emr_hypothyroidism==1),
            "TotalT3_Neg_EMR_Neg"=sum(TotalT3>=8&emr_hypothyroidism==0),
            "TotalT3_Pos_EMR_Neg"=sum(TotalT3<8&emr_hypothyroidism==0),
            "TotalT3_Neg_EMR_Pos"=sum(TotalT3>=8&emr_hypothyroidism==1),
            "EMR_Pos"=sum(emr_hypothyroidism==1),
            "EMR_Neg"=sum(emr_hypothyroidism==0),
            "TotalT3_Pos"=sum(TotalT3<8),
            "TotalT3_Neg"=sum(TotalT3>=8))

All_Data %>% 
  filter_at(vars(TotalT3, Hypo_D), all_vars(!is.na(.))) %>% 
  summarise("TotalT3_Pos_SR_Pos"=sum(TotalT3<8&Hypo_D==1),
            "TotalT3_Neg_SR_Neg"=sum(TotalT3>=8&Hypo_D==0),
            "TotalT3_Pos_SR_Neg"=sum(TotalT3<8&Hypo_D==0),
            "TotalT3_Neg_SR_Pos"=sum(TotalT3>=8&Hypo_D==1),
            "SR_Pos"=sum(Hypo_D==1),
            "SR_Neg"=sum(Hypo_D==0),
            "TotalT3_Pos"=sum(TotalT3<8),
            "TotalT3_Neg"=sum(TotalT3>=8))

#TSH
#Hyperthyroidism
All_Data %>% 
  filter_at(vars(TSH, emr_hyperthyroidism), all_vars(!is.na(.))) %>% 
  summarise("TSH_Pos_EMR_Pos"=sum(TSH<0.4&emr_hyperthyroidism==1),
            "TSH_Neg_EMR_Neg"=sum(TSH>=0.4&emr_hyperthyroidism==0),
            "TSH_Pos_EMR_Neg"=sum(TSH<0.4&emr_hyperthyroidism==0),
            "TSH_Neg_EMR_Pos"=sum(TSH>=0.4&emr_hyperthyroidism==1),
            "EMR_Pos"=sum(emr_hyperthyroidism==1),
            "EMR_Neg"=sum(emr_hyperthyroidism==0),
            "TSH_Pos"=sum(TSH<0.4),
            "TSH_Neg"=sum(TSH>=0.4))

All_Data %>% 
  filter_at(vars(TSH, emr_hyperthyroidism), all_vars(!is.na(.))) %>% 
  filter(thyroid_med==0) %>% 
  summarise("TSH_Pos_EMR_Pos"=sum(TSH<0.4&emr_hyperthyroidism==1),
            "TSH_Neg_EMR_Neg"=sum(TSH>=0.4&emr_hyperthyroidism==0),
            "TSH_Pos_EMR_Neg"=sum(TSH<0.4&emr_hyperthyroidism==0),
            "TSH_Neg_EMR_Pos"=sum(TSH>=0.4&emr_hyperthyroidism==1),
            "EMR_Pos"=sum(emr_hyperthyroidism==1),
            "EMR_Neg"=sum(emr_hyperthyroidism==0),
            "TSH_Pos"=sum(TSH<0.4),
            "TSH_Neg"=sum(TSH>=0.4))

All_Data %>% 
  filter_at(vars(TSH, Hyper_D), all_vars(!is.na(.))) %>% 
  summarise("TSH_Pos_SR_Pos"=sum(TSH<0.4&Hyper_D==1),
            "TSH_Neg_SR_Neg"=sum(TSH>=0.4&Hyper_D==0),
            "TSH_Pos_SR_Neg"=sum(TSH<0.4&Hyper_D==0),
            "TSH_Neg_SR_Pos"=sum(TSH>=0.4&Hyper_D==1),
            "SR_Pos"=sum(Hyper_D==1),
            "SR_Neg"=sum(Hyper_D==0),
            "TSH_Pos"=sum(TSH<0.4),
            "TSH_Neg"=sum(TSH>=0.4))

#Thyroid Cancer
All_Data %>% 
  filter_at(vars(TSH, emr_thyroid_cancer), all_vars(!is.na(.))) %>% 
  summarise("TSH_Pos_EMR_Pos"=sum(TSH>4&emr_thyroid_cancer==1),
            "TSH_Neg_EMR_Neg"=sum(TSH<=4&emr_thyroid_cancer==0),
            "TSH_Pos_EMR_Neg"=sum(TSH>4&emr_thyroid_cancer==0),
            "TSH_Neg_EMR_Pos"=sum(TSH<=4&emr_thyroid_cancer==1),
            "EMR_Pos"=sum(emr_thyroid_cancer==1),
            "EMR_Neg"=sum(emr_thyroid_cancer==0),
            "TSH_Pos"=sum(TSH>4),
            "TSH_Neg"=sum(TSH<=4))

All_Data %>% 
  filter_at(vars(TSH, emr_thyroid_cancer), all_vars(!is.na(.))) %>% 
  filter(thyroid_med==0) %>% 
  summarise("TSH_Pos_EMR_Pos"=sum(TSH>4&emr_thyroid_cancer==1),
            "TSH_Neg_EMR_Neg"=sum(TSH<=4&emr_thyroid_cancer==0),
            "TSH_Pos_EMR_Neg"=sum(TSH>4&emr_thyroid_cancer==0),
            "TSH_Neg_EMR_Pos"=sum(TSH<=4&emr_thyroid_cancer==1),
            "EMR_Pos"=sum(emr_thyroid_cancer==1),
            "EMR_Neg"=sum(emr_thyroid_cancer==0),
            "TSH_Pos"=sum(TSH>4),
            "TSH_Neg"=sum(TSH<=4))

All_Data %>% 
  filter_at(vars(TSH, Thyroid_cancer_D), all_vars(!is.na(.))) %>% 
  summarise("TSH_Pos_SR_Pos"=sum(TSH>4&Thyroid_cancer_D==1),
            "TSH_Neg_SR_Neg"=sum(TSH<=4&Thyroid_cancer_D==0),
            "TSH_Pos_SR_Neg"=sum(TSH>4&Thyroid_cancer_D==0),
            "TSH_Neg_SR_Pos"=sum(TSH<=4&Thyroid_cancer_D==1),
            "SR_Pos"=sum(Thyroid_cancer_D==1),
            "SR_Neg"=sum(Thyroid_cancer_D==0),
            "TSH_Pos"=sum(TSH>4),
            "TSH_Neg"=sum(TSH<=4))

#Goiter
All_Data %>% 
  filter_at(vars(TSH, emr_goiter), all_vars(!is.na(.))) %>% 
  summarise("TSH_Pos_EMR_Pos"=sum(TSH>4&emr_goiter==1),
            "TSH_Neg_EMR_Neg"=sum(TSH<=4&emr_goiter==0),
            "TSH_Pos_EMR_Neg"=sum(TSH>4&emr_goiter==0),
            "TSH_Neg_EMR_Pos"=sum(TSH<=4&emr_goiter==1),
            "EMR_Pos"=sum(emr_goiter==1),
            "EMR_Neg"=sum(emr_goiter==0),
            "TSH_Pos"=sum(TSH>4),
            "TSH_Neg"=sum(TSH<=4))

All_Data %>% 
  filter_at(vars(TSH, emr_goiter), all_vars(!is.na(.))) %>% 
  filter(thyroid_med==0) %>% 
  summarise("TSH_Pos_EMR_Pos"=sum(TSH>4&emr_goiter==1),
            "TSH_Neg_EMR_Neg"=sum(TSH<=4&emr_goiter==0),
            "TSH_Pos_EMR_Neg"=sum(TSH>4&emr_goiter==0),
            "TSH_Neg_EMR_Pos"=sum(TSH<=4&emr_goiter==1),
            "EMR_Pos"=sum(emr_goiter==1),
            "EMR_Neg"=sum(emr_goiter==0),
            "TSH_Pos"=sum(TSH>4),
            "TSH_Neg"=sum(TSH<=4))

All_Data %>% 
  filter_at(vars(TSH, Goiter_D), all_vars(!is.na(.))) %>% 
  summarise("TSH_Pos_SR_Pos"=sum(TSH>4&Goiter_D==1),
            "TSH_Neg_SR_Neg"=sum(TSH<=4&Goiter_D==0),
            "TSH_Pos_SR_Neg"=sum(TSH>4&Goiter_D==0),
            "TSH_Neg_SR_Pos"=sum(TSH<=4&Goiter_D==1),
            "SR_Pos"=sum(Goiter_D==1),
            "SR_Neg"=sum(Goiter_D==0),
            "TSH_Pos"=sum(TSH>4),
            "TSH_Neg"=sum(TSH<=4))

TSH1 <- ggplot(data=subset(All_Data, !is.na(All_Data$any_thyroid_problem_dummy)), aes(y=TSH))+
  geom_boxplot(aes(fill=as.factor(any_thyroid_problem_dummy)))+
  scale_fill_manual(name = "",
                    labels = c("0" = "Self-Report Control", "1" = "Self-Report Case"),
                    values = c("0" = "blue", "1" = "forestgreen")) +
  xlab("")+
  scale_y_continuous(trans='log10', breaks = trans_breaks("log10", function(x) 10^x, n = 5), labels = label_number(accuracy = 0.01))+
  ylab("Log10 TSH\n")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        axis.line = element_line(color="#000000"),
        text = element_text(size=20))

TSH2 <- ggplot(data=subset(All_Data, !is.na(All_Data$emr_thyroid_problem_fromothercolumns)), aes(y=log10(TSH)))+
  geom_boxplot(aes(fill=as.factor(emr_thyroid_problem_fromothercolumns)))+
  scale_fill_manual("", 
                    labels=c("0"="EMR Control        ", "1"="EMR Case"),
                    values = c("0" = "violet", "1" = "darkred"))+
  xlab("")+
  ylab("")+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        axis.line = element_line(color="#000000"),
        text = element_text(size=20))

tiff("TSH_Case_Control.tiff", units="in", width=12, height=5, res=300) #Only to save in high def.
ggarrange(TSH1, TSH2, nrow = 1, legend = "bottom")
dev.off()

TSH3 <- ggplot(data=subset(All_Data, !is.na(All_Data$any_thyroid_problem_dummy) & All_Data$thyroid_med==0)) +
  geom_density(aes(x=TSH, color=factor(any_thyroid_problem_dummy)), size = 1) +
  scale_color_manual(name = "",
                     labels = c("0" = "", "1" = ""),
                     values = c("0" = "blue", "1" = "forestgreen")) +
  scale_x_continuous(trans='log10', breaks = trans_breaks("log10", function(x) 10^x, n = 5), labels = label_number(accuracy = 0.01))+
  xlab("\n[TSH]") +
  ylab("Frequency\n") +
  theme(panel.background = element_rect(fill='transparent'),
        plot.background = element_rect(fill='transparent', color=NA),
        axis.ticks = element_blank(),
        axis.text.y = element_blank(),
        axis.line = element_line(color="#000000"),
        panel.grid.major = element_line(color = "transparent"),
        panel.grid.minor = element_line(color = "transparent"),
        text = element_text(size=20))

TSH4 <- ggplot(data=subset(All_Data, !is.na(All_Data$EMR_any_thyroid_Dummy) & All_Data$thyroid_med==0)) +
  geom_density(aes(x=TSH, color=factor(EMR_any_thyroid_Dummy)), size = 1) +
  scale_color_manual(name = "",
                     labels = c("0" = "", "1" = ""),
                     values = c("0" = "violet", "1" = "darkred")) +
  xlab("\nTSH") +
  scale_x_continuous(trans='log10', breaks = trans_breaks("log10", function(x) 10^x, n = 5), labels = label_number(accuracy = 0.01))+
  ylab("Frequency\n") +
  theme(panel.background = element_rect(fill='transparent'),
        plot.background = element_rect(fill='transparent', color=NA),
        axis.ticks = element_blank(),
        axis.text.y = element_blank(),
        axis.line = element_line(color="#000000"),
        panel.grid.major = element_line(color = "transparent"),
        panel.grid.minor = element_line(color = "transparent"),
        text = element_text(size=20))

#Saving the graphs as TIFF files
ggsave("TSH3.tiff", plot = TSH3, width=7, height=4, units = "in", dpi = 300)
ggsave("TSH4.tiff", plot = TSH4, width=7, height=4, units = "in", dpi = 300)

group1 <- log10(All_Data$TSH[All_Data$any_thyroid_problem_dummy == 0 & !is.na(All_Data$TSH)])
group2 <- log10(All_Data$TSH[All_Data$any_thyroid_problem_dummy == 1 & !is.na(All_Data$TSH)])

t.test(group1, group2, alternative = "two.sided", conf.level = 0.95, var.equal=FALSE)

group3 <- log10(All_Data$TSH[All_Data$emr_thyroid_problem_fromothercolumns == 0 & !is.na(All_Data$TSH)])
group4 <- log10(All_Data$TSH[All_Data$emr_thyroid_problem_fromothercolumns == 1 & !is.na(All_Data$TSH)])

t.test(group3, group4, alternative = "two.sided", conf.level = 0.95, var.equal=FALSE)

#All_Data$SR_EMR_AnyThy <- ifelse(All_Data$Hypo_D==1|
#                                   All_Data$Hyper_D==1|
#                                   All_Data$Thyroid_cancer_D==1|
#                                   All_Data$Goiter_D==1|
#                                   All_Data$any_thyroid_problem_dummy==1|
#                                   All_Data$emr_hypothyroidism==1|
#                                   All_Data$emr_hyperthyroidism==1|
#                                   All_Data$emr_thyroid_cancer==1|
#                                   All_Data$emr_goiter==1|
#                                   All_Data$emr_thyroid_problem==1, 1, 0)
group5 <- log10(All_Data$TSH[All_Data$any_thyroid_Dummy_EMR_or_SR == 0 & !is.na(All_Data$TSH)])
group6 <- log10(All_Data$TSH[All_Data$any_thyroid_Dummy_EMR_or_SR == 1 & !is.na(All_Data$TSH)])

t.test(group5, group6, alternative = "two.sided", conf.level = 0.95, var.equal=FALSE)
```

```{r extra_graphs}
#ggplot(data=All_Data, aes(x=log(Result_P_ng_mL/Result_C_ng_mL), y=log(TSH)))+
#  geom_point(aes(color=as.factor(Hypo_D)))

#ggplot(data=All_Data, aes(x=log(Result_P_ng_mL/Result_C_ng_mL), y=log(TSH)))+
#  geom_point(aes(color=as.factor(emr_hypothyroidism)))

#ggplot(data=All_Data, aes(x=log(Result_P_ng_mL/Result_C_ng_mL), y=log(TSH)))+
#  geom_point()+
#  geom_hline(aes(yintercept=log(0.4), color="Hyperthyroid"))+
#  geom_hline(aes(yintercept=log(2.5), color="Subclinical Hypothyroid"))+
#  geom_hline(aes(yintercept=log(4), color="Hypothyroid"))+
#  scale_color_manual(name = "TSH Thresholds", 
#                     values = c("Hyperthyroid" = "blue", "Subclinical Hypothyroid" = "orange", "Hypothyroid" = "red"))+
#  xlab("Ln Perchlorate / Ln Creatinine")+
#  ylab("Ln TSH")

All_Data$self_report_thyroid_hypoandhyper <- ifelse(All_Data$Hypo_D==1, "Hypothyroid",
                                                    ifelse(All_Data$Hyper_D==1, "Hyperthyroid", "Neither"))

All_Data$emr_thyroid_hypoandhyper <- ifelse(All_Data$emr_hypothyroidism==1, "Hypothyroid",
                                            ifelse(All_Data$emr_hyperthyroidism==1, "Hyperthyroid", "Neither"))

ggplot(data=All_Data, aes(x=log10(Result_P_ng_mL), y=log10(TSH)))+
  geom_point(aes(shape=as.factor(self_report_thyroid_hypoandhyper)))+
  geom_hline(aes(yintercept=log10(0.4), color="Hyperthyroid"))+
  geom_hline(aes(yintercept=log10(2.5), color="Subclinical Hypothyroid"))+
  geom_hline(aes(yintercept=log10(4), color="Hypothyroid"))+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"))+
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = -Inf, ymax = log10(0.4), alpha = 0.2, fill = "blue") +
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = log10(0.4), ymax = log10(2.5), alpha = 0.2, fill = "#ffffff") +
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = log10(2.5), ymax = log10(4), alpha = 0.2, fill = "orange") +
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = log10(4), ymax = Inf, alpha = 0.2, fill = "red") +
  scale_shape_manual(name = "Self-Report Thyroid Disorder",
                     values = c("Hyperthyroid" = 1, "Hypothyroid" = 2, "Neither" = 3))+
  scale_color_manual(name = "TSH Thresholds", 
                     values = c("Hyperthyroid" = "blue", "Subclinical Hypothyroid" = "orange", "Hypothyroid" = "red"))+
  xlab("Log10 Perchlorate")+
  ylab("Log10 TSH")

ggplot(data=All_Data, aes(x=log10(Result_P_ng_mL/Result_C_ng_mL), y=log10(TSH)))+
  geom_point(aes(shape=as.factor(self_report_thyroid_hypoandhyper)))+
  geom_hline(aes(yintercept=log10(0.4), color="Hyperthyroid"))+
  geom_hline(aes(yintercept=log10(2.5), color="Subclinical Hypothyroid"))+
  geom_hline(aes(yintercept=log10(4), color="Hypothyroid"))+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"))+
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = -Inf, ymax = log10(0.4), alpha = 0.2, fill = "blue") +
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = log10(0.4), ymax = log10(2.5), alpha = 0.2, fill = "#ffffff") +
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = log10(2.5), ymax = log10(4), alpha = 0.2, fill = "orange") +
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = log10(4), ymax = Inf, alpha = 0.2, fill = "red") +
  scale_shape_manual(name = "Self-Report Thyroid Disorder",
                     values = c("Hyperthyroid" = 1, "Hypothyroid" = 2, "Neither" = 3))+
  scale_color_manual(name = "TSH Thresholds", 
                     values = c("Hyperthyroid" = "blue", "Subclinical Hypothyroid" = "orange", "Hypothyroid" = "red"))+
  xlab("Log10 Perchlorate / Creatinine")+
  ylab("Log10 TSH")

ggplot(data=All_Data, aes(x=log10(Result_P_ng_mL), y=log10(TSH)))+
  geom_point(aes(shape=as.factor(emr_thyroid_hypoandhyper)))+
  geom_hline(aes(yintercept=log10(0.4), color="Hyperthyroid"))+
  geom_hline(aes(yintercept=log10(2.5), color="Subclinical Hypothyroid"))+
  geom_hline(aes(yintercept=log10(4), color="Hypothyroid"))+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"))+
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = -Inf, ymax = log10(0.4), alpha = 0.2, fill = "blue") +
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = log10(0.4), ymax = log10(2.5), alpha = 0.2, fill = "#ffffff") +
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = log10(2.5), ymax = log10(4), alpha = 0.2, fill = "orange") +
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = log10(4), ymax = Inf, alpha = 0.2, fill = "red") +
  scale_shape_manual(name = "EMR Thyroid Disorder",
                     values = c("Hyperthyroid" = 1, "Hypothyroid" = 2, "Neither" = 3))+
  scale_color_manual(name = "TSH Thresholds", 
                     values = c("Hyperthyroid" = "blue", "Subclinical Hypothyroid" = "orange", "Hypothyroid" = "red"))+
  xlab("Log10 Perchlorate")+
  ylab("Log10 TSH")

ggplot(data=All_Data, aes(x=log10(Result_P_ng_mL/Result_C_ng_mL), y=log10(TSH)))+
  geom_point(aes(shape=as.factor(emr_thyroid_hypoandhyper)))+
  geom_hline(aes(yintercept=log10(0.4), color="Hyperthyroid"))+
  geom_hline(aes(yintercept=log10(2.5), color="Subclinical Hypothyroid"))+
  geom_hline(aes(yintercept=log10(4), color="Hypothyroid"))+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"))+
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = -Inf, ymax = log10(0.4), alpha = 0.2, fill = "blue") +
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = log10(0.4), ymax = log10(2.5), alpha = 0.2, fill = "#ffffff") +
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = log10(2.5), ymax = log10(4), alpha = 0.2, fill = "orange") +
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = log10(4), ymax = Inf, alpha = 0.2, fill = "red") +
  scale_shape_manual(name = "EMR Thyroid Disorder",
                     values = c("Hyperthyroid" = 1, "Hypothyroid" = 2, "Neither" = 3))+
  scale_color_manual(name = "TSH Thresholds", 
                     values = c("Hyperthyroid" = "blue", "Subclinical Hypothyroid" = "orange", "Hypothyroid" = "red"))+
  xlab("Log10 Perchlorate / Creatinine")+
  ylab("Log10 TSH")

#Taking out folks who are on thyroid meds
ggplot(data=subset(All_Data, All_Data$thyroid_med==0), aes(x=log10(Result_P_ng_mL), y=log10(TSH)))+
  geom_point(aes(shape=as.factor(self_report_thyroid_hypoandhyper)))+
  geom_hline(aes(yintercept=log10(0.4), color="Hyperthyroid"))+
  geom_hline(aes(yintercept=log10(2.5), color="Subclinical Hypothyroid"))+
  geom_hline(aes(yintercept=log10(4), color="Hypothyroid"))+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"))+
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = -Inf, ymax = log10(0.4), alpha = 0.2, fill = "blue") +
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = log10(0.4), ymax = log10(2.5), alpha = 0.2, fill = "#ffffff") +
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = log10(2.5), ymax = log10(4), alpha = 0.2, fill = "orange") +
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = log10(4), ymax = Inf, alpha = 0.2, fill = "red") +
  scale_shape_manual(name = "Self-Report Thyroid Disorder",
                     values = c("Hyperthyroid" = 1, "Hypothyroid" = 2, "Neither" = 3))+
  scale_color_manual(name = "TSH Thresholds", 
                     values = c("Hyperthyroid" = "blue", "Subclinical Hypothyroid" = "orange", "Hypothyroid" = "red"))+
  xlab("Log10 Perchlorate")+
  ylab("Log10 TSH")

tiff("TSH_Perch_Creat_SR.tiff", units="in", width=9, height=5, res=300) #Only to save in high def.
TSH_Perch_Creat_SR <- ggplot(data=subset(All_Data, All_Data$thyroid_med==0), aes(x=Result_P_ug_mL/Result_C_g_mL, y=TSH))+
  geom_point(aes(shape=as.factor(self_report_thyroid_hypoandhyper)), size=3, fill="black")+
  geom_hline(aes(yintercept=0.4, color="Hyperthyroid"))+
  geom_hline(aes(yintercept=2.5, color="Subclinical Hypothyroid"))+
  geom_hline(aes(yintercept=4, color="Hypothyroid"))+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size=20),
        axis.text.x = element_blank())+
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = -Inf, ymax = 0.4, alpha = 0.2, fill = "blue") +
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = 0.4, ymax = 2.5, alpha = 0.2, fill = "#ffffff") +
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = 2.5, ymax = 4, alpha = 0.2, fill = "orange") +
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = 4, ymax = Inf, alpha = 0.2, fill = "red") +
  scale_shape_manual(name = "Self-Report \nThyroid Disorder",
                     values = c("Hyperthyroid" = 19, "Hypothyroid" = 23, "Neither" = 4))+
  scale_color_manual(name = "TSH Thresholds", 
                     values = c("Hyperthyroid" = "blue", "Subclinical Hypothyroid" = "orange", "Hypothyroid" = "red"))+
  scale_x_continuous(trans='log10',  
                       breaks = trans_breaks("log10", function(x)  10^x, n =  5),  
                       labels = trans_format("log10", math_format(10^.x))) +
  scale_y_continuous(trans='log10', breaks = trans_breaks("log10", function(x) 10^x, n = 5), labels = label_number(accuracy = 0.01))+
  xlab("")+
  ylab("TSH (IU/mL)\n")
dev.off()

ggplot(data=subset(All_Data, All_Data$thyroid_med==0), aes(x=log10(Result_P_ng_mL), y=log10(TSH)))+
  geom_point(aes(shape=as.factor(emr_thyroid_hypoandhyper)))+
  geom_hline(aes(yintercept=log10(0.4), color="Hyperthyroid"))+
  geom_hline(aes(yintercept=log10(2.5), color="Subclinical Hypothyroid"))+
  geom_hline(aes(yintercept=log10(4), color="Hypothyroid"))+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"))+
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = -Inf, ymax = log10(0.4), alpha = 0.2, fill = "blue") +
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = log10(0.4), ymax = log10(2.5), alpha = 0.2, fill = "#ffffff") +
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = log10(2.5), ymax = log10(4), alpha = 0.2, fill = "orange") +
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = log10(4), ymax = Inf, alpha = 0.2, fill = "red") +
  scale_shape_manual(name = "EMR Thyroid Disorder",
                     values = c("Hyperthyroid" = 1, "Hypothyroid" = 2, "Neither" = 7))+
  scale_color_manual(name = "TSH Thresholds", 
                     values = c("Hyperthyroid" = "blue", "Subclinical Hypothyroid" = "orange", "Hypothyroid" = "red"))+
  xlab("Log10 Perchlorate")+
  ylab("Log10 TSH")

tiff("TSH_Perch_Creat_EMR.tiff", units="in", width=8, height=5, res=300) #Only to save in high def.
TSH_Perch_Creat_EMR <- ggplot(data=subset(All_Data, All_Data$thyroid_med==0), aes(x=Result_P_ug_mL/Result_C_g_mL, y=TSH))+
  geom_point(aes(shape=as.factor(emr_thyroid_hypoandhyper)), size=3)+
  geom_hline(aes(yintercept=0.4, color="Hyperthyroid"))+
  geom_hline(aes(yintercept=2.5, color="Subclinical Hypothyroid"))+
  geom_hline(aes(yintercept=4, color="Hypothyroid"))+
  scale_x_continuous(trans='log10',  
                       breaks = trans_breaks("log10", function(x)  10^x, n =  5),  
                       labels = trans_format("log10", math_format(10^.x))) +
  scale_y_continuous(trans='log10', breaks = trans_breaks("log10", function(x) 10^x, n = 5), labels = label_number(accuracy = 0.01))+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size=20))+
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = -Inf, ymax = 0.4, alpha = 0.2, fill = "blue") +
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = 0.4, ymax = 2.5, alpha = 0.2, fill = "#ffffff") +
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = 2.5, ymax = 4, alpha = 0.2, fill = "orange") +
  annotate("rect", xmin=-Inf, xmax= Inf, ymin = 4, ymax = Inf, alpha = 0.2, fill = "red") +
  scale_shape_manual(name = "EMR \nThyroid Disorder",
                     values = c("Hyperthyroid" = 17, "Hypothyroid" = 15, "Neither" = 4))+
  scale_color_manual(name = "TSH Thresholds", 
                     values = c("Hyperthyroid" = "blue", "Subclinical Hypothyroid" = "orange", "Hypothyroid" = "red"))+
  xlab("\nLog Perchlorate/Creatinine")+
  ylab("TSH (IU/mL)\n")
dev.off()

tiff("TSH_Perch_Creat_SRnEMR.tiff", units="in", width=10, height=8, res=300) #Only to save in high def.
ggarrange(TSH_Perch_Creat_SR, TSH_Perch_Creat_EMR, nrow = 2, legend = "right")
dev.off()

ggplot(data=All_Data, aes(y=log10(Result_P_ng_mL)))+
  geom_boxplot(aes(fill=as.factor(Water_all)))
```

```{r corr_matrices}
df_corr_thyroid <- All_Data[ , c("Result_C_mg_dL","Result_C_ng_mL","Result_P_ng_mL","fT3","TSH","fT4","TotalT4","TotalT3","Cortisol","any_thyroid_problem_dummy","Hyper_D","Hypo_D","Thyroid_cancer_D","Goiter_D","pos_recode","emr_thyroid_problem","emr_hyperthyroidism","emr_hypothyroidism","emr_thyroid_cancer","emr_goiter","emr_cancer","emr_diabetes","EMR_any_thyroid_Dummy")]

df_corr_thyroid <- as.data.frame(df_corr_thyroid)

df_corr_thyroid$log_Result_C_mg_dL <- log10(df_corr_thyroid$Result_C_mg_dL)
df_corr_thyroid$log_Result_P_ng_mL <- log10(df_corr_thyroid$Result_P_ng_mL)
df_corr_thyroid$Creat_corrected_Perch <- log10(df_corr_thyroid$Result_P_ng_mL/df_corr_thyroid$Result_C_ng_mL)
df_corr_thyroid$log_TSH <- log10(df_corr_thyroid$TSH)
df_corr_thyroid$log_fT3 <- log10(df_corr_thyroid$fT3)
df_corr_thyroid$log_fT4 <- log10(df_corr_thyroid$fT4)
df_corr_thyroid$log_TotalT3 <- log10(df_corr_thyroid$TotalT3)
df_corr_thyroid$log_TotalT4 <- log10(df_corr_thyroid$TotalT4)
df_corr_thyroid$log_Cortisol <- log10(df_corr_thyroid$Cortisol)

sum(complete.cases(df_corr_thyroid)) #There are 199. We can use pairwise cases instead.
cor_thy <- cor(df_corr_thyroid, use="pairwise.complete.obs")
p_values_thy <- corr.test(cor_thy)


df_perch_horm <- All_Data[ , c("Result_C_mg_dL","Result_C_ng_mL","Result_P_ng_mL","fT3","TSH","fT4","TotalT4","TotalT3","Cortisol","Weight","Overweight","emr_weight","emr_bmi","emr_obesity","bmi")]

df_perch_horm <- as.data.frame(df_perch_horm)

df_perch_horm$log_Result_C_mg_dL <- log10(df_perch_horm$Result_C_mg_dL)
df_perch_horm$log_Result_P_ng_mL <- log10(df_perch_horm$Result_P_ng_mL)
df_perch_horm$Creat_corrected_Perch <- log10(df_perch_horm$Result_P_ng_mL/df_perch_horm$Result_C_ng_mL)
df_perch_horm$log_TSH <- log10(df_perch_horm$TSH)
df_perch_horm$log_fT3 <- log10(df_perch_horm$fT3)
df_perch_horm$log_fT4 <- log10(df_perch_horm$fT4)
df_perch_horm$log_TotalT3 <- log10(df_perch_horm$TotalT3)
df_perch_horm$log_TotalT4 <- log10(df_perch_horm$TotalT4)
df_perch_horm$log_Cortisol <- log10(df_perch_horm$Cortisol)
df_perch_horm$log_bmi <- log10(df_perch_horm$bmi)
df_perch_horm$log_emr_bmi <- log10(df_perch_horm$emr_bmi)


sum(complete.cases(df_perch_horm)) #There are 159, again use pairwise cases.

cor_perch_horm <- cor(df_perch_horm, use="pairwise.complete.obs")
p_values_horm <- corr.test(cor_perch_horm)

setwd("~/Desktop/Yuma Project/Yuma - R Project/")
write.csv(cor_thy, file="Correlation_HealthOutcomes_Final.csv", quote=F, row.names=T)
write.csv(cor_perch_horm, file="Correlation_Perch_Hormones_BMI_Final.csv", quote=F, row.names=T)

#UPDATED 5/3/2024

df_perch_horm2 <- All_Data[ , c("Result_C_ng_mL","Result_P_ng_mL","fT3","TSH","fT4","TotalT4","TotalT3","Cortisol")]

df_perch_horm2 <- as.data.frame(df_perch_horm2)

df_perch_horm2$log_Result_P_ng_mL <- log10(df_perch_horm2$Result_P_ng_mL)
df_perch_horm2$Creat_corrected_Perch <- log10(df_perch_horm2$Result_P_ng_mL/df_perch_horm2$Result_C_ng_mL)
df_perch_horm2$log_TSH <- log10(df_perch_horm2$TSH)
df_perch_horm2$log_fT3 <- log10(df_perch_horm2$fT3)
df_perch_horm2$log_fT4 <- log10(df_perch_horm2$fT4)
df_perch_horm2$log_TotalT3 <- log10(df_perch_horm2$TotalT3)
df_perch_horm2$log_TotalT4 <- log10(df_perch_horm2$TotalT4)
df_perch_horm2$log_Cortisol <- log10(df_perch_horm2$Cortisol)


sum(complete.cases(df_perch_horm2)) #There are 278, again use pairwise cases.

cor_perch_horm2 <- cor(df_perch_horm2, use="pairwise.complete.obs")
p_values_horm2 <- corr.test(df_perch_horm2)

setwd("~/Desktop/Yuma Project/Yuma - R Project/")
write.csv(cor_perch_horm2, file="Correlations_Final.csv", quote=F, row.names=T)


```


```{r corr_matrices_gender}

df_corr_thyroid2 <- All_Data[ , c("Gender","Result_C_mg_dL","Result_C_ng_mL","Result_P_ng_mL","fT3","TSH","fT4","TotalT4","TotalT3","Cortisol","any_thyroid_problem_dummy","Hyper_D","Hypo_D","Thyroid_cancer_D","Goiter_D","pos_recode","emr_thyroid_problem","emr_hyperthyroidism","emr_hypothyroidism","emr_thyroid_cancer","emr_goiter","emr_cancer","emr_diabetes","EMR_any_thyroid_Dummy")]

df_corr_thyroid2 <- as.data.frame(df_corr_thyroid2)

df_corr_thyroid2$log_Result_C_mg_dL <- log10(df_corr_thyroid2$Result_C_mg_dL)
df_corr_thyroid2$log_Result_P_ng_mL <- log10(df_corr_thyroid2$Result_P_ng_mL)
df_corr_thyroid2$Creat_corrected_Perch <- log10(df_corr_thyroid2$Result_P_ng_mL/df_corr_thyroid2$Result_C_ng_mL)
df_corr_thyroid2$log_TSH <- log10(df_corr_thyroid2$TSH)
df_corr_thyroid2$log_fT3 <- log10(df_corr_thyroid2$fT3)
df_corr_thyroid2$log_fT4 <- log10(df_corr_thyroid2$fT4)
df_corr_thyroid2$log_TotalT3 <- log10(df_corr_thyroid2$TotalT3)
df_corr_thyroid2$log_TotalT4 <- log10(df_corr_thyroid2$TotalT4)
df_corr_thyroid2$log_Cortisol <- log10(df_corr_thyroid2$Cortisol)

df_corr_thyroid_m <- subset(df_corr_thyroid2, df_corr_thyroid2$Gender==1)
df_corr_thyroid_f <- subset(df_corr_thyroid2, df_corr_thyroid2$Gender==2)

cor_thy_m <- cor(df_corr_thyroid_m, use="pairwise.complete.obs")
cor_thy_f <- cor(df_corr_thyroid_f, use="pairwise.complete.obs")
p_values_thy_m <- corr.test(cor_thy_m)
p_values_thy_f <- corr.test(cor_thy_f)


df_perch_horm2 <- All_Data[ , c("Gender","Result_C_mg_dL","Result_C_ng_mL","Result_P_ng_mL","fT3","TSH","fT4","TotalT4","TotalT3","Cortisol","Weight","Overweight","emr_weight","emr_bmi","emr_obesity","bmi")]

df_perch_horm2 <- as.data.frame(df_perch_horm2)

df_perch_horm2$log_Result_C_mg_dL <- log10(df_perch_horm2$Result_C_mg_dL)
df_perch_horm2$log_Result_P_ng_mL <- log10(df_perch_horm2$Result_P_ng_mL)
df_perch_horm2$Creat_corrected_Perch <- log10(df_perch_horm2$Result_P_ng_mL/df_perch_horm2$Result_C_ng_mL)
df_perch_horm2$log_TSH <- log10(df_perch_horm2$TSH)
df_perch_horm2$log_fT3 <- log10(df_perch_horm2$fT3)
df_perch_horm2$log_fT4 <- log10(df_perch_horm2$fT4)
df_perch_horm2$log_TotalT3 <- log10(df_perch_horm2$TotalT3)
df_perch_horm2$log_TotalT4 <- log10(df_perch_horm2$TotalT4)
df_perch_horm2$log_Cortisol <- log10(df_perch_horm2$Cortisol)
df_perch_horm2$log_bmi <- log10(df_perch_horm2$bmi)
df_perch_horm2$log_emr_bmi <- log10(df_perch_horm2$emr_bmi)


sum(complete.cases(df_perch_horm2)) #There are 159, again use pairwise cases.

cor_perch_horm2 <- cor(df_perch_horm2, use="pairwise.complete.obs")
p_values_horm2 <- corr.test(cor_perch_horm2)

```

```{r log_regressions}
#Dr. Denise Roe Relevant Bios 576B Lectures:
#January 20th - Linear Regression Diagnostics
#January 27th - ANCOVA and Predictor Selection Methods for MLR
#February 3rd - Modeling Strategies, missing data / imputation
#February 8th - 2x2 tables, power and sample size estimates
#February 10th and 24th - Stratified analyses
#March 1st - Logistic Regression
#March 3rd - GLM confounding and interaction
#March 17th - GLM Goodness of Fit and Diagnostics

#Logistic
#Resulting betas are log-odds of disease (ORs).
#Wald statistic to determine if individual coefficients are significant, but not super powerful.
#Prefer to use LRT to see if all predictor variables are significant vs simple regression. (OR vs adjusted OR)

hist(All_Data$age)

#Smoking may interact with perchlorate levels to affect thyroid function, so I will test smoking as a modifier variable using likelihood ratio tests, with an interaction threshold set at p < 0.05. 
#I will test explanatory variables included in the model for correlations with one another using variance inflation factor (VIF) tests, and if highly correlated (VIF > 2) only one of those that are related will be chosen for model inclusion.

#Looking at effect modification for smoking just to verify
model1_adj_sm0 <- glm(Hypo_D ~ log10(Result_P_ng_mL), data=All_Data, subset = (Smoking_Status == "0"), family="binomial")
model1_adj_sm1 <- glm(Hypo_D ~ log10(Result_P_ng_mL), data=All_Data, subset = (Smoking_Status == "1"), family="binomial")
model1_adj_sm2 <- glm(Hypo_D ~ log10(Result_P_ng_mL), data=All_Data, subset = (Smoking_Status == "2"), family="binomial")
model1_adj_sm3 <- glm(Hypo_D ~ log10(Result_P_ng_mL), data=All_Data, subset = (Smoking_Status == "3"), family="binomial")
summary(model1_adj_sm0) #There are 239 DoF - OR for Perch: 1.47
summary(model1_adj_sm1) #There are only 21 DoF - OR for Perch: 2.04
summary(model1_adj_sm2) #There are only 2 DoF - OR for Perch: 0.002 #This is not super meaningful with low numbers.
summary(model1_adj_sm3) #NA - 0 DoF

#Can do ever smokers vs never smokers
model1_adj_sm0 <- glm(Hypo_D ~ log10(Result_P_ng_mL), data=All_Data, subset = (Smoking_Status == "0"), family="binomial")
model1_adj_sm1 <- glm(Hypo_D ~ log10(Result_P_ng_mL), data=All_Data, subset = (Smoking_Status == "1" | Smoking_Status == "2" | Smoking_Status == "3"), family="binomial")
summary(model1_adj_sm0) #There are 239 DoF - OR for Perch: 1.47
summary(model1_adj_sm1) #There are only 25 DoF - OR for Perch: 1.81
#18.9% difference

All_Data$Ever_Smoker <- ifelse(All_Data$Smoking_Status==0, 0, 
                               ifelse(All_Data$Smoking_Status == "1" | 
                                        All_Data$Smoking_Status == "2" | 
                                        All_Data$Smoking_Status == "3", 1, NA))

All_Data$Current_Smoker_D <- ifelse(All_Data$Smoking_Status==0 | 
                                      All_Data$Smoking_Status == "1", 0, 
                               ifelse(All_Data$Smoking_Status == "2" | 
                                        All_Data$Smoking_Status == "3", 1, NA))

model1_adj_withint <- glm(Hypo_D ~ log10(Result_P_ng_mL)*Ever_Smoker + log10(Result_C_mg_dL) + Gender*age + Ethnicity + as.factor(Site) + as.factor(Water_all), data=All_Data, family="binomial")
summary(model1_adj_withint)

model1_adj_withint <- glm(Hypo_D ~ log10(Result_P_ng_mL)*Ever_Smoker + log10(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + as.factor(Water_all), data=All_Data, family="binomial")
summary(model1_adj_withint)

model1_adj_withint <- glm(Hypo_D ~ log10(Result_P_ng_mL)*as.factor(Smoking_Status) + log10(Result_C_mg_dL) + Gender*age + Ethnicity + as.factor(Site) + as.factor(Water_all), data=All_Data, family="binomial")
summary(model1_adj_withint)

model1_adj_withint <- glm(Hypo_D ~ log10(Result_P_ng_mL)*as.factor(Smoking_Status) + log10(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + as.factor(Water_all), data=All_Data, family="binomial")
summary(model1_adj_withint)

model1_adj_withint <- glm(Hypo_D ~ log10(Result_P_ng_mL)*Current_Smoker_D + log10(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + as.factor(Water_all), data=All_Data, family="binomial")
summary(model1_adj_withint)
#Gender and age interaction does not appear significant, and smoking status (for ever vs never smokers, for current vs non-current smokers, and for never, prior, light, and heavy) and perchlorate do not meet the threshold (not even close). Could be because of the very low number of smokers in our cohort? I will remove Gender*age and remove all types of smoking*perchlorate.

model1_adj2 <- glm(Hypo_D ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + as.factor(Smoking_Status) + as.factor(Water_all), data=(subset(All_Data, All_Data$Site!=1)), family="binomial") #General model with no interactions and not including CSF
summary(model1_adj2)
 
model1_adj3 <- glm(Hypo_D ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender*age + Ethnicity + as.factor(Site) + as.factor(Smoking_Status) + as.factor(Water_all), data=All_Data, family="binomial") #Checking gender and age interaction, does not meet threshold.
summary(model1_adj3)

model1_adj4 <- glm(Hypo_D ~ log(Result_P_ng_mL)*age + log(Result_C_mg_dL) + Gender  + Ethnicity + as.factor(Site) + as.factor(Smoking_Status) + as.factor(Water_all), data=All_Data, family="binomial") #int significant between age and perchlorate.
summary(model1_adj4)

model1_adj4 <- glm(Hypo_D ~ log(Result_P_ng_mL)*age + log(Result_C_mg_dL) + Gender  + Ethnicity + as.factor(Site) + as.factor(Smoking_Status) + as.factor(Water_all), data=subset(All_Data, All_Data$Site!=1), family="binomial") #int significant between age and perchlorate.
summary(model1_adj4)

#Smoking status*perch and gender*age are not significant. As such, will not keep in model. However, perch*age is sign. Can't find any biological justification for keeping perch*age, though.

model1_adj5 <- glm(Hypo_D ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + as.factor(Smoking_Status) + as.factor(Water_all) + as.factor(Income), data=All_Data, family="binomial")
summary(model1_adj5) #Income not sig.

model1_adj6 <- glm(Hypo_D ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + as.factor(Smoking_Status) + as.factor(Water_all) + bmi, data=All_Data, family="binomial")
summary(model1_adj6) #bmi not sig.

model1_adj7 <- glm(Hypo_D ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + as.factor(Smoking_Status) + as.factor(Water_all) + as.factor(Income) + bmi, data=All_Data, family="binomial")
summary(model1_adj7) #Adding Income and bmi were not sig... Won't add them to save some powah. I also didn't include them a priori, so I probably shouldn't force the model to be something it isn't like some toxic, constantly disappointed mom.

#What if I do division creatinine correction instead of adding as covariate?
model1_adj <- glm(Hypo_D ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + as.factor(Smoking_Status) + as.factor(Water_all), data=All_Data, family="binomial")
summary(model1_adj)

model1_adj8 <- glm(Hypo_D ~ log(Result_P_ng_mL/Result_C_ng_mL) + Gender + age + Ethnicity + as.factor(Site) + as.factor(Smoking_Status) + as.factor(Water_all), data=All_Data, family="binomial")
summary(model1_adj8)

#Not good. The CDC in their models just keep creatinine as a covariate, and so that's also what I will do, too.

#Quick checks
#model1_adj <- glm(SR_EMR_Hypothyroid ~ log(Result_P_ng_mL)*Water_all +log(Result_C_mg_dL) + Gender + Ethnicity + Site + Smoking_Status + age, data=(subset(All_Data, All_Data$Site!=1))) #No interaction with perchlorate and water.

#model1_adj <- glm(SR_EMR_Hypothyroid ~ log10(Result_P_ng_mL) + age +log10(Result_C_mg_dL) + Gender + Ethnicity + Site + Smoking_Status + Water_all, data=All_Data) #Interaction between perchlorate and age. #Categorize age to see which age group is driving.

#Because of the very low number of smokers, I am grouping people into ever vs never.

#Checking referent categories
levels(as.factor(All_Data$Site))
levels(as.factor(All_Data$Ever_Smoker)) #won't use due to inconsistent data collection
levels(as.factor(All_Data$Water_all))
levels(as.factor(All_Data$Ethnicity))

##Self-Report Hypothyroidism Model
model1_unadj <- glm(Hypo_D ~ log10(Result_P_ng_mL), data=All_Data, family="binomial")
summary(model1_unadj)
exp(0.4006)
exp(confint(model1_unadj))

model1_adj <- glm(Hypo_D ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + Ever_Smoker + as.factor(Water_all), data=All_Data, family="binomial")
summary(model1_adj)
exp(confint(model1_adj))

#lrtest(model1_unadj, model1_adj) #Different sized dataframes. Will need to figure out how to do this.
#Used AIC

#Without CSF
model1_unadj_NoCSF <- glm(Hypo_D ~ log10(Result_P_ng_mL), data=subset(All_Data, All_Data$Site!=1), family="binomial")
summary(model1_unadj_NoCSF)
exp(0.5197)
exp(confint(model1_unadj_NoCSF))

model1_adj_NoCSF <- glm(Hypo_D ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Ethnicity + Site + Ever_Smoker + as.factor(Water_all), data=subset(All_Data, All_Data$Site!=1), family="binomial")
summary(model1_adj_NoCSF)
exp(confint(model1_adj_NoCSF))


avPlots(model1_adj) #This isn't super helpful for non-continuous variables

#Variance Inflation Factors
vif(model1_adj)
vif_values1 <- as.data.frame(vif(model1_adj))
names <- rownames(vif_values1)
vif_values1$variable <- names
ggplot(data = vif_values1, aes(x=variable, y=GVIF))+
  geom_col()+
  theme(axis.text.x = element_text(angle = 90))+
  theme(text = element_text(size = 20))

#Nothing looks like it needs to come out of the model based on the VIF

#Goodness of fit:
#lrtest(): this did not work because of the differences in row lengths.
#Used AIC values instead.

##EMR Hypothyroidism Model
model2_unadj <- glm(emr_hypothyroidism ~ log10(Result_P_ng_mL), data=All_Data, family="binomial")
summary(model2_unadj)
exp(0.2493)
exp(confint(model2_unadj))

model2_adj <- glm(emr_hypothyroidism ~ log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + Ever_Smoker + as.factor(Water_all), data=All_Data, family="binomial")
summary(model2_adj)
exp(confint(model2_adj))

#Don't need to remove CSF because CSF does not have EMRs.

#SR or EMR Hypothyroidism Model
All_Data <- All_Data %>%
  mutate(SR_EMR_Hypothyroid = case_when(
    Hypo_D == 1 | emr_hypothyroidism == 1 ~ 1,
    Hypo_D == 0 & emr_hypothyroidism == 0 ~ 0,
    Hypo_D == 0 & is.na(emr_hypothyroidism) ~ 0,
    is.na(Hypo_D) & is.na(emr_hypothyroidism) ~ NA_real_, TRUE ~ NA_real_)) 

model3_unadj <- glm(SR_EMR_Hypothyroid ~ log10(Result_P_ng_mL), data=All_Data, family="binomial")
summary(model3_unadj)
exp(0.4995)
exp(confint(model3_unadj))

model3_adj <- glm(SR_EMR_Hypothyroid ~ log10(Result_P_ng_mL) +log10(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + Ever_Smoker + as.factor(Water_all), data=All_Data, family="binomial")
summary(model3_adj)
exp(confint(model3_adj))

#Without CSF
model3_unadj_NoCSF <- glm(SR_EMR_Hypothyroid ~ log10(Result_P_ng_mL), data=subset(All_Data, All_Data$Site!=1), family="binomial")
summary(model3_unadj_NoCSF)
exp(0.6792)
exp(confint(model3_unadj_NoCSF))

model3_adj_NoCSF <- glm(SR_EMR_Hypothyroid ~ log10(Result_P_ng_mL) +log10(Result_C_mg_dL) + Gender + age + Ethnicity + Site + Ever_Smoker + as.factor(Water_all), data=subset(All_Data, All_Data$Site!=1), family="binomial")
summary(model3_adj_NoCSF)
exp(confint(model3_adj_NoCSF))

##General Thyroid Problem Models

####Not going to do this. Doesn't make a huge amount of biological sense to group these necessarily. Just hypothyroid is better. Commenting out.

#model3_unadj <- glm(SR_hypo_goit_canc ~ log(Result_P_ng_mL), data=All_Data)
#summary(model3_unadj)
#exp(confint(model3_unadj))

test_model <- glm(SR_hypo_goit_canc ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + as.factor(Ever_Smoker) + as.factor(Water_all), data=subset(All_Data, All_Data$Site!=1), family="binomial")
summary(test_model)

#Neither gender/age nor smoking/perchlorate seem to have a significant interaction. Will remove smoking/perchlorate to see if that changes things for gender/age.

#model3_adj <- glm(SR_hypo_goit_canc ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Gender*age + Ethnicity + Site + Smoking_Status + Water_all, data=All_Data)
#summary(model3_adj)
#exp(confint(model3_adj))
#Smoking status and gender*age are nearly significant. As such, will keep in model.

##EMR Thyroid Problems Model
#model4_unadj <- glm(EMR_hypo_goit_canc ~ log(Result_P_ng_mL), data=All_Data)
#summary(model4_unadj)
#exp(confint(model4_unadj))

#model4_adj_withint <- glm(EMR_hypo_goit_canc ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Gender*age + Ethnicity + Site + Smoking_Status + Smoking_Status*log(Result_P_ng_mL) + Water_all, data=All_Data)
#summary(model4_adj_withint)
#Neither gender/age nor smoking/perchlorate seem to have a significant interaction. Will remove smoking/perchlorate to see if that changes things for gender/age.

#model4_adj_withint <- glm(EMR_hypo_goit_canc ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Gender*age + Ethnicity + Site + Smoking_Status + Water_all, data=All_Data)
#summary(model4_adj_withint)
#Gender/age still not significant for interaction. Will remove from this model.

#model4_adj <- glm(EMR_hypo_goit_canc ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Ethnicity + Site + Smoking_Status + Water_all, data=All_Data)
#summary(model4_adj)
#exp(confint(model4_adj))

#Creating a column that shows cases as positive if diagnosed by EMR or SR sources
#All_Data$SR_EMR_Hypothyroid <- ifelse(All_Data$Hypo_D==1|All_Data$emr_hypothyroidism==1, 1, 0)
#Will need to come back and verify this is working... seems to be an issue with the NAs.

#141 cases, 106 controls, 247 total. 


#Well water really seems to be having a hard time in these models. This might be because there is a very small number of well users (< 1%). I am going to try grouping well users into the 'other' category to see if this can alleviate some of those wild confidence intervals.

#New column: 
#Water 1: City
#Water 2: Well / Other
#Water 3: Bottled
#Water 5: Mixed Sources

All_Data$Water_all_revised <- ifelse(All_Data$Water_all==1, 1,
                                     ifelse(All_Data$Water_all==2|All_Data$Water_all==4, 2,
                                            ifelse(All_Data$Water_all==3, 3,
                                                   ifelse(All_Data$Water_all==5, 5, NA))))

##Self-Report Hypothyroidism Model
model1_unadj <- glm(Hypo_D ~ log10(Result_P_ng_mL), data=All_Data, family="binomial")
summary(model1_unadj)
exp(0.4006)
exp(confint(model1_unadj))

model1_adj <- glm(Hypo_D ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + Ever_Smoker + as.factor(Water_all_revised), data=All_Data, family="binomial")
summary(model1_adj)
exp(confint(model1_adj))

#lrtest(model1_unadj, model1_adj) #Different sized dataframes. Will need to figure out how to do this.
#Used AIC

#Without CSF
model1_unadj_NoCSF <- glm(Hypo_D ~ log10(Result_P_ng_mL), data=subset(All_Data, All_Data$Site!=1), family="binomial")
summary(model1_unadj_NoCSF)
exp(0.5197)
exp(confint(model1_unadj_NoCSF))

model1_adj_NoCSF <- glm(Hypo_D ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Ethnicity + Site + Ever_Smoker + as.factor(Water_all_revised), data=subset(All_Data, All_Data$Site!=1), family="binomial")
summary(model1_adj_NoCSF)
exp(confint(model1_adj_NoCSF))


avPlots(model1_adj) #This isn't super helpful for non-continuous variables

#Variance Inflation Factors
vif(model1_adj)
vif_values1 <- as.data.frame(vif(model1_adj))
names <- rownames(vif_values1)
vif_values1$variable <- names
ggplot(data = vif_values1, aes(x=variable, y=GVIF))+
  geom_col()+
  theme(axis.text.x = element_text(angle = 90))+
  theme(text = element_text(size = 20))

#Nothing looks like it needs to come out of the model based on the VIF


##EMR Hypothyroidism Model
model2_unadj <- glm(emr_hypothyroidism ~ log10(Result_P_ng_mL), data=All_Data, family="binomial")
summary(model2_unadj)
exp(0.2493)
exp(confint(model2_unadj))

model2_adj <- glm(emr_hypothyroidism ~ log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + Ever_Smoker + as.factor(Water_all_revised), data=All_Data, family="binomial")
summary(model2_adj)
exp(confint(model2_adj))

#Don't need to remove CSF because CSF does not have EMRs.

#SR or EMR Hypothyroidism Model
All_Data <- All_Data %>%
  mutate(SR_EMR_Hypothyroid = case_when(
    Hypo_D == 1 | emr_hypothyroidism == 1 ~ 1,
    Hypo_D == 0 & emr_hypothyroidism == 0 ~ 0,
    Hypo_D == 0 & is.na(emr_hypothyroidism) ~ 0,
    is.na(Hypo_D) & is.na(emr_hypothyroidism) ~ NA_real_, TRUE ~ NA_real_)) 

model3_unadj <- glm(SR_EMR_Hypothyroid ~ log10(Result_P_ng_mL), data=All_Data, family="binomial")
summary(model3_unadj)
exp(0.4995)
exp(confint(model3_unadj))

model3_adj <- glm(SR_EMR_Hypothyroid ~ log10(Result_P_ng_mL) +log10(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + Ever_Smoker + as.factor(Water_all_revised), data=All_Data, family="binomial")
summary(model3_adj)
exp(confint(model3_adj))

#Without CSF
model3_unadj_NoCSF <- glm(SR_EMR_Hypothyroid ~ log10(Result_P_ng_mL), data=subset(All_Data, All_Data$Site!=1), family="binomial")
summary(model3_unadj_NoCSF)
exp(0.6792)
exp(confint(model3_unadj_NoCSF))

model3_adj_NoCSF <- glm(SR_EMR_Hypothyroid ~ log10(Result_P_ng_mL) +log10(Result_C_mg_dL) + Gender + age + Ethnicity + Site + Ever_Smoker + as.factor(Water_all_revised), data=subset(All_Data, All_Data$Site!=1), family="binomial")
summary(model3_adj_NoCSF)
exp(confint(model3_adj_NoCSF))

```

```{r linear_dr}
#Dr. Denise Roe Relevant Bios 576B Lectures:
#January 13th - Linear Regressions (Review) Start at 47 min
#January 20th - Regression Diagnostics

#NEED TO ONLY INCLUDE CASES IN THESE MODELS
#Regressions - our assumptions are not met for linear regressions, though, just FMI
#Do I need to add age? Did not include in my proposal, but there may be interaction between age and gender here?
model5 <- lm(log10(TSH) ~ log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + Site + thyroid_med + Gender, data = subset(All_Data, All_Data$any_thyroid_problem_dummy==1))
summary(model5)
avPlots(model5)

model6 <- lm(log10(fT4) ~ log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + Site + thyroid_med + Gender, data = subset(All_Data, All_Data$any_thyroid_problem_dummy==1))
summary(model6)
avPlots(model6)
```

```{r mancova}
#Exclude participants taking thyroid meds
#Outcomes: TSH, T4, T3, Cortisol
#Primary Predictor: Urinary Perchlorate
#Covariates: Urinary Creatinine, Sex, Age
#Separate models by cases vs controls (will need to do a sensitivity analysis for how we defined cases [i.e., by self-report, EMR, or either])

Some_Data <- subset(All_Data, All_Data$thyroid_med==0) #203 of 323 = 62.8% of orig. dataset

Some_Data_SR_Cases <- subset(Some_Data, Some_Data$any_thyroid_problem_dummy==1)
Some_Data_SR_Controls <- subset(Some_Data, Some_Data$any_thyroid_problem_dummy==0)
Some_Data_EMR_Cases <- subset(Some_Data, Some_Data$emr_thyroid_problem_fromothercolumns==1)
Some_Data_EMR_Controls <- subset(Some_Data, Some_Data$emr_thyroid_problem_fromothercolumns==0)
Some_Data_SREMR_Cases <- subset(Some_Data, Some_Data$any_thyroid_Dummy_EMR_or_SR==1)
Some_Data_SREMR_Controls <- subset(Some_Data, Some_Data$any_thyroid_Dummy_EMR_or_SR==0)

#Assumptions
#MANOVA to see if the interaction term of each of the covariates and the grouping variable are significant
Outcomes <- cbind(log10(Some_Data$TSH), log10(Some_Data$fT4), log10(Some_Data$TotalT4), log10(Some_Data$fT3), log10(Some_Data$TotalT3), log10(Some_Data$Cortisol))

MAN_Mod1 <- manova(Outcomes ~ log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + Gender + log10(Result_P_ng_mL)*Gender, data=Some_Data)
summary(MAN_Mod1, test="Wilks", type = "III") #Interaction term is not sig, so valid
summary(MAN_Mod1, test="Pillai", type = "III")
summary(MAN_Mod1, test="Hotelling", type = "III")
summary(MAN_Mod1, test="Roy", type = "III")

MAN_Mod2 <- manova(Outcomes ~ log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + age + log10(Result_P_ng_mL)*age, data=Some_Data)
summary(MAN_Mod2, test="Wilks", type = "III") #Interaction term is sig, so assumption not met
summary(MAN_Mod2, test="Pillai", type = "III")
summary(MAN_Mod2, test="Hotelling", type = "III")
summary(MAN_Mod2, test="Roy", type = "III")

Some_Data$Log_TSH <- log10(Some_Data$TSH)
Some_Data$Log_fT4 <- log10(Some_Data$fT4)
Some_Data$Log_TotalT4 <- log10(Some_Data$TotalT4)
Some_Data$Log_fT3 <- log10(Some_Data$fT3)
Some_Data$Log_TotalT3 <- log10(Some_Data$TotalT3)
Some_Data$Log_Cortisol <- log10(Some_Data$Cortisol)


MANCOVA_model_overall <- manova(cbind(log10(TSH), log10(fT4), log10(TotalT4), log10(fT3), log10(TotalT3), log10(Cortisol)) ~ log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + age + Gender, data = Some_Data)
summary(MANCOVA_model_overall)

MANCOVA_model_SRcases <- manova(cbind(log10(TSH), log10(fT4), log10(TotalT4), log10(fT3), log10(TotalT3), log10(Cortisol)) ~ log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + age + Gender, data = subset(Some_Data, Some_Data$any_thyroid_problem_dummy==1))
summary(MANCOVA_model_SRcases)

MANCOVA_model_SRcontrols <- manova(cbind(log10(TSH), log10(fT4), log10(TotalT4), log10(fT3), log10(TotalT3), log10(Cortisol)) ~ log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + age + Gender, data = subset(Some_Data, Some_Data$any_thyroid_problem_dummy==0))
summary(MANCOVA_model_SRcontrols)

MANCOVA_model_EMRcases <- manova(cbind(log10(TSH), log10(fT4), log10(TotalT4), log10(fT3), log10(TotalT3), log10(Cortisol)) ~ log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + age + Gender, data = subset(Some_Data, Some_Data$EMR_any_thyroid_Dummy==1))
summary(MANCOVA_model_EMRcases)

MANCOVA_model_EMRcontrols <- manova(cbind(log10(TSH), log10(fT4), log10(TotalT4), log10(fT3), log10(TotalT3), log10(Cortisol)) ~ log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + age + Gender, data = subset(Some_Data, Some_Data$EMR_any_thyroid_Dummy==0))
summary(MANCOVA_model_EMRcontrols)

MANCOVA_model_SREMRcases <- manova(cbind(log10(TSH), log10(fT4), log10(TotalT4), log10(fT3), log10(TotalT3), log10(Cortisol)) ~ log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + age + Gender, data = subset(Some_Data, Some_Data$any_thyroid_Dummy_EMR_or_SR==1))
summary(MANCOVA_model_SREMRcases)

MANCOVA_model_SREMRcontrols <- manova(cbind(log10(TSH), log10(fT4), log10(TotalT4), log10(fT3), log10(TotalT3), log10(Cortisol)) ~ log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + age + Gender, data = subset(Some_Data, Some_Data$any_thyroid_Dummy_EMR_or_SR==0))
summary(MANCOVA_model_SREMRcontrols)

#Having a hard time interpreting these, will ask Dr. Furlong for help here.

#Just want to look at something I kinda sorta a little bit understand this time:
TSH_SR_Cases <- lm(log10(TSH)~log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + age + Gender, data = subset(Some_Data, Some_Data$any_thyroid_problem_dummy==1))
summary(TSH_SR_Cases)

TSH_SR_Controls <- lm(log10(TSH)~log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + age + Gender, data = subset(Some_Data, Some_Data$any_thyroid_problem_dummy==0))
summary(TSH_SR_Controls)

TSH_SR_Cases <- lm(log10(TSH)~log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + age + Gender, data = subset(Some_Data, Some_Data$any_thyroid_problem_dummy==1))
summary(TSH_SR_Cases)

TSH_SR_Controls <- lm(log10(TSH)~log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + age + Gender, data = subset(Some_Data, Some_Data$any_thyroid_problem_dummy==0))
summary(TSH_SR_Controls)

TSH_EMR_Cases <- lm(log10(TSH)~log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + age + Gender, data = subset(Some_Data, Some_Data$EMR_any_thyroid_Dummy==1))
summary(TSH_EMR_Cases)

TSH_EMR_Controls <- lm(log10(TSH)~log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + age + Gender, data = subset(Some_Data, Some_Data$EMR_any_thyroid_Dummy==0))
summary(TSH_EMR_Controls)

TSH_EMR_SR_Controls <- lm(log10(TSH)~log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + age + Gender, data = subset(Some_Data, Some_Data$any_thyroid_Dummy_EMR_or_SR==0))
summary(TSH_EMR_SR_Controls)

TSH_EMR_SR_Controls <- lm(log10(TSH)~log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + age + Gender, data = subset(Some_Data, Some_Data$any_thyroid_Dummy_EMR_or_SR==0))
summary(TSH_EMR_SR_Controls)
```

```{r doses}
All_Data$Daily_Dose <- All_Data$Result_P_ng_mL*1800/1000*(1/(All_Data$Weight*0.454))

max(All_Data$Daily_Dose, na.rm = T)

hline_data_Dose <- data.frame(
    yintercept = c(0.7),
    label = c("2005 EPA Oral Reference Dose"),
    color = c("darkred")
)

tiff("Perch_Dose.tiff", units="in", width=8, height=5, res=300) #Only to save in high def.
ggplot(data=All_Data, aes(y=Daily_Dose, x=ID))+
  geom_jitter(aes(shape=as.factor(Site), fill=as.factor(Site)))+
  geom_hline(data=hline_data_Dose, aes(yintercept = yintercept, linetype = label, color = label))+
  scale_shape_manual(name = "Recruitment Site",
                     values = c(15, 2, 21),
                     labels = c("CSF", "RCBH", "YRMC"))+
  scale_fill_manual(name = "Recruitment Site",
                    values = c("black", "white", "grey52"),
                    labels = c("CSF", "RCBH", "YRMC"))+
  labs(color = NULL, linetype = NULL)+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 20),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())+
  xlab("")+
  ylab("Dose (ug/kg-day)")
dev.off()


#From Valentin-Blasini et al., some updates to equation.
All_Data$CE_mg_day <- ifelse(All_Data$Gender==1, (1.93*(140-All_Data$age)*(All_Data$Weight*0.454)^1.5*(All_Data$height_total*2.54)^0.5)/1000,
                            ifelse(All_Data$Gender==2, (1.64*(140-All_Data$age)*(All_Data$Weight*0.454)^1.5*(All_Data$height_total*2.54)^0.5)/1000, NA))

All_Data$Daily_Dose2 <- ((as.numeric(All_Data$Result_P_ng_mL)/1000)/(as.numeric(All_Data$Result_C_mg_dL)/100000))*(All_Data$CE_mg_day/1000)*(1/(All_Data$Weight*0.454))


max(All_Data$Daily_Dose2, na.rm = T)
range(All_Data$Daily_Dose2, na.rm = T)
geoMean(All_Data$Daily_Dose2, na.rm = T)
geoSD(All_Data$Daily_Dose2, na.rm = T)


hline_data_Dose <- data.frame(
    yintercept = c(0.7),
    label = c("2005 EPA Oral Reference Dose"),
    color = c("darkred")
)

tiff("Perch_Dose2.tiff", units="in", width=8, height=5, res=300) #Only to save in high def.
ggplot(data=All_Data, aes(y=Daily_Dose2, x=ID))+
  geom_jitter(aes(shape=as.factor(Site), fill=as.factor(Site)))+
  geom_hline(data=hline_data_Dose, aes(yintercept = yintercept, linetype = label, color = label))+
  scale_shape_manual(name = "Recruitment Site",
                     values = c(15, 2, 21),
                     labels = c("CSF", "RCBH", "YRMC"))+
  scale_fill_manual(name = "Recruitment Site",
                    values = c("black", "white", "grey52"),
                    labels = c("CSF", "RCBH", "YRMC"))+
  labs(color = NULL, linetype = NULL)+
  theme(panel.background = element_rect(fill="#ffffff"),
        axis.line = element_line(color="#000000"),
        text = element_text(size = 20),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())+
  xlab("")+
  ylab("Dose (ug/kg-day)")
dev.off()


```

After submitting my first draft to my committee, I received the following feedback from my environmental epi professor:

"Some of my major points:
 
In a case control study design, the outcome analyzed needs to be the outcome that was recruited. So if the study design recruited people with thyroid issues and you include all of them, then the outcome in the models needs to be the general thyroid issues. If you choose to specify hypothyroidism as an outcome (which is fine and in some ways makes more sense), then the models need to exclude everyone with hyperthyroidism and other thyroid issues, and the tables/ns need to reflect hypothyroidism and the appropriate controls. Basically the main model needs to match the study design. If you want, you can conduct a multinomial logistic regression where each level is a different outcome (e.g., controls =0, hypothyroidism = 1, hyperthyroidism =2, other issues= 3). Otherwise Id just analyze everyone together and then do a sensitivity analysis that is your hypothyroidism models.

Because of this cc study design, you also cant analyze the other outcomes that were not recruited on (e.g., weight) unless you stratify the analyses by case and control status. This is because you have over enrolled for people with thyroid issues who are more likely to have weight issues.  

If you have thyroid hormone levels on everyone, why dont you include this as an outcome? We talked about this but I dont remember what the answer was.For this you can either define your cases/controls based on thyroid hormone levels (seems more sensitive than self report or ICD codes), or you can just run thyroid as a continuous outcome, and need to control for case/control status in the model."

I am now going to update my models/code to incorporate these suggestions to better follow the epidemiological "rules" as it were.

```{r epi_rules} 
#I think I am funny.
#any_thyroid_problem_dummy, emr_thyroid_problem_fromothercolumns - just pulling for easy reference

#Smoking variable was not collected in the health survey, and only extracted from EMRs. Therefore, I will not use the smoking variable in our models.
#I will test explanatory variables included in the model for correlations with one another using variance inflation factor (VIF) tests, and if highly correlated (VIF > 2) only one of those that are related will be chosen for model inclusion.

 
model1_adj3 <- glm(any_thyroid_problem_dummy ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender*age + Ethnicity + as.factor(Site) + as.factor(Water_all), data=All_Data, family="binomial") 
summary(model1_adj3) #Checking gender and age interaction, does not meet threshold.

#model1_adj4 <- glm(any_thyroid_problem_dummy ~ log(Result_P_ng_mL)*age + log(Result_C_mg_dL) + Gender  + Ethnicity + as.factor(Site) + as.factor(Smoking_Status) + as.factor(Water_all), data=All_Data, family="binomial") 
#summary(model1_adj4) #int significant between age and perchlorate, but no biological justification for this.

#model1_adj4 <- glm(any_thyroid_problem_dummy ~ log(Result_P_ng_mL)*age + log(Result_C_mg_dL) + Gender  + Ethnicity + as.factor(Site) + as.factor(Smoking_Status) + as.factor(Water_all), data=subset(All_Data, All_Data$Site!=1), family="binomial") 
#summary(model1_adj4) #int significant between age and perchlorate, but again, testing out of curiosity instead of from literature, so won't include.

#model1_adj5 <- glm(any_thyroid_problem_dummy ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + as.factor(Smoking_Status) + as.factor(Water_all) + as.factor(Income), data=All_Data, family="binomial")
#summary(model1_adj5) #Income sig. Need better groups. 

model1_adj5 <- glm(any_thyroid_problem_dummy ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + as.factor(Water_all), data=All_Data, family="binomial")
summary(model1_adj5) #Very close to sig (p=0.06), but since it does not meet the threshold, I will hold and not include.

model1_adj6 <- glm(any_thyroid_problem_dummy ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + as.factor(Water_all) + bmi, data=All_Data, family="binomial")
summary(model1_adj6) #bmi not sig.

model1_adj7 <- glm(any_thyroid_problem_dummy ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + as.factor(Water_all) + as.factor(Below_Pov) + bmi, data=All_Data, family="binomial")
summary(model1_adj7) #Adding Income and bmi were not sig... Won't add them to save some powah. I also didn't include them a priori, so I probably shouldn't force the model to be something it isn't. "I'm not a normal mom, I'm a cool mom."

#What if I do division creatinine correction instead of adding as covariate?
model1_adj <- glm(any_thyroid_problem_dummy ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + as.factor(Smoking_Status) + as.factor(Water_all), data=All_Data, family="binomial")
summary(model1_adj)

model1_adj8 <- glm(any_thyroid_problem_dummy ~ log(Result_P_ng_mL/Result_C_ng_mL) + Gender + age + Ethnicity + as.factor(Site) + as.factor(Smoking_Status) + as.factor(Water_all), data=All_Data, family="binomial")
summary(model1_adj8)

#Not good. The CDC in their models just kept creatinine as a covariate, and so that's also what I will do, too. That's also what Ben Blount recommended when we last spoke.

#Quick checks
#model1_adj <- glm(SR_EMR_Hypothyroid ~ log(Result_P_ng_mL)*Water_all +log(Result_C_mg_dL) + Gender + Ethnicity + Site + Smoking_Status + age, data=(subset(All_Data, All_Data$Site!=1))) #No interaction with perchlorate and water.

#model1_adj <- glm(SR_EMR_Hypothyroid ~ log10(Result_P_ng_mL) + age +log10(Result_C_mg_dL) + Gender + Ethnicity + Site + Smoking_Status + Water_all, data=All_Data) #Interaction between perchlorate and age. #Categorize age to see which age group is driving.

#Because of the very low number of smokers, I am grouping people into ever vs never.

#Checking referent categories
levels(as.factor(All_Data$Site))
All_Data$Site <- C(All_Data$Site, contr.treatment, base=2)
levels(as.factor(All_Data$Water_all))
levels(as.factor(All_Data$Ethnicity))

##Self-Report Thyroid Problem Model
model1_unadj <- glm(any_thyroid_problem_dummy ~ log10(Result_P_ng_mL) + Gender + age + Ethnicity, data=All_Data, family="binomial")
summary(model1_unadj)
exp(0.846491)
exp(confint(model1_unadj))

model1_adj_C <- glm(any_thyroid_problem_dummy ~ log10(Result_P_ng_mL) + log(Result_C_mg_dL), data=All_Data, family="binomial")
summary(model1_adj_C)
exp(confint(model1_adj_C))

model1_adj <- glm(any_thyroid_problem_dummy ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + as.factor(Water_all_revised), data=All_Data, family="binomial")
summary(model1_adj)
exp(confint(model1_adj))


#Without CSF
model1_unadj_NoCSF <- glm(any_thyroid_problem_dummy ~ log10(Result_P_ng_mL) + Gender + age + Ethnicity, data=subset(All_Data, All_Data$Site!=1), family="binomial")
summary(model1_unadj_NoCSF)
exp(1.01968) #p = 0.01
exp(confint(model1_unadj_NoCSF)) #(1.24, 6.38)

model1_adj_NoCSF <- glm(any_thyroid_problem_dummy ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + as.factor(Water_all_revised), data=subset(All_Data, All_Data$Site!=1), family="binomial")
summary(model1_adj_NoCSF)
exp(confint(model1_adj_NoCSF))


avPlots(model1_adj) #This isn't super helpful for non-continuous variables

#Variance Inflation Factors
vif(model1_adj)
vif_values1 <- as.data.frame(vif(model1_adj))
names <- rownames(vif_values1)
vif_values1$variable <- names
ggplot(data = vif_values1, aes(x=variable, y=GVIF))+
  geom_col()+
  theme(axis.text.x = element_text(angle = 90))+
  theme(text = element_text(size = 20))

#Nothing looks like it needs to come out of the model based on the VIF

##EMR Thyroid Problem Model
model2_unadj <- glm(emr_thyroid_problem_fromothercolumns ~ log10(Result_P_ng_mL) + Gender + age + Ethnicity, data=All_Data, family="binomial")
summary(model2_unadj)
exp(0.649284)
exp(confint(model2_unadj))

model2_adj_C <- glm(emr_thyroid_problem_fromothercolumns ~ log10(Result_P_ng_mL) + log(Result_C_mg_dL), data=All_Data, family="binomial")
summary(model2_adj_C)
exp(confint(model2_adj_C))

model2_adj <- glm(emr_thyroid_problem_fromothercolumns ~ log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + as.factor(Water_all_revised), data=All_Data, family="binomial")
summary(model2_adj)
exp(confint(model2_adj))

#Don't need to remove CSF because CSF does not have EMRs.

#SR or EMR Any Thyroid Problem Model
model3_unadj <- glm(any_thyroid_Dummy_EMR_or_SR ~ log10(Result_P_ng_mL) + Gender + age + Ethnicity, data=All_Data, family="binomial")
summary(model3_unadj)
exp(0.699923)
exp(confint(model3_unadj))

model3_adj_C <- glm(any_thyroid_Dummy_EMR_or_SR ~ log10(Result_P_ng_mL) + log(Result_C_mg_dL), data=All_Data, family="binomial")
summary(model3_adj_C)
exp(confint(model3_adj_C))

model3_adj <- glm(any_thyroid_Dummy_EMR_or_SR ~ log10(Result_P_ng_mL) +log10(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + as.factor(Water_all_revised), data=All_Data, family="binomial")
summary(model3_adj)
exp(confint(model3_adj))

#Without CSF
model3_unadj_NoCSF <- glm(any_thyroid_Dummy_EMR_or_SR ~ log10(Result_P_ng_mL) + Gender + age + Ethnicity, data=subset(All_Data, All_Data$Site!=1), family="binomial")
summary(model3_unadj_NoCSF)
exp(0.84768)
exp(confint(model3_unadj_NoCSF))

model3_adj_NoCSF <- glm(any_thyroid_Dummy_EMR_or_SR ~ log10(Result_P_ng_mL) +log10(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + as.factor(Water_all_revised), data=subset(All_Data, All_Data$Site!=1), family="binomial")
summary(model3_adj_NoCSF)
exp(confint(model3_adj_NoCSF))

sum(All_Data$Site!=1 & All_Data$any_thyroid_Dummy_EMR_or_SR==1, na.rm = T)
sum(All_Data$Site!=1 & All_Data$any_thyroid_Dummy_EMR_or_SR==0, na.rm = T)

sum(All_Data$Site!=1 & All_Data$any_thyroid_problem_dummy==1, na.rm = T)
sum(All_Data$Site!=1 & All_Data$any_thyroid_problem_dummy==0, na.rm = T)

##General Thyroid Problem Models

####Not going to do this. Doesn't make a huge amount of biological sense to group these necessarily. Just hypothyroid is better. Commenting out.

#model3_unadj <- glm(SR_hypo_goit_canc ~ log(Result_P_ng_mL), data=All_Data)
#summary(model3_unadj)
#exp(confint(model3_unadj))

test_model <- glm(any_thyroid_Dummy_EMR_or_SR ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + as.factor(Ever_Smoker) + as.factor(Water_all), data=subset(All_Data, All_Data$Site!=1), family="binomial")
summary(test_model)

#Neither gender/age nor smoking/perchlorate seem to have a significant interaction. Will remove smoking/perchlorate to see if that changes things for gender/age.

#model3_adj <- glm(any_thyroid_Dummy_EMR_or_SR ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Gender*age + Ethnicity + Site + Smoking_Status + Water_all, data=All_Data)
#summary(model3_adj)
#exp(confint(model3_adj))
#Smoking status and gender*age are nearly significant. As such, will keep in model.

##EMR Thyroid Problems Model
#model4_unadj <- glm(any_thyroid_Dummy_EMR_or_SR ~ log(Result_P_ng_mL), data=All_Data)
#summary(model4_unadj)
#exp(confint(model4_unadj))

#model4_adj_withint <- glm(any_thyroid_Dummy_EMR_or_SR ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Gender*age + Ethnicity + Site + Smoking_Status + Smoking_Status*log(Result_P_ng_mL) + Water_all, data=All_Data)
#summary(model4_adj_withint)
#Neither gender/age nor smoking/perchlorate seem to have a significant interaction. Will remove smoking/perchlorate to see if that changes things for gender/age.

#model4_adj_withint <- glm(any_thyroid_Dummy_EMR_or_SR ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Gender*age + Ethnicity + Site + Smoking_Status + Water_all, data=All_Data)
#summary(model4_adj_withint)
#Gender/age still not significant for interaction. Will remove from this model.

#model4_adj <- glm(any_thyroid_Dummy_EMR_or_SR ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Ethnicity + Site + Smoking_Status + Water_all, data=All_Data)
#summary(model4_adj)
#exp(confint(model4_adj))


#141 cases, 106 controls, 247 total. 


#Well water really seems to be having a hard time in these models. This might be because there is a very small number of well users (< 1%). I am going to try grouping well users into the 'other' category to see if this can alleviate some of those wild confidence intervals.
```

```{r new_sens_spec}
#New Sensitivity/Specificity with TSH as standard: 
All_Data$Normal_TSH_Range <- ifelse(is.na(All_Data$TSH), NA, 
                                    ifelse(All_Data$TSH>=0.4&All_Data$TSH<=4, 1, 0))
All_Data_No_Thy_Meds <- subset(All_Data, All_Data$thyroid_med==0) #n=203

#EMR Hypothyroid
All_Data_No_Thy_Meds %>% 
  filter_at(vars(TSH, emr_hypothyroidism), all_vars(!is.na(.))) %>% 
  summarise("TSH_Pos_EMR_Pos"=sum((TSH>4|TSH<0.4)&emr_hypothyroidism==1),
            "TSH_Neg_EMR_Neg"=sum(TSH<=4&TSH>=0.4&emr_hypothyroidism==0),
            "TSH_Pos_EMR_Neg"=sum((TSH>4|TSH<0.4)&emr_hypothyroidism==0),
            "TSH_Neg_EMR_Pos"=sum(TSH<=4&TSH>=0.4&emr_hypothyroidism==1),
            "Total"=sum(!is.na(TSH)&!is.na(emr_hypothyroidism)))

#SR Hypothyroid
All_Data_No_Thy_Meds %>% 
  filter_at(vars(TSH, Hypo_D), all_vars(!is.na(.))) %>% 
  summarise("TSH_Pos_SR_Pos"=sum((TSH>4|TSH<0.4)&Hypo_D==1),
            "TSH_Neg_SR_Neg"=sum(TSH<=4&TSH>=0.4&Hypo_D==0),
            "TSH_Pos_SR_Neg"=sum((TSH>4|TSH<0.4)&Hypo_D==0),
            "TSH_Neg_SR_Pos"=sum(TSH<=4&TSH>=0.4&Hypo_D==1),
            "Total"=sum(!is.na(TSH)&!is.na(Hypo_D)))

#EMR Hyperthyroid
All_Data_No_Thy_Meds %>% 
  filter_at(vars(TSH, emr_hyperthyroidism), all_vars(!is.na(.))) %>% 
  summarise("TSH_Pos_EMR_Pos"=sum((TSH>4|TSH<0.4)&emr_hyperthyroidism==1),
            "TSH_Neg_EMR_Neg"=sum(TSH<=4&TSH>=0.4&emr_hyperthyroidism==0),
            "TSH_Pos_EMR_Neg"=sum((TSH>4|TSH<0.4)&emr_hyperthyroidism==0),
            "TSH_Neg_EMR_Pos"=sum(TSH<=4&TSH>=0.4&emr_hyperthyroidism==1),
            "Total"=sum(!is.na(TSH)&!is.na(emr_hyperthyroidism)))

#SR Hyperthyroid
All_Data_No_Thy_Meds %>% 
  filter_at(vars(TSH, Hyper_D), all_vars(!is.na(.))) %>% 
  summarise("TSH_Pos_SR_Pos"=sum((TSH>4|TSH<0.4)&Hyper_D==1),
            "TSH_Neg_SR_Neg"=sum(TSH<=4&TSH>=0.4&Hyper_D==0),
            "TSH_Pos_SR_Neg"=sum((TSH>4|TSH<0.4)&Hyper_D==0),
            "TSH_Neg_SR_Pos"=sum(TSH<=4&TSH>=0.4&Hyper_D==1),
            "Total"=sum(!is.na(TSH)&!is.na(Hyper_D)))

#EMR Thyroid Cancer
All_Data_No_Thy_Meds %>% 
  filter_at(vars(TSH, emr_thyroid_cancer), all_vars(!is.na(.))) %>% 
  summarise("TSH_Pos_EMR_Pos"=sum((TSH>4|TSH<0.4)&emr_thyroid_cancer==1),
            "TSH_Neg_EMR_Neg"=sum(TSH<=4&TSH>=0.4&emr_thyroid_cancer==0),
            "TSH_Pos_EMR_Neg"=sum((TSH>4|TSH<0.4)&emr_thyroid_cancer==0),
            "TSH_Neg_EMR_Pos"=sum(TSH<=4&TSH>=0.4&emr_thyroid_cancer==1),
            "Total"=sum(!is.na(TSH)&!is.na(emr_thyroid_cancer)))

#SR Thyroid Cancer
All_Data_No_Thy_Meds %>% 
  filter_at(vars(TSH, Thyroid_cancer_D), all_vars(!is.na(.))) %>% 
  summarise("TSH_Pos_SR_Pos"=sum((TSH>4|TSH<0.4)&Thyroid_cancer_D==1),
            "TSH_Neg_SR_Neg"=sum(TSH<=4&TSH>=0.4&Thyroid_cancer_D==0),
            "TSH_Pos_SR_Neg"=sum((TSH>4|TSH<0.4)&Thyroid_cancer_D==0),
            "TSH_Neg_SR_Pos"=sum(TSH<=4&TSH>=0.4&Thyroid_cancer_D==1),
            "Total"=sum(!is.na(TSH)&!is.na(Thyroid_cancer_D)))

#EMR Goiter
All_Data_No_Thy_Meds %>% 
  filter_at(vars(TSH, emr_goiter), all_vars(!is.na(.))) %>% 
  summarise("TSH_Pos_EMR_Pos"=sum((TSH>4|TSH<0.4)&emr_goiter==1),
            "TSH_Neg_EMR_Neg"=sum(TSH<=4&TSH>=0.4&emr_goiter==0),
            "TSH_Pos_EMR_Neg"=sum((TSH>4|TSH<0.4)&emr_goiter==0),
            "TSH_Neg_EMR_Pos"=sum(TSH<=4&TSH>=0.4&emr_goiter==1),
            "Total"=sum(!is.na(TSH)&!is.na(emr_goiter)))

#SR Goiter
All_Data_No_Thy_Meds %>% 
  filter_at(vars(TSH, Goiter_D), all_vars(!is.na(.))) %>% 
  summarise("TSH_Pos_SR_Pos"=sum((TSH>4|TSH<0.4)&Goiter_D==1),
            "TSH_Neg_SR_Neg"=sum(TSH<=4&TSH>=0.4&Goiter_D==0),
            "TSH_Pos_SR_Neg"=sum((TSH>4|TSH<0.4)&Goiter_D==0),
            "TSH_Neg_SR_Pos"=sum(TSH<=4&TSH>=0.4&Goiter_D==1),
            "Total"=sum(!is.na(TSH)&!is.na(Goiter_D)))

#EMR Any Thyroid Problem
All_Data_No_Thy_Meds %>% 
  filter_at(vars(TSH, EMR_any_thyroid_Dummy), all_vars(!is.na(.))) %>% 
  summarise("TSH_Pos_EMR_Pos"=sum((TSH>4|TSH<0.4)&EMR_any_thyroid_Dummy==1),
            "TSH_Neg_EMR_Neg"=sum(TSH<=4&TSH>=0.4&EMR_any_thyroid_Dummy==0),
            "TSH_Pos_EMR_Neg"=sum((TSH>4|TSH<0.4)&EMR_any_thyroid_Dummy==0),
            "TSH_Neg_EMR_Pos"=sum(TSH<=4&TSH>=0.4&EMR_any_thyroid_Dummy==1),
            "Total"=sum(!is.na(TSH)&!is.na(EMR_any_thyroid_Dummy)))

#SR Any Thyroid Problem
All_Data_No_Thy_Meds %>% 
  filter_at(vars(TSH, any_thyroid_problem_dummy), all_vars(!is.na(.))) %>% 
  summarise("TSH_Pos_SR_Pos"=sum((TSH>4|TSH<0.4)&any_thyroid_problem_dummy==1),
            "TSH_Neg_SR_Neg"=sum(TSH<=4&TSH>=0.4&any_thyroid_problem_dummy==0),
            "TSH_Pos_SR_Neg"=sum((TSH>4|TSH<0.4)&any_thyroid_problem_dummy==0),
            "TSH_Neg_SR_Pos"=sum(TSH<=4&TSH>=0.4&any_thyroid_problem_dummy==1),
            "Total"=sum(!is.na(TSH)&!is.na(any_thyroid_problem_dummy)))

#Weight Outcomes Stratified by Cases/Controls
df_perch_horm <- All_Data[ , c("Result_C_mg_dL","Result_C_ng_mL","Result_P_ng_mL","fT3","TSH","fT4","TotalT4","TotalT3","Cortisol","Weight","Overweight","emr_weight","emr_bmi","emr_obesity","bmi", "any_thyroid_Dummy_EMR_or_SR")]

df_perch_horm <- as.data.frame(df_perch_horm)

df_perch_horm$log_Result_C_mg_dL <- log10(df_perch_horm$Result_C_mg_dL)
df_perch_horm$log_Result_P_ng_mL <- log10(df_perch_horm$Result_P_ng_mL)
df_perch_horm$Creat_corrected_Perch <- log10(df_perch_horm$Result_P_ng_mL/df_perch_horm$Result_C_ng_mL)
df_perch_horm$log_TSH <- log10(df_perch_horm$TSH)
df_perch_horm$log_fT3 <- log10(df_perch_horm$fT3)
df_perch_horm$log_fT4 <- log10(df_perch_horm$fT4)
df_perch_horm$log_TotalT3 <- log10(df_perch_horm$TotalT3)
df_perch_horm$log_TotalT4 <- log10(df_perch_horm$TotalT4)
df_perch_horm$log_Cortisol <- log10(df_perch_horm$Cortisol)
df_perch_horm$log_bmi <- log10(df_perch_horm$bmi)
df_perch_horm$log_emr_bmi <- log10(df_perch_horm$emr_bmi)

df_perch_horm_Cases <- subset(df_perch_horm, df_perch_horm$any_thyroid_Dummy_EMR_or_SR==1)
df_perch_horm_Controls <- subset(df_perch_horm, df_perch_horm$any_thyroid_Dummy_EMR_or_SR==0)

sum(complete.cases(df_perch_horm_Cases)) #108
sum(complete.cases(df_perch_horm_Controls)) #50

cor_perch_horm_Cases <- cor(df_perch_horm_Cases, use="pairwise.complete.obs")
p_values_horm_Cases <- corr.test(cor_perch_horm_Cases, use="pairwise")

cor_perch_horm_Controls <- cor(df_perch_horm_Controls, use="pairwise.complete.obs")
p_values_horm_Controls <- corr.test(cor_perch_horm_Controls, use="pairwise")

setwd("~/Desktop/Yuma Project/Yuma - R Project/")
write.csv(cor_perch_horm_Cases, file="Correlation_Weight_Cases.csv", quote=F, row.names=T)
write.csv(cor_perch_horm_Controls, file="Correlation_Weight_Controls.csv", quote=F, row.names=T)


#Reproductive Disorders
#By cases and controls
All_Data_Any_Case <- subset(All_Data, All_Data$any_thyroid_Dummy_EMR_or_SR==1)
All_Data_Any_Control <- subset(All_Data, All_Data$any_thyroid_Dummy_EMR_or_SR==0)

length(All_Data_Any_Case$ID) #157
length(All_Data_Any_Control$ID)#161

#Cases
PCOS_SR_Perch_Cases <- ggplot(data = subset(All_Data_Any_Case, !is.na(All_Data_Any_Case$pos)), aes(x = ID, y = Result_P_ng_mL/Result_C_ng_mL)) +
  geom_jitter(aes(color = as.factor(pos), shape = as.factor(pos), size = ifelse(pos %in% c(1),  3,  2))) +
    geom_hline(aes(yintercept =  0.00000256)) +
    scale_y_continuous(trans='log10',  
                       breaks = trans_breaks("log10", function(x)  10^x, n =  7),  
                       labels = trans_format("log10", math_format(10^.x))) +
    scale_color_discrete("Self-Report\nPCOS",  
                         labels = c("2" = "No", "1" = "Yes", "3" = "Don't Know", "NA" = "NA")) +
    scale_shape_discrete("Self-Report\nPCOS",  
                         labels = c("2" = "No", "1" = "Yes", "3" = "Don't Know", "NA" = "NA")) +
    scale_size_continuous(guide = "none") +
    theme(axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          panel.background = element_rect(fill = '#ffffff', color = 'black'),
          text = element_text(size =  20),
          legend.position = "bottom") +
    xlab("") +
    ylab("Log10 [Perchlorate]/[Creatinine]") +
    guides(shape = guide_legend(direction = "vertical", title.position = "top"),
           color = guide_legend(direction = "vertical", title.position = "top"))

PCOS_EMR_Perch_Cases <- ggplot(data = subset(All_Data_Any_Case, !is.na(All_Data_Any_Case$emr_pos)), aes(x = ID, y = Result_P_ng_mL/Result_C_ng_mL)) +
  geom_jitter(aes(color = as.factor(emr_pos), shape = as.factor(emr_pos), size = ifelse(emr_pos %in% c(1), 3, 2))) +
  geom_hline(aes(yintercept = 0.00000256)) +
  scale_y_continuous(trans='log10',  
                       breaks = trans_breaks("log10", function(x)  10^x, n =  7),  
                       labels = trans_format("log10", math_format(10^.x))) +
  scale_color_discrete("EMR Diagnosed\nPCOS", 
                       labels = c("Yes", "No", "Don't Know"), 
                       breaks = c(1, 0, 3),
                       limits = c(1, 0, 3)) +
  scale_shape_discrete("EMR Diagnosed\nPCOS", 
                       labels = c("Yes", "No", "Don't Know"), 
                       breaks = c(1, 0, 3),
                       limits = c(1, 0, 3)) +
  scale_size_continuous(guide = "none")+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size = 20),
        legend.position = "bottom") +
  xlab("") +
  ylab("") +
  guides(shape = guide_legend(direction = "vertical",
                              title.position = "top"),
         color = guide_legend(direction = "vertical",
                              title.position = "top"))

UT_SR_Perch_Cases <- ggplot(data=subset(All_Data_Any_Case, All_Data_Any_Case$undescended!=4), aes(x=ID, y=Result_P_ng_mL/Result_C_ng_mL))+
  geom_jitter(aes(color=as.factor(undescended), shape=as.factor(undescended), size = ifelse(undescended %in% c(1), 3, 2)))+
  geom_hline(aes(yintercept=0.00000256))+
  scale_y_continuous(trans='log10',  
                       breaks = trans_breaks("log10", function(x)  10^x, n =  7),  
                       labels = trans_format("log10", math_format(10^.x))) +
  scale_color_discrete("Self-Report\nUndescended Testes", labels=c("2"="No", "1"="Yes", "3"="Don't Know", "NA"="NA"))+
  scale_shape_discrete("Self-Report\nUndescended Testes", labels=c("2"="No", "1"="Yes", "3"="Don't Know", "NA"="NA"))+
  scale_size_continuous(guide = "none")+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size=20),
        legend.position = "bottom")+
  xlab("")+
  ylab("")+
  guides(shape = guide_legend(direction = "vertical",
                              title.position = "top"),
         color = guide_legend(direction = "vertical",
                              title.position = "top"))

AG_SR_Perch_Cases <- ggplot(data=subset(All_Data_Any_Case, All_Data_Any_Case$ambiguous!=4), aes(x=ID, y=Result_P_ng_mL/Result_C_ng_mL))+
  geom_jitter(aes(color=as.factor(ambiguous), shape=as.factor(ambiguous), size = ifelse(ambiguous %in% c(1), 3, 2)))+
  geom_hline(aes(yintercept=0.00000256))+
  scale_y_continuous(trans='log10',  
                       breaks = trans_breaks("log10", function(x)  10^x, n =  7),  
                       labels = trans_format("log10", math_format(10^.x))) +
  scale_color_discrete("Self-Report\nAmbiguous Genitalia", labels=c("2"="No", "1"="Yes", "3"="Don't Know", "NA"="NA"))+
  scale_shape_discrete("Self-Report\nAmbiguous Genitalia", labels=c("2"="No", "1"="Yes", "3"="Don't Know", "NA"="NA"))+
  scale_size_continuous(guide = "none")+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size=20),
        legend.position = "bottom")+
  xlab("")+
  ylab("")+
  guides(shape = guide_legend(direction = "vertical",
                              title.position = "top"),
         color = guide_legend(direction = "vertical",
                              title.position = "top"))

tiff("Perchlorate_RepDis_Cases_Graph.tiff", units="in", width=14, height=7, res=300) #Only to save in high def.
ggarrange(PCOS_SR_Perch_Cases, PCOS_EMR_Perch_Cases, UT_SR_Perch_Cases, AG_SR_Perch_Cases, nrow = 1)
dev.off()



#Controls
layer_scales(AG_SR_Perch_Cases)$y$range$range

PCOS_SR_Perch_Controls <- ggplot(data = subset(All_Data_Any_Control, !is.na(All_Data_Any_Control$pos)), aes(x = ID, y = Result_P_ng_mL/Result_C_ng_mL)) +
    geom_jitter(aes(color = as.factor(pos), shape = as.factor(pos), size = ifelse(pos %in% c(1),  3,  2))) +
    geom_hline(aes(yintercept =  0.00000256)) +
  scale_y_continuous(trans='log10',  
                       breaks = trans_breaks("log10", function(x)  10^x, n =  7),  
                       labels = trans_format("log10", math_format(10^.x)),
                     limits = c(-6.272997, -4.716241)) +
    scale_color_manual("Self-Report\nPCOS",  
                       labels = c("Yes", "No", "Don't Know"), 
                       breaks = c(1, 2, 3),
                       limits = c(1, 2, 3),
                       values = c("#F8766D", "#00B81F", "#00A5FF"))  +
    scale_shape_manual("Self-Report\nPCOS",
                       labels = c("Yes", "No", "Don't Know"), 
                       breaks = c(1, 2, 3),
                       limits = c(1, 2, 3),
                       values = c(19, 17, 15)) +
    scale_size_continuous(guide = "none") +
    theme(axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          panel.background = element_rect(fill = '#ffffff', color = 'black'),
          text = element_text(size =  20),
          legend.position = "bottom") +
    xlab("") +
    ylab("Log10 [Perchlorate]/[Creatinine]") +
    guides(shape = guide_legend(direction = "vertical", title.position = "top"),
           color = guide_legend(direction = "vertical", title.position = "top"))

PCOS_EMR_Perch_Controls <- ggplot(data = subset(All_Data_Any_Control, !is.na(All_Data_Any_Control$emr_pos)), aes(x = ID, y = Result_P_ng_mL/Result_C_ng_mL)) +
  geom_jitter(aes(color = as.factor(emr_pos), shape = as.factor(emr_pos), size = ifelse(emr_pos %in% c(1), 3, 2))) +
  geom_hline(aes(yintercept = 0.00000256)) +
  scale_y_continuous(trans='log10',  
                       breaks = trans_breaks("log10", function(x)  10^x, n =  7),  
                       labels = trans_format("log10", math_format(10^.x)),
                     limits = c(-6.272997, -4.716241)) +
  scale_color_manual("EMR Diagnosed\nPCOS", 
                       labels = c("Yes", "No", "Don't Know"), 
                       breaks = c(1, 0, 3),
                       limits = c(1, 0, 3),
                       values = c("#F8766D", "#00B81F", "#00A5FF"))  +
  scale_shape_manual("EMR Diagnosed\nPCOS", 
                       labels = c("Yes", "No", "Don't Know"), 
                       breaks = c(1, 0, 3),
                       limits = c(1, 0, 3),
                       values = c(19, 17, 15)) +
  scale_size_continuous(guide = "none")+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size = 20),
        legend.position = "bottom") +
  xlab("") +
  ylab("") +
  guides(shape = guide_legend(direction = "vertical",
                              title.position = "top"),
         color = guide_legend(direction = "vertical",
                              title.position = "top"))

UT_SR_Perch_Controls <- ggplot(data=subset(All_Data_Any_Control, All_Data_Any_Control$undescended!=4), aes(x=ID, y=Result_P_ng_mL/Result_C_ng_mL))+
  geom_jitter(aes(color=as.factor(undescended), shape=as.factor(undescended), size = ifelse(undescended %in% c(1), 3, 2)))+
  geom_hline(aes(yintercept=0.00000256))+
  scale_y_continuous(trans='log10',  
                       breaks = trans_breaks("log10", function(x)  10^x, n =  7),  
                       labels = trans_format("log10", math_format(10^.x)),
                     limits = c(-6.272997, -4.716241)) +
  scale_color_manual("Self-Report\nUndescended Testes",
                     labels = c("Yes", "No", "Don't Know"), 
                       breaks = c(1, 2, 3),
                       limits = c(1, 2, 3),
                       values = c("#F8766D", "#00B81F", "#00A5FF"))  +
  scale_shape_manual("Self-Report\nUndescended Testes", 
                       labels = c("Yes", "No", "Don't Know"), 
                       breaks = c(1, 2, 3),
                       limits = c(1, 2, 3),
                       values = c(19, 17, 15)) +
  scale_size_continuous(guide = "none")+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size=20),
        legend.position = "bottom")+
  xlab("")+
  ylab("")+
  guides(shape = guide_legend(direction = "vertical",
                              title.position = "top"),
         color = guide_legend(direction = "vertical",
                              title.position = "top"))

AG_SR_Perch_Controls <- ggplot(data = subset(All_Data_Any_Control, ambiguous != 4), 
       aes(x = ID, y = Result_P_ng_mL / Result_C_ng_mL)) +
  geom_jitter(aes(color = as.factor(ambiguous), 
                  shape = as.factor(ambiguous), 
                  size = ifelse(ambiguous == 1, 3, 1))) +
  geom_hline(aes(yintercept = 0.00000256)) +
  scale_y_continuous(trans='log10',  
                       breaks = trans_breaks("log10", function(x)  10^x, n =  7),  
                       labels = trans_format("log10", math_format(10^.x)),
                     limits = c(-6.272997, -4.716241)) +
  scale_color_manual("Self-Report\nAmbiguous Genitalia", 
                     labels = c("Yes", "No", "Don't Know"), 
                     breaks = c(1, 2, 3),
                     values = c("#F8766D", "#00B81F", "#00A5FF"),
                     drop = F) +
  scale_shape_manual("Self-Report\nAmbiguous Genitalia", 
                      labels = c("Yes", "No", "Don't Know"), 
                      breaks = c(1, 2, 3),
                      values = c(19, 17, 15),
                     drop = F) +
  scale_size_identity() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size = 20),
        legend.position = "bottom") +
  xlab("") +
  ylab("") +
  guides(shape = guide_legend(direction = "vertical", title.position = "top"),
         color = guide_legend(direction = "vertical", title.position = "top"))


tiff("Perchlorate_RepDis_Controls_Graph.tiff", units="in", width=14, height=7, res=300) #Only to save in high def.
ggarrange(PCOS_SR_Perch_Controls, PCOS_EMR_Perch_Controls, UT_SR_Perch_Controls, AG_SR_Perch_Controls, nrow = 1)
dev.off()

```

###Extra
```{r quick_hormone_graphs}
#For Frank and Loren's grant proposal
All_Data$filler <- '1'
ggplot(data=subset(All_Data, All_Data$EMR_any_thyroid_Dummy==0), aes(y=as.numeric(TotalT3), x=filler)) +
 geom_violin(color='#ffffff') +
 geom_sina() +
 theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size=15)) +
 xlab("") +
 ylab("Total T3 (ng/mL)")+
  geom_hline(aes(yintercept=2), color="firebrick", size=1.1)+
  geom_hline(aes(yintercept=0.8), color="firebrick", size=1.1)

All_Data %>% 
  filter(EMR_any_thyroid_Dummy==0) %>% 
  summarise(n = sum(EMR_any_thyroid_Dummy==0),
            Below_TT3 = sum(TotalT3<0.8, na.rm = T))

ggplot(data=subset(All_Data, All_Data$EMR_any_thyroid_Dummy==1), aes(y=as.numeric(TotalT3), x=filler)) +
 geom_violin(color='#ffffff') +
 geom_sina() +
 theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size=15)) +
 xlab("") +
 ylab("Total T3 (ng/mL)")+
  geom_hline(aes(yintercept=2), color="firebrick", size=1.1)+
  geom_hline(aes(yintercept=0.8), color="firebrick", size=1.1)

All_Data %>% 
  filter(EMR_any_thyroid_Dummy==1) %>% 
  summarise(n = sum(EMR_any_thyroid_Dummy==1),
            Below_TT3 = sum(TotalT3<0.8, na.rm = T))

#Cortisol (ng/mL)
#cortisol is time-dependent

#Total T3 (ng/mL)
#total T3 is 80180 ng/dL = 0.8-1.8 ng/mL
ggplot(data=subset(All_Data, !is.na(All_Data$EMR_any_thyroid_Dummy)), aes(y=as.numeric(TotalT3), x=as.factor(EMR_any_thyroid_Dummy))) +
 geom_violin(color='#ffffff') +
 geom_sina() +
  scale_x_discrete(labels=c("1"="EMR +", "0"="EMR -"))+
 theme(axis.ticks.x = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size=15)) +
 xlab("") +
 ylab("Total T3 (ng/mL)")+
  geom_hline(aes(yintercept=1.8), color="firebrick", size=1.1)+
  geom_hline(aes(yintercept=0.8), color="firebrick", size=1.1)

#Free T3 (pg/mL)
#free T3 is 2.0-4.4 pg/mL
ggplot(data=subset(All_Data, !is.na(All_Data$EMR_any_thyroid_Dummy)), aes(y=as.numeric(fT3), x=as.factor(EMR_any_thyroid_Dummy))) +
 geom_violin(color='#ffffff') +
 geom_sina() +
  scale_x_discrete(labels=c("1"="EMR +", "0"="EMR -"))+
 theme(axis.ticks.x = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size=15)) +
 xlab("") +
 ylab("Free T3 (pg/mL)")+
  geom_hline(aes(yintercept=4.4), color="firebrick", size=1.1)+
  geom_hline(aes(yintercept=2.0), color="firebrick", size=1.1)

#TSH (IU/mL)
#TSH is 0.4-4.0 uIU/mL
ggplot(data=subset(All_Data, !is.na(All_Data$EMR_any_thyroid_Dummy)), aes(y=as.numeric(TSH), x=as.factor(EMR_any_thyroid_Dummy))) +
 geom_violin(color='#ffffff') +
 geom_sina() +
  scale_x_discrete(labels=c("1"="EMR +", "0"="EMR -"))+
 theme(axis.ticks.x = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size=15)) +
 xlab("") +
 ylab("TSH (IU/mL)")+
  geom_hline(aes(yintercept=4.0), color="firebrick", size=1.1)+
  geom_hline(aes(yintercept=0.4), color="firebrick", size=1.1)

#Free T4 (pg/mL)
#free T4 is 0.81.8 ng/dL = 8-18 pg/mL
ggplot(data=subset(All_Data, !is.na(All_Data$EMR_any_thyroid_Dummy)), aes(y=as.numeric(fT4), x=as.factor(EMR_any_thyroid_Dummy))) +
 geom_violin(color='#ffffff') +
 geom_sina() +
  scale_x_discrete(labels=c("1"="EMR +", "0"="EMR -"))+
 theme(axis.ticks.x = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size=15)) +
 xlab("") +
 ylab("Free T4 (pg/mL)")+
  geom_hline(aes(yintercept=18), color="firebrick", size=1.1)+
  geom_hline(aes(yintercept=8), color="firebrick", size=1.1)

#Total T4 (ng/mL)
#total T4 is 512 g/dL = 50-120 ng/mL
ggplot(data=subset(All_Data, !is.na(All_Data$EMR_any_thyroid_Dummy)), aes(y=as.numeric(TotalT4), x=as.factor(EMR_any_thyroid_Dummy))) +
 geom_violin(color='#ffffff') +
 geom_sina() +
  scale_x_discrete(labels=c("1"="EMR +", "0"="EMR -"))+
 theme(axis.ticks.x = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size=15)) +
 xlab("") +
 ylab("Total T4 (ng/mL)")+
  geom_hline(aes(yintercept=120), color="firebrick", size=1.1)+
  geom_hline(aes(yintercept=50), color="firebrick", size=1.1)

#Log TSH
#TSH is 0.4-4.0 uIU/mL
ggplot(data=subset(All_Data, !is.na(All_Data$EMR_any_thyroid_Dummy)), aes(y=log10(as.numeric(TSH)), x=as.factor(EMR_any_thyroid_Dummy))) +
 geom_violin(color='#ffffff') +
 geom_sina() +
  scale_x_discrete(labels=c("1"="EMR +", "0"="EMR -"))+
 theme(axis.ticks.x = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size=15)) +
 xlab("") +
 ylab("Log-TSH")+
  geom_hline(aes(yintercept=log10(4.0)), color="firebrick", size=1.1)+
  geom_hline(aes(yintercept=log10(0.4)), color="firebrick", size=1.1)

#Log TSH
#TSH is 0.4-4.0 uIU/mL
ggplot(data=subset(All_Data, !is.na(All_Data$any_thyroid_problem_dummy)), aes(y=log10(as.numeric(TSH)), x=as.factor(any_thyroid_problem_dummy))) +
 geom_violin(color='#ffffff') +
 geom_sina() +
  scale_x_discrete(labels=c("1"="SR +", "0"="SR -"))+
 theme(axis.ticks.x = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size=15)) +
 xlab("") +
 ylab("Log-TSH")+
  geom_hline(aes(yintercept=log10(4.0)), color="firebrick", size=1.1)+
  geom_hline(aes(yintercept=log10(0.4)), color="firebrick", size=1.1)

#Free T4 (pg/mL)
#free T4 is 0.81.8 ng/dL = 8-18 pg/mL
ggplot(data=subset(All_Data, !is.na(All_Data$any_thyroid_problem_dummy)), aes(y=as.numeric(fT4), x=as.factor(any_thyroid_problem_dummy))) +
 geom_violin(color='#ffffff') +
 geom_sina() +
  scale_x_discrete(labels=c("1"="SR +", "0"="SR -"))+
 theme(axis.ticks.x = element_blank(),
        panel.background = element_rect(fill = '#ffffff', color = 'black'),
        text = element_text(size=15)) +
 xlab("") +
 ylab("Free T4 (pg/mL)")+
  geom_hline(aes(yintercept=18), color="firebrick", size=1.1)+
  geom_hline(aes(yintercept=8), color="firebrick", size=1.1)
```


```{r expl_analyses}
#Only using controls from filtered_controls

#Reproductive Disorders
#Self-Report PCOS
#1= Yes, 2= No, 3= Dont know

filtered_controls <- All_Data[All_Data$any_thyroid_Dummy_EMR_or_SR == 0, ] 
filtered_controls <- filtered_controls[!is.na(filtered_controls$any_thyroid_Dummy_EMR_or_SR),] #n = 161

tiff("Perchlorate_PCOS_Controls_Graph.tiff", units="in", width=12, height=8, res=300) #Only to save in high def.
ggplot(data=subset(filtered_controls, !is.na(filtered_controls$pos)), aes(y=Result_P_ug_mL/Result_C_g_mL))+
  geom_boxplot(aes(x=as.factor(pos)))+
  geom_sina(aes(x=as.factor(pos)), alpha=0.3)+
  scale_y_continuous(trans='log10',  
                       breaks = trans_breaks("log10", function(x)  10^x, n =  5),  
                       labels = trans_format("log10", math_format(10^.x)))+
  scale_x_discrete(labels = c("1" = "PCOS\nSelf-Report\nPositive", "2" = "PCOS\nSelf-Report\nNegative"))+
  xlab("")+
  ylab("Log Perchlorate/Creatinine\n")+
  theme(panel.background = element_rect(fill = '#ffffff'),
        text = element_text(size = 20),
        axis.line = element_line(color="#000000"))
dev.off()

t.test(log10(filtered_controls$Result_P_ng_mL/filtered_controls$Result_C_ng_mL) ~ as.factor(filtered_controls$pos), conf.level = 0.95, var.equal=FALSE)


#Obesity Outcomes
#Self-report overweight

tiff("Perchlorate_SR_Overweight_Controls_Graph.tiff", units="in", width=12, height=8, res=300) #Only to save in high def.
ggplot(data=subset(filtered_controls, !is.na(filtered_controls$Overweight)), aes(y=Result_P_ng_mL/Result_C_ng_mL))+
  geom_boxplot(aes(x=as.factor(Overweight)))+
  geom_sina(aes(x=as.factor(Overweight)), alpha=0.3)+
  scale_y_continuous(trans='log10',  
                       breaks = trans_breaks("log10", function(x)  10^x, n =  5),  
                       labels = trans_format("log10", math_format(10^.x)))+
  scale_x_discrete(labels = c("1" = "Overweight\nSelf-Report\nPositive", "2" = "Overweight\nSelf-Report\nNegative"))+
  xlab("")+
  ylab("Log Perchlorate/Creatinine\n")+
  theme(panel.background = element_rect(fill = '#ffffff'),
        text = element_text(size = 20),
        axis.line = element_line(color="#000000"))
dev.off()

t.test(log10(filtered_controls$Result_P_ng_mL/filtered_controls$Result_C_ng_mL) ~ as.factor(filtered_controls$Overweight), conf.level = 0.95, var.equal=FALSE)

#Measured bmi

tiff("Perchlorate_BMI_Controls_Graph.tiff", units="in", width=12, height=8, res=300) #Only to save in high def.
ggplot(data=filtered_controls, aes(x=Result_P_ug_mL/Result_C_g_mL, y=bmi))+
  geom_point()+
  geom_smooth(method=lm, se=F)+
    #stat_regline_equation(label.y = 1.8)+
  stat_cor(label.y = 1.75)+
  xlab("\nLog Perchlorate/Creatinine")+
  ylab("Log BMI\n")+
  theme(panel.background = element_rect(fill = '#ffffff'),
        text = element_text(size = 20),
        axis.line = element_line(color="#000000"))+
  scale_x_continuous(trans='log10',  
                       breaks = trans_breaks("log10", function(x)  10^x, n =  5),  
                       labels = trans_format("log10", math_format(10^.x)))+
  scale_y_continuous(trans='log10',  
                       breaks = trans_breaks("log10", function(x)  10^x, n =  5),  
                       labels = trans_format("log10", math_format(10^.x)))
dev.off()

#EMR Obesity

tiff("Perchlorate_EMR_Obesity_Controls_Graph.tiff", units="in", width=12, height=8, res=300) #Only to save in high def.
ggplot(data=subset(filtered_controls,!is.na(filtered_controls$emr_obesity)), aes(y=Result_P_ng_mL/Result_C_ng_mL)) +
  geom_boxplot(aes(x=reorder(as.factor(emr_obesity), Result_P_ng_mL/Result_C_ng_mL))) + 
  geom_sina(aes(x=reorder(as.factor(emr_obesity), Result_P_ng_mL/Result_C_ng_mL)), alpha=0.3) + 
  scale_y_continuous(trans='log10',  
                       breaks = trans_breaks("log10", function(x)  10^x, n =  5),  
                       labels = trans_format("log10", math_format(10^.x))) +
  scale_x_discrete(labels = c("1" = "Obesity\nEMR\nPositive", "0" = "Obesity\nEMR\nNegative")) +
  xlab("") +
  ylab("Log Perchlorate/Creatinine\n") +
  theme(panel.background = element_rect(fill = '#ffffff'),
        text = element_text(size = 20),
        axis.line = element_line(color="#000000"))
dev.off()

t.test(log10(filtered_controls$Result_P_ng_mL/filtered_controls$Result_C_ng_mL) ~ as.factor(filtered_controls$emr_obesity), conf.level = 0.95, var.equal=FALSE)

#EMR BMI
ggplot(data=filtered_controls, aes(x=Result_P_ng_mL/Result_C_ng_mL, y=emr_bmi))+
  geom_point()+
  geom_smooth(method=lm, se=F)+
    #stat_regline_equation(label.y = 1.8)+
  stat_cor(label.y = 1.75)+
  xlab("\nLog Perchlorate/Creatinine")+
  ylab("Log BMI\n")+
  theme(panel.background = element_rect(fill = '#ffffff'),
        text = element_text(size = 20),
        axis.line = element_line(color="#000000"))+
  scale_x_continuous(trans='log10',  
                       breaks = trans_breaks("log10", function(x)  10^x, n =  5),  
                       labels = trans_format("log10", math_format(10^.x)))+
  scale_y_continuous(trans='log10',  
                       breaks = trans_breaks("log10", function(x)  10^x, n =  5),  
                       labels = trans_format("log10", math_format(10^.x)))
```

```{r EM_Models}

#After looking at my thyroid medications graph, I need to check for effect modification.

#Actually, I can't use anything below. There is severe overlap between the outcome and the use of thyroid meds (makes sense that cases will be taking medications, especially since the recruitment of most of the cases occurred at the hospital. But thyroid meds are affecting perchlorate exposures, so there should not be effect mod. However, if I was looking at thyroid hormone concentrations as the predictor instead, then I would definitely need to do this.)
model1_adj_thymed0 <- glm(any_thyroid_problem_dummy ~ log10(Result_P_ng_mL), data=All_Data, subset = (thyroid_med == "0"), family="binomial")
model1_adj_thymed1 <- glm(any_thyroid_problem_dummy ~ log10(Result_P_ng_mL), data=All_Data, subset = (thyroid_med == "1"), family="binomial")
summary(model1_adj_thymed0)
summary(model1_adj_thymed1)
#There is EM!

model2_adj_thymed0 <- glm(any_thyroid_Dummy_EMR_or_SR ~ log10(Result_P_ng_mL), data=All_Data, subset = (thyroid_med == "0"), family="binomial")
model2_adj_thymed1 <- glm(any_thyroid_Dummy_EMR_or_SR ~ log10(Result_P_ng_mL), data=All_Data, subset = (thyroid_med == "1"), family="binomial")
summary(model2_adj_thymed0)
summary(model2_adj_thymed1)
#again, yes, effect modification.

#How many people are taking thyroid meds
sum(All_Data$thyroid_med==1, na.rm = T) #127
sum(All_Data$thyroid_med==0, na.rm = T) #203
#Good enough number in each group.

##Self-Report Thyroid Problem Model
model1_unadj_yesmed <- glm(any_thyroid_problem_dummy ~ log10(Result_P_ng_mL), data=subset(All_Data, All_Data$thyroid_med==1), family="binomial")
summary(model1_unadj_yesmed)
exp(0.4577)
exp(confint(model1_unadj_yesmed))

model1_unadj_nomed <- glm(any_thyroid_problem_dummy ~ log10(Result_P_ng_mL), data=subset(All_Data, All_Data$thyroid_med==0), family="binomial")
summary(model1_unadj_nomed)
exp(1.2058)
exp(confint(model1_unadj_nomed))

model1_adj_yesmed <- glm(any_thyroid_problem_dummy ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + as.factor(Water_all_revised), data=subset(All_Data, All_Data$thyroid_med==1), family="binomial")
summary(model1_adj_yesmed)
exp(confint(model1_adj_yesmed))

model1_adj_nomed <- glm(any_thyroid_problem_dummy ~ log(Result_P_ng_mL) + log(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + as.factor(Water_all_revised), data=subset(All_Data, All_Data$thyroid_med==0), family="binomial")
summary(model1_adj_nomed)
exp(confint(model1_adj_nomed))




##EMR Thyroid Problem Model
model2_unadj_yesmed <- glm(emr_thyroid_problem_fromothercolumns ~ log10(Result_P_ng_mL), data=subset(All_Data, All_Data$thyroid_med==1), family="binomial")
summary(model2_unadj_yesmed)
exp(1.0140)
exp(confint(model2_unadj_yesmed))

model2_unadj_nomed <- glm(emr_thyroid_problem_fromothercolumns ~ log10(Result_P_ng_mL), data=subset(All_Data, All_Data$thyroid_med==0), family="binomial")
summary(model2_unadj_nomed)
exp(0.6200)
exp(confint(model2_unadj_nomed))

model2_adj_yesmed <- glm(emr_thyroid_problem_fromothercolumns ~ log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + as.factor(Water_all_revised), data=subset(All_Data, All_Data$thyroid_med==1), family="binomial")
summary(model2_adj_yesmed)
exp(confint(model2_adj_yesmed))

model2_adj_nomed <- glm(emr_thyroid_problem_fromothercolumns ~ log10(Result_P_ng_mL) + log10(Result_C_mg_dL) + Gender + age + Ethnicity + as.factor(Site) + as.factor(Water_all_revised), data=subset(All_Data, All_Data$thyroid_med==0), family="binomial")
summary(model2_adj_nomed)
exp(confint(model2_adj_nomed))

#Don't need to remove CSF because CSF does not have EMRs.

#SR or EMR Any Thyroid Problem Model
model3_unadj_nomed <- glm(any_thyroid_Dummy_EMR_or_SR ~ log10(Result_P_ng_mL), data=subset(All_Data, All_Data$thyroid_med==0), family="binomial") #This will not converge because all of our participants who are a case are taking thyroid meds and none of our controls are, so we can't split the groups this way.

All_Data %>% 
     filter_at(vars(thyroid_med, any_thyroid_Dummy_EMR_or_SR), all_vars(!is.na(.))) %>% 
     summarise("Med_Pos_Thy_Pos"=sum(thyroid_med==1&any_thyroid_Dummy_EMR_or_SR==1),
               "Med_Neg_Thy_Neg"=sum(TSH<=4&any_thyroid_Dummy_EMR_or_SR==0),
               "Med_Pos_Thy_Neg"=sum(thyroid_med==1&any_thyroid_Dummy_EMR_or_SR==0),
               "Med_Neg_Thy_Pos"=sum(TSH<=4&any_thyroid_Dummy_EMR_or_SR==1))
```

```{r farmers_perch}
ggplot(data=subset(All_Data, !is.na(All_Data$Farmer)), aes(x=as.factor(Farmer), y=as.numeric(Result_P_ng_mL)))+
  geom_boxplot()

All_Data %>% 
  group_by(Site) %>% 
  summarise(n=sum(Farmer==1, na.rm = T)/sum(!is.na(Site)))

All_Data %>% 
  group_by(Site) %>% 
  summarise(n=sum(Farmer==1, na.rm = T)/sum(!is.na(Site)))
```